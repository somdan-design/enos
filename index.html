<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>E.No.S v2.03 (Text Only)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            overscroll-behavior: none; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: manipulation; 
        }
        
        /* í…ìŠ¤íŠ¸ ì„ íƒ í—ˆìš© ì˜ì—­ */
        input, textarea, [contenteditable="true"], .selectable-text, 
        .msg-wrapper .novel-text, .rule-content, .world-chars, .gen-section, .selectable { 
            user-select: text !important; 
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            cursor: text;
        }

        /* í°íŠ¸ ì‚¬ì´ì¦ˆ ë³€ìˆ˜ */
        :root { --novel-font-size: 1.1rem; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ë³µêµ¬ */
        .novel-text ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5rem 0; }
        .novel-text ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
        .novel-text li { margin-bottom: 0.25rem; }
        .novel-text li p { margin: 0; display: inline-block; }

        button {
            user-select: none;
            -webkit-user-select: none;
            cursor: pointer;
            touch-action: manipulation;
        }

        .serif { font-family: 'Noto Serif KR', serif; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        #input-area { padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
        #sidebar, #right-sidebar { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }

        /* ì±„íŒ…ì°½ ë„ˆë¹„ ê³ ì • ë° ì¤‘ì•™ ì •ë ¬ ê°•í™” */
        .msg-container { max-width: 800px; margin: 0 auto; padding: 0 1.5rem; width: 100%; box-sizing: border-box; }
        .msg-wrapper { display: block; margin-bottom: 2rem; position: relative; }
        
        .msg-wrapper.user .novel-text { 
            font-family: 'Noto Sans KR', sans-serif; font-weight: 700; color: #4f46e5; background-color: #eef2ff;
            padding: 0.75rem 1.25rem; border-left: 4px solid #4f46e5; border-radius: 0 0.75rem 0.75rem 0; display: inline-block; margin-bottom: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: var(--novel-font-size);
        }
        
.novel-text {
    overflow-wrap: anywhere; 
    word-break: break-word;
}

        .novel-text p { margin: 0 !important; padding: 0 !important; margin-bottom: 0.3rem !important; }
        .novel-text p:last-child { margin-bottom: 0 !important; }

        .msg-wrapper.model .novel-text { 
            font-family: 'Noto Serif KR', serif; 
            font-size: var(--novel-font-size);
            line-height: 1.9; color: #1e293b; text-align: justify;
        }
        
        .msg-wrapper.director .novel-text {
            font-family: 'Noto Sans KR', sans-serif; font-size: 0.95rem; color: #475569; background-color: #f1f5f9;
            padding: 1rem; border: 2px dashed #94a3b8; border-radius: 0.5rem; width: 100%; display: block;
        }
        .msg-wrapper.director::before { content: '   ì´ì—°ì¶œê°€'; display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; font-weight: bold; margin-left: 0.2rem; }

        .nav-btn.active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        
        .editor-tab-btn { padding: 0.5rem 0.75rem; color: #64748b; border-bottom: 2px solid transparent; font-weight: 500; font-size: 0.9rem; white-space: nowrap; }
        .editor-tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; font-weight: 700; }

        .generator-tab-btn { flex:1; padding: 0.5rem; text-align: center; font-size: 0.85rem; font-weight: bold; color: #64748b; background: #f1f5f9; border-bottom: 2px solid transparent; }
        .generator-tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; background: white; }
        
        .world-select-btn { text-align: left; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; transition: 0.2s; }
        .world-select-btn:hover { border-color: #6366f1; background-color: #eef2ff; }
        .world-select-btn.selected { border-color: #4f46e5; background-color: #e0e7ff; ring: 2px solid #6366f1; }

        .keyword-tag { padding: 0.3rem 0.7rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 500; background-color: white; color: #334155; border: 1px solid #cbd5e1; cursor: pointer; transition: 0.15s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .keyword-tag:hover { background-color: #f1f5f9; border-color: #94a3b8; }
        .keyword-tag.active { background-color: #334155; color: #fcd34d; border-color: #0f172a; } 

        .rule-item.collapsed .rule-content { display: none; }
        .rule-item .rule-header i.fa-chevron-down { transition: transform 0.2s; }
        .rule-item.collapsed .rule-header i.fa-chevron-down { transform: rotate(-90deg); }
        .rule-item.disabled .rule-header { background-color: #f3f4f6; color: #9ca3af; }
        .rule-item.disabled .rule-header .font-bold { text-decoration: line-through; }

        .world-item .world-chars { display: none; }
        .world-item.open .world-chars { display: block; }
        .world-item.open .world-header { background-color: #eff6ff; border-color: #bfdbfe; border-radius: 0.5rem 0.5rem 0 0; }

        #sidebar, #right-sidebar { overflow: hidden; transition: width 0.3s, transform 0.3s; }
        
        /* PC ì‚¬ì´ë“œë°” */
        @media (min-width: 768px) { 
            #sidebar, #right-sidebar { width: 320px; flex-shrink: 0; } 
            #sidebar.closed, #right-sidebar.closed { width: 0; padding-left: 0; padding-right: 0; border-left: none; border-right: none; } 
        }
        /* ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” */
        @media (max-width: 767px) { 
            #sidebar, #right-sidebar { position: fixed; top: 0; height: 100%; z-index: 60; width: 85%; max-width: 320px; } 
            #sidebar { left: 0; transform: translateX(-100%); } #sidebar.open { transform: translateX(0); } 
            #right-sidebar { right: 0; transform: translateX(100%); } #right-sidebar.open { transform: translateX(0); } 
        }
        
        .gen-section.hidden-section { display: none; }
        .gen-section.hidden-section.show { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }

/* â–¼â–¼â–¼ [ìˆ˜ì •ë¨] ê°œì„ ëœ ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ë‚´ìš©ì„ ì§€ìš°ê³  ë®ì–´ì”Œìš°ì„¸ìš”) â–¼â–¼â–¼ */
        html.dark body { background-color: #0f172a !important; color: #f1f5f9 !important; }
        
        /* 1. ë©”ì¸ ì»¨í…Œì´ë„ˆ ë° ëª¨ë‹¬ ë°°ê²½ (ë„ˆë¬´ ê²€ì§€ ì•Šì€ ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë‹¤í¬ ê·¸ë ˆì´) */
        html.dark .bg-white, html.dark .bg-gray-50, html.dark .bg-gray-100 { 
            background-color: #1e293b !important; /* Slate 800 */
            border-color: #334155 !important;     /* Slate 700 */
            color: #f8fafc !important; 
        }
        
        /* 2. ì‚¬ì´ë“œë°” ë° í—¤ë” (ë³¸ë¬¸ë³´ë‹¤ ì‚´ì§ ë” ì–´ë‘¡ê²Œ ëˆŒëŸ¬ì¤Œ) */
        html.dark #sidebar, html.dark #right-sidebar, html.dark header, html.dark footer {
            background-color: #0f172a !important; /* Slate 900 */
            border-color: #1e293b !important;
        }
        
        /* 3. í…ìŠ¤íŠ¸ ê°€ë…ì„± ê°œì„  (íšŒìƒ‰ ê¸€ì”¨ë¥¼ ë°ì€ ì€ìƒ‰ìœ¼ë¡œ ë³€ê²½) */
        html.dark .text-gray-500, html.dark .text-gray-600, html.dark .text-gray-700, html.dark .text-gray-800 {
            color: #cbd5e1 !important; /* Slate 300 */
        }
        html.dark .text-gray-400 { color: #94a3b8 !important; }
        
        /* 4. ì…ë ¥ì°½, ë²„íŠ¼, ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ (ë°°ê²½ê³¼ ëª…í™•íˆ êµ¬ë¶„ë˜ë„ë¡ ë°ê²Œ) */
        html.dark input, html.dark textarea, html.dark select, html.dark .world-select-btn, html.dark .bg-gray-200 {
            background-color: #334155 !important; /* Slate 700 */
            color: #fff !important; 
            border-color: #475569 !important;
        }
        
        /* 5. ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ (Hover) */
        html.dark .world-select-btn:hover, html.dark .nav-btn:hover, html.dark button:hover {
            background-color: #475569 !important; /* Slate 600 */
            color: #fff !important;
        }

        /* 6. [ì¤‘ìš”] ì„ íƒëœ í•­ëª© ê°•ì¡° (í™•ì‹¤í•œ í¬ì¸íŠ¸ ì»¬ëŸ¬) */
        html.dark .world-select-btn.selected {
            background-color: #4f46e5 !important; /* Indigo 600 */
            border-color: #818cf8 !important;     /* í…Œë‘ë¦¬ëŠ” ë” ë°ê²Œ */
            color: #fff !important;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.3) !important;
        }
        html.dark .world-select-btn.selected .text-gray-500 { color: #e0e7ff !important; } /* ì„ íƒëœ í•­ëª© ë‚´ë¶€ ì„¤ëª…ê¸€ ìƒ‰ìƒ */

        /* 7. ë§í’ì„  ìŠ¤íƒ€ì¼ ê°œì„  */
        /* ìœ ì €: ì„ ëª…í•œ ì¸ë””ê³  ë¸”ë£¨ */
        html.dark .msg-wrapper.user .novel-text {
            background-color: #4338ca !important; 
            color: #e0e7ff !important; 
            border-left-color: #818cf8 !important;
        }
        /* AI: ë°°ê²½ìƒ‰ ì—†ì´ ê¸€ìë§Œ í•˜ì–—ê²Œ (ë˜ëŠ” ì•„ì£¼ ì—°í•œ ë°°ê²½) */
        html.dark .msg-wrapper.model .novel-text {
            color: #f1f5f9 !important;
        }
        
        /* 8. ê¸°íƒ€ ìš”ì†Œ (ë²„íŠ¼, ë±ƒì§€ ë“±) ë¯¸ì„¸ ì¡°ì • */
        html.dark .bg-indigo-50 { background-color: #312e81 !important; color: #e0e7ff !important; border-color: #4338ca !important; }
        html.dark .text-indigo-600, html.dark .text-indigo-700 { color: #a5b4fc !important; } /* ë„ˆë¬´ ì–´ë‘ìš´ íŒŒë€ ê¸€ì”¨ë¥¼ ë°ê²Œ */
        html.dark .text-purple-700 { color: #d8b4fe !important; }
        html.dark .bg-purple-50 { background-color: #581c87 !important; border-color: #6b21a8 !important; }

        /* ëª¨ë‹¬ ë°±ë“œë¡­ (ë’¤ì— ë¹„ì¹˜ëŠ” ë°°ê²½ì„ ë” ì–´ë‘¡ê²Œ) */
        html.dark .modal-backdrop { background-color: rgba(0, 0, 0, 0.85) !important; }
        html.dark ::-webkit-scrollbar-thumb { background: #475569; }
        html.dark ::-webkit-scrollbar-track { background: #0f172a; }
        /* â–²â–²â–² [ìˆ˜ì •ë¨] ë â–²â–²â–² */

/* â–¼â–¼â–¼ [ìˆ˜ì •] ë‹¤í¬ ëª¨ë“œ: AI ìƒì„± íƒœê·¸(í‚¤ì›Œë“œ) ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ */

/* 1. íƒœê·¸ ê¸°ë³¸ ìƒíƒœ (ì„ íƒ ì•ˆë¨) */
html.dark .keyword-tag {
    background-color: #334155 !important; /* ì–´ë‘ìš´ íšŒìƒ‰ ë°°ê²½ */
    color: #e2e8f0 !important;           /* ë°ì€ ê¸€ì”¨ */
    border-color: #475569 !important;     /* í…Œë‘ë¦¬ */
}

/* 2. íƒœê·¸ ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ (Hover) */
html.dark .keyword-tag:hover {
    background-color: #475569 !important; /* ì‚´ì§ ë” ë°ê²Œ */
}

/* 3. íƒœê·¸ ì„ íƒë¨ (Active) - í™•ì‹¤í•œ ê°•ì¡° ìƒ‰ìƒ */
html.dark .keyword-tag.active {
    background-color: #4f46e5 !important; /* ì¸ë””ê³  ë¸”ë£¨ (ê°•ì¡°) */
    color: #ffffff !important;            /* í°ìƒ‰ ê¸€ì”¨ */
    border-color: #818cf8 !important;     /* ë°ì€ í…Œë‘ë¦¬ */
    box-shadow: 0 0 5px rgba(99, 102, 241, 0.5) !important; /* ì€ì€í•œ ê´‘ì› íš¨ê³¼ */
}

/* â–¼â–¼â–¼ [ìˆ˜ì •] ì„ íƒì§€(ë¦¬ìŠ¤íŠ¸) ì¤„ë°”ê¿ˆ ì •ë ¬ ê°œì„  â–¼â–¼â–¼ */

/* 1. ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤(ìˆ«ì)ë¥¼ í…ìŠ¤íŠ¸ ì˜ì—­ ë°–ìœ¼ë¡œ ëºŒ */
.novel-text ol, .novel-text ul {
    list-style-position: outside !important; 
    padding-left: 1.8rem !important; /* ìˆ«ì ë“¤ì–´ê°ˆ ê³µê°„ í™•ë³´ */
    margin-left: 0.2rem !important;
}

/* 2. ë¦¬ìŠ¤íŠ¸ ë‚´ë¶€ ê°„ê²© ì¡°ì • */
.novel-text li {
    margin-bottom: 0.4rem !important; /* í•­ëª© ê°„ ê°„ê²© ë„“í˜ (ê°€ë…ì„±) */
    padding-left: 0.3rem !important;  /* í…ìŠ¤íŠ¸ì™€ ìˆ«ì ì‚¬ì´ ê°„ê²© */
}

/* â–¼â–¼â–¼ [ìˆ˜ì •] ì„ íƒì§€(ë¦¬ìŠ¤íŠ¸) ì¤„ë°”ê¿ˆ ì •ë ¬ ê°œì„  â–¼â–¼â–¼ */
.novel-text li p {
    display: block !important; 
    margin: 0 !important;
}

/* â–¼â–¼â–¼ [ì‹ ê·œ] 1ë‹¨ê³„: ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ë¦¬íŒ©í† ë§ ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ */
.right-tab-btn {
    flex: 1;
    text-align: center;
    padding: 0.75rem 0;
    font-size: 0.85rem;
    font-weight: 600;
    color: #64748b;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}
.right-tab-btn:hover { background-color: #f8fafc; color: #475569; }
.right-tab-btn.active {
    color: #4f46e5;
    border-bottom-color: #4f46e5;
    background-color: #fff;
}
html.dark .right-tab-btn { color: #94a3b8; }
html.dark .right-tab-btn:hover { background-color: #1e293b; color: #cbd5e1; }
html.dark .right-tab-btn.active { color: #818cf8; border-bottom-color: #818cf8; background-color: #0f172a; }

.setting-group-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: #64748b;
    margin-bottom: 0.25rem;
    display: block;
}
html.dark .setting-group-label { color: #94a3b8; }

.sidebar-select {
    width: 100%;
    padding: 0.4rem;
    font-size: 0.85rem;
    border: 1px solid #cbd5e1;
    border-radius: 0.375rem;
    background-color: white;
    color: #334155;
}
html.dark .sidebar-select {
    background-color: #334155;
    border-color: #475569;
    color: #f1f5f9;
}
/* â–²â–²â–² 1ë‹¨ê³„ ìŠ¤íƒ€ì¼ ë â–²â–²â–² */

/* â–¼â–¼â–¼ [ìˆ˜ì •ë¨] 2ë‹¨ê³„: ì•ˆì „í•œ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ */

/* 1. ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ë””ìì¸ */
.resize-grip {
    height: 12px; /* ë†’ì´ ì•½ê°„ ì¤„ì„ (ê³µê°„ ì ˆì•½) */
    background-color: #f1f5f9;
    border-top: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: row-resize;
    touch-action: none; /* í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    user-select: none;
    flex-shrink: 0; /* ë†’ì´ ì¤„ì–´ë“¦ ë°©ì§€ */
}
.resize-grip i {
    width: 30px;
    height: 3px;
    background-color: #cbd5e1;
    border-radius: 2px;
    display: block;
}

html.dark .resize-grip {
    background-color: #1e293b;
    border-color: #334155;
}
html.dark .resize-grip i { background-color: #475569; }

/* 2. ì…ë ¥ì°½ ë˜í¼ (ë ˆì´ì•„ì›ƒ ë³´í˜¸ìš©) */
.resizable-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;         /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
    min-width: 0;    /* í”Œë ‰ìŠ¤ ë°•ìŠ¤ ë„˜ì¹¨ ë°©ì§€ */
    position: relative;
}

/* 3. ì‚¬ì´ë“œë°” í„°ì¹˜ ì˜ì—­ í™•ì¥ (ê°€ìƒ ìš”ì†Œ) */
#sidebar::after, #right-sidebar::before {
    content: ''; position: absolute; top: 0; width: 20px; height: 100%; z-index: 50;
    pointer-events: none; /* ë“œë˜ê·¸ êµ¬í˜„ ì „ê¹Œì§€ëŠ” í´ë¦­ í†µê³¼ */
}
#sidebar::after { right: -10px; }
#right-sidebar::before { left: -10px; }

/* â–¼â–¼â–¼ [í•„ìˆ˜] ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ìŠ¤íƒ€ì¼ (ì—†ìœ¼ë©´ style íƒœê·¸ ë§¨ ì•„ë˜ì— ì¶”ê°€í•˜ì„¸ìš”) â–¼â–¼â–¼ */
.resize-grip {
    height: 12px;
    background-color: #f1f5f9;
    border-top: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: row-resize;
    touch-action: none;
    user-select: none;
    flex-shrink: 0;
}
.resize-grip i { width: 30px; height: 3px; background-color: #cbd5e1; border-radius: 2px; display: block; }
html.dark .resize-grip { background-color: #1e293b; border-color: #334155; }
html.dark .resize-grip i { background-color: #475569; }

.resizable-wrapper {
    display: flex; flex-direction: column; flex: 1; min-width: 0; position: relative;
}

    </style>
</head>

<body class="bg-gray-100 overflow-hidden flex h-dvh">
    <div id="dim-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[55] hidden md:hidden" onclick="closeAllSidebars()"></div>

    <aside id="sidebar" class="bg-white border-r border-gray-200 flex flex-col h-full shadow-xl">
        <div class="p-4 border-b border-gray-100 bg-indigo-600 text-white flex justify-between items-center flex-shrink-0">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-book-open mr-2"></i>E.No.S v2.03</h1>
            <button onclick="closeAllSidebars()" class="text-white md:hidden"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div class="flex text-sm border-b border-gray-200 bg-gray-50 flex-shrink-0">
            <!-- íƒ­ ëª…ì¹­ ë³€ê²½: ì±„íŒ…ë°© -> ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
            <button onclick="switchNav('chats')" id="nav-chats" class="nav-btn active flex-1 py-3 font-medium text-gray-500 hover:text-indigo-600 transition">ë¼ì´ë¸ŒëŸ¬ë¦¬</button>
            <button onclick="switchNav('worlds')" id="nav-worlds" class="nav-btn flex-1 py-3 font-medium text-gray-500 hover:text-indigo-600 transition">ë°°ê²½</button>
        </div>
        <div id="sidebar-content" class="flex-1 overflow-y-auto bg-white relative">
            <div id="panel-chats" class="p-2 space-y-2"></div>
            <div id="panel-worlds" class="p-2 space-y-2 hidden"></div>
        </div>
        <div id="creation-buttons" class="p-3 border-t border-gray-100 bg-gray-50 flex flex-col gap-2 flex-shrink-0 relative">
            <button id="external-char-create-btn" onclick="openAiGeneratorModal('creative_char')" class="hidden w-full py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 text-sm font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-search"></i> ì°½ì‘ë¬¼ ìºë¦­í„°(ê²€ìƒ‰)
            </button>
             <button id="external-user-create-btn" onclick="openAiGeneratorModal('creative_user')" class="hidden w-full py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 text-sm font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-search"></i> ì°½ì‘ë¬¼ ìœ ì €(ê²€ìƒ‰)
            </button>
             <button id="external-world-create-btn" onclick="openAiGeneratorModal('creative_world')" class="hidden w-full py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 text-sm font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-search"></i> ì°½ì‘ë¬¼ ë°°ê²½
            </button>
            
            <button id="ai-create-btn" class="w-full py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 text-sm font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles"></i> AIë¡œ ìƒì„±
            </button>
            <button id="manual-create-btn" class="w-full py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 text-sm font-bold flex items-center justify-center gap-2">
                 <i class="fa-solid fa-pen-ruler"></i> ì§ì ‘ ì…ë ¥
            </button>
             <button onclick="openCoreModal()" class="w-full mt-2 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                <i class="fa-solid fa-cogs"></i> ì„¤ì •
            </button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 flex flex-col relative w-full bg-gray-50 overflow-hidden">
        <header class="h-16 flex items-center justify-between px-3 md:px-4 border-b border-gray-200 bg-white z-20 shadow-sm flex-shrink-0">
            <div class="flex items-center gap-2 md:gap-3 overflow-hidden flex-1">
                <button onclick="toggleSidebar()" class="text-gray-600 mr-1 p-2 rounded hover:bg-gray-100 z-50 relative"><i class="fa-solid fa-bars text-xl"></i></button>
<div class="flex flex-col overflow-hidden w-full">
    <div class="flex items-center gap-2 cursor-pointer group" onclick="editChatTitle()" title="í´ë¦­í•˜ì—¬ ì œëª© ìˆ˜ì •">
        <h2 id="header-title" class="font-bold text-gray-800 truncate group-hover:text-indigo-600 transition">E.No.S v2.03</h2>
        <i class="fa-solid fa-pen text-xs text-gray-400 group-hover:text-indigo-600 transition flex-shrink-0"></i>
    </div>

    <div id="header-info" class="text-xs text-gray-500 truncate hidden items-center gap-2 md:gap-3">
        <span id="info-world"><i class="fa-solid fa-globe"></i> -</span>
        <span id="model-display" class="font-medium text-indigo-500 text-xs md:text-sm"></span>
    </div>
</div>
            </div>
            
            <button onclick="toggleRightSidebar()" class="text-gray-600 w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-full transition" title="ë„êµ¬ ëª¨ìŒ"><i class="fa-solid fa-toolbox text-xl"></i></button>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-6 transition-all duration-300 min-h-0 bg-white">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400 space-y-4">
                <i class="fa-solid fa-feather text-6xl text-gray-200"></i>
                <p>ì¢Œì¸¡ ë©”ë‰´ì—ì„œ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
            </div>
        </div>

<footer id="input-area" class="pt-2 px-4 bg-white border-t border-gray-200 hidden flex-col flex-shrink-0 z-50">
            <form id="chat-form" onsubmit="event.preventDefault(); handleFormSubmit();" class="max-w-4xl mx-auto relative w-full">
                
<div id="macro-popup" class="absolute bottom-full left-0 mb-2 bg-white border border-gray-200 shadow-lg rounded-xl p-2 flex flex-wrap gap-2 hidden w-full z-50">
</div>

                <div class="flex gap-2 items-end">
                    <button type="button" onclick="toggleMacroPopup()" class="w-10 h-10 md:w-12 md:h-12 flex-shrink-0 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 flex items-center justify-center transition">
                        <i class="fa-solid fa-plus"></i>
                    </button>

                    <textarea id="msg-input" rows="1" placeholder="ë©”ì‹œì§€ ì…ë ¥" class="flex-1 bg-gray-100 text-gray-800 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none shadow-inner" style="max-height: 150px;"></textarea>
                    
                    <button type="submit" id="send-btn" class="bg-indigo-600 text-white rounded-full w-10 h-10 md:w-12 md:h-12 flex-shrink-0 flex items-center justify-center hover:bg-indigo-700 shadow-lg transition-transform active:scale-95 transition-colors duration-200">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </footer>
    </main>

    <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” (ë„êµ¬ ëª¨ìŒ + ë¡œì–´ë¶) -->
    <aside id="right-sidebar" class="bg-white border-l border-gray-200 flex flex-col h-full shadow-xl closed">
        <div class="p-4 border-b border-gray-200 bg-slate-800 text-white flex justify-between items-center h-16 flex-shrink-0">
            <h2 class="font-bold text-lg"><i class="fa-solid fa-toolbox mr-2"></i>ìŠ¤íŠœë””ì˜¤ ë„êµ¬</h2>
            <button onclick="toggleRightSidebar()" class="text-gray-300 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div id="right-sidebar-content" class="flex-1 overflow-y-auto p-3 space-y-4"></div>
    </aside>

    <div id="modal-container" class="fixed inset-0 z-[70] hidden">
        <div id="ai-generator-modal" class="absolute inset-0 flex items-center justify-center p-4 modal-backdrop hidden" onclick="closeModal('ai-generator-modal')">
            <div class="bg-gray-100 rounded-xl w-full max-w-2xl h-[90vh] flex flex-col shadow-2xl relative" onclick="event.stopPropagation()">
                 <div id="modal-loading-overlay-ai" class="absolute inset-0 bg-white/70 z-10 hidden items-center justify-center flex-col space-y-2 rounded-xl">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-600"></i>
                    <span class="text-sm font-medium text-gray-700">AIê°€ ì‘ì—…ì„ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...</span>
                    <span id="ai-progress-time" class="text-xs text-indigo-600 font-bold hidden bg-indigo-50 px-3 py-1 rounded-full">0ì´ˆ ê²½ê³¼</span>
                    
                    <button onclick="cancelGeneration()" class="mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold shadow transition flex items-center gap-2">
                        <i class="fa-solid fa-stop"></i> ì¤‘ë‹¨í•˜ê¸°
                    </button>

                    <span id="ai-retry-msg" class="text-xs text-red-500 hidden">íŠ¸ë˜í”½ ê³¼ë¶€í•˜ ê°ì§€. 1ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤...</span>
                    <span id="ai-error-msg" class="text-xs text-red-600 font-bold mt-2 hidden"></span>
                </div>
                <div class="p-4 border-b flex justify-between items-center bg-white rounded-t-xl relative">
                    <div class="flex items-center gap-3">
                        <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-wand-magic-sparkles mr-2 text-indigo-500"></i>AIë¡œ ìƒì„±í•˜ê¸°</h3>
                        <button id="btn-random-gen" onclick="randomizeTab()" class="px-3 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold hover:bg-purple-200 hidden transition">
                            <i class="fa-solid fa-dice mr-1"></i>ëœë¤ ì„¤ì • (í˜„ì¬ íƒ­)
                        </button>
                    </div>
                    <button onclick="closeModal('ai-generator-modal')" class="text-gray-500 hover:text-black p-2"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div id="ai-generator-tabs" class="flex border-b bg-gray-50 hidden"></div> 
                <div id="ai-generator-body" class="flex-1 overflow-y-auto p-6"></div>
                <div class="p-4 border-t bg-gray-50 flex justify-end rounded-b-xl">
                    <button onclick="handleGenerateClick()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow">
                        <i class="fa-solid fa-dice mr-2"></i>ìƒì„±í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

<div id="editor-modal" class="absolute inset-0 flex items-center justify-center p-4 modal-backdrop hidden" onclick="tryCloseModal('editor-modal')">
            <div class="bg-white rounded-xl w-full max-w-3xl h-[90vh] flex flex-col shadow-2xl relative" onclick="event.stopPropagation()">
                <div id="modal-loading-overlay-details" class="absolute inset-0 bg-white/70 z-20 hidden items-center justify-center flex-col space-y-2 rounded-xl">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-600"></i>
                    <span class="text-sm font-medium text-gray-700">AIê°€ ì„¤ì •/ìƒì„¸ ì •ë³´ë¥¼ ì±„ìš°ëŠ” ì¤‘...</span>
                    <button onclick="cancelDetailGeneration()" class="mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold shadow transition flex items-center gap-2">
                        <i class="fa-solid fa-stop"></i> ì¤‘ë‹¨í•˜ê¸°
                    </button>
                </div>
                <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-xl flex justify-between items-center">
                    <h3 id="modal-title" class="font-bold text-lg text-gray-800">ì„¤ì •</h3>
                    <div class="flex gap-2 items-center">
                        <button id="btn-gen-details" onclick="generateDetails()" class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-xs font-bold hover:bg-yellow-200 border border-yellow-300 hidden">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> AIë¡œ ì„¤ì • ì±„ìš°ê¸°
                        </button>
                        <button onclick="closeModal('editor-modal')" class="text-gray-500 hover:text-black p-2"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                </div>
                <div id="modal-body" class="flex-1 overflow-y-auto p-6"></div>
                <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center gap-2 rounded-b-xl">
                    <button id="modal-delete-btn" class="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg text-sm font-medium hidden">ì‚­ì œ</button>
                    <button id="modal-save-btn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>

<div id="memory-modal" class="absolute inset-0 flex items-center justify-center p-4 modal-backdrop hidden" onclick="tryCloseModal('memory-modal')">
    <div class="bg-white rounded-xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh] relative" onclick="event.stopPropagation()">
        
        <div id="modal-loading-overlay-memory" class="absolute inset-0 bg-white/80 z-20 hidden items-center justify-center flex-col space-y-3 rounded-xl">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-600"></i>
            <span class="text-sm font-bold text-gray-700">ğŸ§  AIê°€ ê¸°ì–µì„ ìš”ì•½/ì¬êµ¬ì„± ì¤‘ì…ë‹ˆë‹¤...</span>
        </div>

        <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center rounded-t-xl">
                    <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-brain mr-2 text-indigo-500"></i>ì¥ê¸° ê¸°ì–µ</h3>
                    
                    <div class="flex gap-2 items-center">
                        <button onclick="generateAutoSummary()" class="px-3 py-1.5 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-lg hover:bg-yellow-200 transition border border-yellow-300 flex items-center shadow-sm">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1.5"></i>AI ìë™ ìš”ì•½
                        </button>

                        <button onclick="closeModal('memory-modal')" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition">
                            <i class="fa-solid fa-times text-lg"></i>
                        </button>
                    </div>
                </div>

                <div class="p-5 flex-1 overflow-y-auto">
                    <textarea id="memory-input" class="w-full p-3 border rounded-lg h-64 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ì—¬ê¸°ì— ì‘ì„±ëœ ë‚´ìš©ì€ AIê°€ ì˜êµ¬ì ìœ¼ë¡œ ê¸°ì–µí•©ë‹ˆë‹¤."></textarea>
                </div>
                
                <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end rounded-b-xl">
                    <button onclick="saveMemory()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow">ì €ì¥</button>
                </div>
            </div>
        </div>


        <!-- ì „ì—­ ì„¤ì • ëª¨ë‹¬ (Core Modal) -->
        <div id="core-modal" class="absolute inset-0 flex items-center justify-center p-0 md:p-4 modal-backdrop hidden" onclick="closeModal('core-modal')">
            <!-- ëª¨ë°”ì¼ì—ì„œëŠ” h-full, PCì—ì„œëŠ” h-[90vh] ë° ë‘¥ê·¼ ëª¨ì„œë¦¬ ì ìš© -->
            <div class="bg-white rounded-xl w-full max-w-4xl h-full flex flex-col shadow-2xl md:h-[90vh] md:rounded-xl" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-bold text-lg">ì „ì—­ ì„¤ì •</h3><button onclick="closeModal('core-modal')" class="text-gray-500 hover:text-black"><i class="fa-solid fa-times text-xl"></i></button></div>
                <div class="flex-1 flex overflow-y-auto flex-col md:flex-row">
                    <!-- ëª¨ë°”ì¼ìš© íƒ­ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                    <div class="md:hidden p-4 border-b border-gray-200 bg-gray-50 flex-shrink-0">
                        <select id="core-tab-select-mobile" class="w-full p-2 border rounded-lg bg-white" onchange="switchCoreTab(this.value)">
                            <option value="api">API ë° ëª¨ë¸</option>
                            <option value="novel">ì†Œì„¤ ìƒì„¸ì„¤ì •</option>
                            <option value="view">í™”ë©´ ì„¤ì •</option>
                            <option value="core">AI í•µì‹¬ ì§€ì¹¨</option>
                            <option value="dic">ìš©ì–´/í‘œí˜„ ì§€ì¹¨</option>
                            <option value="macro">ë‹¨ì¶• ë¬¸êµ¬</option>
                            <option value="data">ë°ì´í„° ê´€ë¦¬</option>
                        </select>
                    </div>

                    <!-- PCìš© íƒ­ ì‚¬ì´ë“œë°” -->
                    <div id="core-modal-nav-desktop" class="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-gray-200 bg-gray-50 hidden md:block flex-shrink-0">
                        <button class="block w-full text-left p-4 font-medium border-b hover:bg-gray-100" onclick="switchCoreTab('api')">API ë° ëª¨ë¸</button>
                        <button class="block w-full text-left p-4 font-medium border-b hover:bg-gray-100" onclick="switchCoreTab('novel')">ì†Œì„¤ ìƒì„¸ì„¤ì •</button>
                        <button class="block w-full text-left p-4 font-medium border-b hover:bg-gray-100" onclick="switchCoreTab('view')">í™”ë©´ ì„¤ì •</button>
                        <button class="block w-full text-left p-4 font-medium border-b hover:bg-gray-100" onclick="switchCoreTab('core')">AI í•µì‹¬ ì§€ì¹¨</button>
                        <button class="block w-full text-left p-4 font-medium border-b hover:bg-gray-100" onclick="switchCoreTab('dic')">ìš©ì–´/í‘œí˜„ ì§€ì¹¨</button>
                        <button class="block w-full text-left p-4 font-medium border-b hover:bg-gray-100" onclick="switchCoreTab('macro')">ë‹¨ì¶• ë¬¸êµ¬</button>
                        <button class="block w-full text-left p-4 font-medium border-b hover:bg-gray-100" onclick="switchCoreTab('data')">ë°ì´í„° ê´€ë¦¬</button>
                    </div>
                    
<div class="w-full md:w-2/3 flex-1 overflow-y-auto p-6">
    <div id="core-tab-api" class="core-tab-content space-y-4">
<label class="block text-sm font-medium text-gray-700">Gemini API Key</label>
<div class="relative">
    <input type="password" id="core-api-key" class="w-full p-2 border rounded-lg pr-10 bg-white" placeholder="API í‚¤ ì…ë ¥">
    
    <button type="button" onclick="toggleApiKeyVisibility()" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-indigo-600" title="í‚¤ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°">
        <i id="api-key-icon" class="fa-solid fa-eye"></i>
    </button>
</div>
        <p class="text-xs text-gray-500 mt-2 font-bold text-indigo-600">í˜„ì¬ ì ìš© ëª¨ë¸: <span id="current-model-display"></span></p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">AI ëª¨ë¸ ì„ íƒ</label>
                <select id="core-model-select" class="w-full p-2 border rounded-lg bg-white">
                    <option value="gemini-3-pro-preview">Gemini 3 Pro preview</option>
                    <option value="gemini-3-flash-preview">Gemini 3 Flash preview</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì¶œë ¥ ì†ë„</label>
                <select id="core-speed-select" class="w-full p-2 border rounded-lg bg-white">
                    <option value="15">ë¹ ë¦„ (15ms)</option>
                    <option value="30">ë³´í†µ (30ms)</option>
                </select>
            </div>
        </div>
        
        <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">ìµœëŒ€ ì¶œë ¥ ê¸¸ì´ (í† í°)</label>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500 w-8">2k</span>
                <input type="range" id="core-max-token-slider" min="2000" max="8000" step="1000" class="flex-1 accent-indigo-600 cursor-pointer">
                <span class="text-xs text-gray-500 w-8">8k</span>
            </div>
            <div class="text-right text-sm text-indigo-600 font-bold mt-1">
                í˜„ì¬ ì„¤ì •: <span id="core-max-token-val">2000</span> í† í°
            </div>
            <p class="text-xs text-gray-400 mt-1">* 2000(ë³´í†µ) ~ 8000(ë§¤ìš° ê¹€). ê¸¸ê²Œ ì„¤ì •í• ìˆ˜ë¡ ìƒì„± ì‹œê°„ì´ ê¸¸ì–´ì§‘ë‹ˆë‹¤.</p>
        </div>

        <div class="flex items-center justify-between p-3 bg-red-50 border border-red-100 rounded-lg mt-2">
            <span class="text-sm font-bold text-red-700">ì•ˆì „ í•„í„° ë„ê¸° (Uncensored)</span>
            <input type="checkbox" id="core-safety-toggle" class="w-5 h-5 text-red-600 focus:ring-red-500 border-gray-300 rounded">
        </div>
        <p class="text-xs text-gray-500">* ì•ˆì „ í•„í„°ë¥¼ ë„ë©´ ì„±ì /í­ë ¥ì  ë¬˜ì‚¬ê°€ ë” ììœ ë¡œì›Œì§€ì§€ë§Œ, AIê°€ ê±°ë¶€í•  í™•ë¥ ì€ ì—¬ì „íˆ ì¡´ì¬í•©ë‹ˆë‹¤.</p>
    </div>

    <div id="core-tab-novel" class="core-tab-content hidden space-y-4">
        <h4 class="font-bold text-gray-700 mb-2">ì†Œì„¤ ì—°ì¶œ ìƒì„¸ ì§€ì¹¨</h4>
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">ì„œìˆ  ì‹œì  (Point of View)</label>
            <select id="core-novel-point" class="w-full p-2 border rounded-lg bg-white">
                <option value="3ì¸ì¹­ ì œí•œì  ì‹œì  (ì¶”ì²œ)">3ì¸ì¹­ ì œí•œì  ì‹œì  (ì¶”ì²œ: ì£¼ì¸ê³µ ë‚´ë©´ ë¬˜ì‚¬ ìœ„ì£¼)</option>
                <option value="3ì¸ì¹­ ì œí•œì  (íˆë¡œì¸ ë‚´ë©´)">3ì¸ì¹­ ì œí•œì  (íˆë¡œì¸ ë‚´ë©´ ë¬˜ì‚¬ ìœ„ì£¼)</option>
                <option value="1ì¸ì¹­ ì£¼ì¸ê³µ ì‹œì ">1ì¸ì¹­ ì£¼ì¸ê³µ ì‹œì  (ë‚˜ëŠ”...)</option>
                <option value="3ì¸ì¹­ ê´€ì°°ì ì‹œì ">3ì¸ì¹­ ê´€ì°°ì ì‹œì  (ì˜í™”ì /ê±´ì¡°í•¨)</option>
                <option value="3ì¸ì¹­ ì „ì§€ì  ì‘ê°€ ì‹œì ">3ì¸ì¹­ ì „ì§€ì  ì‘ê°€ ì‹œì  (ëª¨ë“  ê²ƒ íŒŒì•…)</option>
            </select>
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">ë¬¸ì²´ ìŠ¤íƒ€ì¼</label>
            <select id="core-novel-style" class="w-full p-2 border rounded-lg bg-white">
                <option value="ì›¹ì†Œì„¤ì²´">ì›¹ì†Œì„¤ì²´ (ê°€ë…ì„± ë†’ìŒ/ì ë‹¹í•œ ë¬˜ì‚¬)</option>
                <option value="ê°„ê²°/ê±´ì¡°ì²´">ê°„ê²°/ê±´ì¡°ì²´ (ì§§ì€ ë¬¸ì¥/í•˜ë“œë³´ì¼ë“œ)</option>
                <option value="ë§Œì—°/í™”ë ¤ì²´">ë§Œì—°/í™”ë ¤ì²´ (í’ë¶€í•œ ë¬˜ì‚¬/ê°ì„±ì )</option>
            </select>
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">ì„œìˆ /ëŒ€í™” ë¹„ì¤‘</label>
            <select id="core-novel-ratio" class="w-full p-2 border rounded-lg bg-white">
                <option value="ë°¸ëŸ°ìŠ¤í˜•">ë°¸ëŸ°ìŠ¤í˜• (ëŒ€í™” 50 : ì§€ë¬¸ 50)</option>
                <option value="ì—¬ì ë°œì–¸ ìœ„ì£¼">ì—¬ì ë°œì–¸ ìœ„ì£¼</option>
                <option value="ëŒ€í™” ì¤‘ì‹¬">ëŒ€í™” ì¤‘ì‹¬ (í‹°í‚¤íƒ€ì¹´ ìœ„ì£¼)</option>
                <option value="ì§€ë¬¸/ë¬˜ì‚¬ ì¤‘ì‹¬">ì§€ë¬¸/ë¬˜ì‚¬ ì¤‘ì‹¬ (ìƒí™© ì„¤ëª… ìœ„ì£¼)</option>
            </select>
        </div>

        <div class="mt-4 p-3 bg-red-50 border border-red-100 rounded-lg">
            <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-red-800 text-sm"><i class="fa-solid fa-bolt mr-1"></i>ëŒë°œ ì´ë²¤íŠ¸ (Auto-Event)</label>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-red-600 font-bold" id="event-chance-display">10%</span>
                    <input type="range" id="auto-event-chance" min="0" max="50" step="5" value="10" class="w-24 accent-red-600 cursor-pointer" oninput="document.getElementById('event-chance-display').innerText = this.value + '%'">
                    <input type="checkbox" id="auto-event-toggle" class="w-5 h-5 text-red-600 rounded focus:ring-red-500 cursor-pointer">
                </div>
            </div>
            <p class="text-xs text-red-700 opacity-80 leading-snug">
                ëŒ€í™” ì§„í–‰ ì¤‘ AIê°€ ë¬´ì‘ìœ„ë¡œ 'ìœ„ê¸°'ë‚˜ 'ì‹ ì²´ ë³€ìˆ˜'ë¥¼ ë°œìƒì‹œì¼œ ìƒí™©ì„ ë¹„í‹‰ë‹ˆë‹¤.<br>
                (0%ë¡œ ì„¤ì •í•˜ê±°ë‚˜ ì²´í¬ë¥¼ í•´ì œí•˜ë©´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
            </p>
        </div>
    </div>

    <div id="core-tab-view" class="core-tab-content hidden space-y-4">
        <h4 class="font-bold text-gray-700">í…ìŠ¤íŠ¸/í™”ë©´ ì„¤ì •</h4>

        <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg border">
            <span class="font-bold text-gray-700"><i class="fa-solid fa-moon mr-2"></i>ë‹¤í¬ ëª¨ë“œ (ì•¼ê°„ìš©)</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" onchange="toggleDarkMode()">
                <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
            </label>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ê¸€ì í¬ê¸° ì¡°ì ˆ</label>
            <input type="range" id="font-size-slider" min="14" max="24" step="1" class="w-full accent-indigo-600">
            <div class="text-right text-sm text-gray-500 mt-1">í˜„ì¬: <span id="font-size-val">1.1rem</span></div>
        </div>
        <div class="p-4 bg-gray-100 rounded-lg text-gray-800 border" style="min-height: 100px;">
            <p class="novel-text" id="font-preview-text">
                ì´ í…ìŠ¤íŠ¸ëŠ” ë¯¸ë¦¬ë³´ê¸°ì…ë‹ˆë‹¤.<br>
                í°íŠ¸ í¬ê¸°ë¥¼ ì¡°ì ˆí•˜ë©´ ì´ ë¶€ë¶„ê³¼<br>
                ì±„íŒ…ì°½ì˜ í…ìŠ¤íŠ¸ í¬ê¸°ê°€ ë³€ê²½ë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>

    <div id="core-tab-core" class="core-tab-content hidden space-y-3">
        <div class="mb-2 text-xs text-gray-500">ì²´í¬ë°•ìŠ¤ë¥¼ í•´ì œí•˜ë©´ í•´ë‹¹ ê·œì¹™ì€ AIì—ê²Œ ì „ë‹¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
        <div id="core-rules-list" class="space-y-3"></div>
        <button onclick="addEntryUI('core-rules-list', {title:'ìƒˆ ê·œì¹™',content:'',enabled:true})" class="w-full py-2 bg-indigo-50 text-indigo-600 font-bold rounded">+ ê·œì¹™ ì¶”ê°€</button>
    </div>

    <div id="core-tab-dic" class="core-tab-content hidden space-y-3">
        <div id="core-dic-list" class="space-y-3"></div>
        <button onclick="addEntryUI('core-dic-list', {title:'ìƒˆ ìš©ì–´',content:'',enabled:true})" class="w-full py-2 bg-indigo-50 text-indigo-600 font-bold rounded">+ ìš©ì–´ ì¶”ê°€</button>
    </div>

    <div id="core-tab-data" class="core-tab-content hidden space-y-4">
        <button onclick="backupData()" class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded">ì „ì²´ ë°±ì—… (ë‹¤ìš´ë¡œë“œ)</button>
        <button onclick="loadBackup()" class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded">ì „ì²´ ë³µêµ¬ (ë¶ˆëŸ¬ì˜¤ê¸°)</button>
    </div>

    <div id="core-tab-macro" class="core-tab-content hidden space-y-4">
        <div class="bg-indigo-50 p-3 rounded text-sm text-indigo-700 mb-2">
            <i class="fa-solid fa-info-circle mr-1"></i> ì±„íŒ… ì…ë ¥ì°½ ì™¼ìª½ì˜ <b>(+) ë²„íŠ¼</b>ì„ ëˆŒë €ì„ ë•Œ ë‚˜ì˜¤ëŠ” ë‹¨ì¶•í‚¤ë“¤ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        </div>
        <div id="macro-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1"></div>
        <button onclick="addMacroUI()" class="w-full py-2 bg-indigo-100 text-indigo-600 font-bold rounded hover:bg-indigo-200">+ ìƒˆ ë‹¨ì¶• ë¬¸êµ¬ ì¶”ê°€</button>
    </div>
</div>

</div>
                <div class="p-4 border-t flex justify-end"><button onclick="saveCoreSettings()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold">ì €ì¥</button></div>
            </div>
        </div>

        
<div id="textarea-editor-modal" class="absolute inset-0 flex items-center justify-center p-4 modal-backdrop hidden" onclick="tryCloseModal('textarea-editor-modal')">
             <div class="bg-white rounded-xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="font-bold text-lg">ì „ì²´ í™”ë©´ í¸ì§‘</h3>
                    <button onclick="closeModal('textarea-editor-modal')" class="text-gray-500 hover:text-black"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="flex-1 p-2">
                    <textarea id="modal-textarea-input" class="w-full h-full p-3 border rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"></textarea>
                </div>
                <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end">
                    <button onclick="saveAndCloseTextareaEditor()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow">ì ìš©í•˜ê³  ë‹«ê¸°</button>
                </div>
            </div>
        </div>

        <div id="session-modal" class="absolute inset-0 flex items-center justify-center p-4 modal-backdrop hidden" onclick="closeModal('session-modal')">
            <div class="bg-white rounded-xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
                <div class="p-5 border-b border-gray-200"><h3 class="font-bold text-lg" id="session-modal-title">ì´ì•¼ê¸° ì„¤ì •</h3></div>
                <div class="p-5 flex-1 overflow-hidden flex flex-col md:flex-row gap-6">
                    <div id="session-world-area" class="md:w-1/2 flex flex-col overflow-hidden">
                         <label class="block text-sm font-bold text-gray-700 mb-2"><i class="fa-solid fa-globe mr-1"></i>ë°°ê²½ ì„ íƒ</label>
                         <div id="world-selection-list" class="flex-1 overflow-y-auto space-y-2 pr-2 border p-2 rounded-lg bg-gray-50"></div>
                         <div id="world-fixed-display" class="hidden p-4 bg-indigo-50 rounded-lg border border-indigo-200 text-indigo-700 font-bold"></div>
                    </div>
                    <div class="md:w-1/2 flex flex-col">
                        <label class="block text-sm font-bold text-gray-700 mb-2"><i class="fa-solid fa-users mr-1"></i>ì°¸ì—¬ ìºë¦­í„°</label>
                        <div id="session-chars" class="h-64 overflow-y-auto border p-3 rounded-lg bg-gray-50 space-y-2">
                            <div class="text-gray-400 text-center text-sm mt-10">ì¢Œì¸¡ì—ì„œ ë°°ê²½ì„ ì„ íƒí•˜ì„¸ìš”.</div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end bg-gray-50 rounded-b-xl">
                    <button onclick="closeModal('session-modal')" class="mr-2 px-4 py-2 text-gray-500 font-medium hover:text-gray-800">ì·¨ì†Œ</button>
                    <button onclick="saveSessionSettings()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow transition">í™•ì¸ ë° ì‹œì‘</button>
                </div>
            </div>
        </div>
    </div> 

    <script>

// â–¼â–¼â–¼ [ìˆ˜ì •ë¨] 2ë‹¨ê³„: ì•ˆì „í•œ ë˜í¼ ë°©ì‹ ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜ â–¼â–¼â–¼

function makeResizable(textarea) {
    if (!textarea || textarea.parentElement.classList.contains('resizable-wrapper')) return;

    // 1. ë³´í˜¸ìš© ë˜í¼(Wrapper) ìƒì„±
    const wrapper = document.createElement('div');
    wrapper.className = 'resizable-wrapper';
    
    // 2. ë˜í¼ë¥¼ ê¸°ì¡´ textarea ìœ„ì¹˜ì— ì‚½ì…
    textarea.parentNode.insertBefore(wrapper, textarea);
    
    // 3. textareaë¥¼ ë˜í¼ ì•ˆìœ¼ë¡œ ì´ë™
    wrapper.appendChild(textarea);

    // 4. í•¸ë“¤(Grip) ìƒì„± ë° ë˜í¼ ì•ˆì— ì¶”ê°€
    const grip = document.createElement('div');
    grip.className = 'resize-grip';
    grip.innerHTML = '<i></i>'; // ì‹œê°ì  ë°”
    wrapper.appendChild(grip);

    // 5. ë“œë˜ê·¸ ë¡œì§ (ëª¨ë°”ì¼/PC ê³µìš©)
    let startY, startHeight;

    const onStart = (e) => {
        // e.preventDefault(); // ì…ë ¥ì°½ í¬ì»¤ìŠ¤ í•´ì œ ë°©ì§€ë¥¼ ìœ„í•´ ì œê±°
        startY = e.touches ? e.touches[0].clientY : e.clientY;
        startHeight = parseInt(window.getComputedStyle(textarea).height, 10);
        
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend', onEnd);
    };

    const onMove = (e) => {
        if(e.touches) e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const delta = clientY - startY;
        
        // ìµœì†Œ 40px ~ ìµœëŒ€ 50vh ì œí•œ
        const newH = Math.min(Math.max(40, startHeight + delta), window.innerHeight * 0.5);
        textarea.style.height = `${newH}px`;
        textarea.style.maxHeight = 'none'; // ê¸°ì¡´ max-height ë¬´ì‹œ
    };

    const onEnd = () => {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onEnd);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onEnd);
    };

    grip.addEventListener('mousedown', onStart);
    grip.addEventListener('touchstart', onStart, { passive: false });
}

/* --- ë©”ì‹œì§€ ë„êµ¬ ê¸°ëŠ¥ (ìˆ˜ì •/ì‚­ì œ/ì±…ê°ˆí”¼) --- */

// [ìˆ˜ì •ë¨] ë©”ì‹œì§€ ë³µì‚¬ (ëª¨ë°”ì¼/HTTP í™˜ê²½ í˜¸í™˜ì„± ê°œì„ )
function copyMessage(index) {
    const chat = DB.chats.find(c => c.id === currentSessionId);
    if (chat && chat.history[index]) {
        const text = chat.history[index].text;
        
        // 1. ìµœì‹  Clipboard API ì‹œë„
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage("ğŸ“‹ ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }).catch(err => {
                console.warn('Clipboard API ì‹¤íŒ¨, í´ë°± ë°©ì‹ ì‹œë„:', err);
                fallbackCopyTextToClipboard(text);
            });
        } else {
            // APIê°€ ì—†ëŠ” êµ¬í˜• ë¸Œë¼ìš°ì € ë“±ì—ì„œëŠ” ë°”ë¡œ í´ë°± ì‹¤í–‰
            fallbackCopyTextToClipboard(text);
        }
    }
}

// [ì‹ ê·œ ì¶”ê°€] ë³µì‚¬ í´ë°± í•¨ìˆ˜ (execCommand ì‚¬ìš©)
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // í™”ë©´ ë°–ìœ¼ë¡œ ë³´ë‚´ì„œ ì•ˆ ë³´ì´ê²Œ ì²˜ë¦¬ (ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ íŠ€ëŠ” í˜„ìƒ ë°©ì§€)
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showMessage("ğŸ“‹ ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            showMessage("âŒ ë³µì‚¬ ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ê¶Œí•œ ì œí•œ)");
        }
    } catch (err) {
        console.error('Fallback copy failed', err);
        showMessage("âŒ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }

    document.body.removeChild(textArea);
}


// 1. ë©”ì‹œì§€ ì‚­ì œ
function deleteMessage(index) {
    if (!confirm('ì´ ë©”ì‹œì§€ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const chat = DB.chats.find(c => c.id === currentSessionId);
    if (chat) {
        chat.history.splice(index, 1); // ë°°ì—´ì—ì„œ í•´ë‹¹ í•­ëª© ì œê±°
        saveData();
        loadSession(currentSessionId); // í™”ë©´ ìƒˆë¡œê³ ì¹¨ (ì¸ë±ìŠ¤ ì¬ì •ë ¬ ìœ„í•´)
    }
}

// 2. ë©”ì‹œì§€ ìˆ˜ì • ëª¨ë“œ ì§„ì…
function enableEditMessage(index) {
    const contentDiv = document.getElementById(`msg-content-${index}`);
    const editorDiv = document.getElementById(`msg-editor-${index}`);
    const textarea = editorDiv.querySelector('textarea');
    const chat = DB.chats.find(c => c.id === currentSessionId);
    
    // í˜„ì¬ í…ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (ë§ˆí¬ë‹¤ìš´ ì›ë³¸)
    textarea.value = chat.history[index].text;
    
    // ë·° ì „í™˜
    contentDiv.classList.add('hidden');
    editorDiv.classList.remove('hidden');
    
    // í•´ë‹¹ ë©”ì‹œì§€ì˜ ë„êµ¬ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ìˆ˜ì • ì¤‘ ë°©í•´ ë°©ì§€)
    const tools = contentDiv.parentElement.querySelector('.msg-tools');
    if(tools) tools.classList.add('hidden');
}

// 3. ë©”ì‹œì§€ ìˆ˜ì • ì €ì¥
function saveEditMessage(index) {
    const editorDiv = document.getElementById(`msg-editor-${index}`);
    const newText = editorDiv.querySelector('textarea').value;
    
    const chat = DB.chats.find(c => c.id === currentSessionId);
    if (chat) {
        chat.history[index].text = newText;
        saveData();
        loadSession(currentSessionId); // ë³€ê²½ì‚¬í•­ ì ìš© ë° ë Œë”ë§
    }
}

// 4. ë©”ì‹œì§€ ìˆ˜ì • ì·¨ì†Œ
function cancelEditMessage(index) {
    const contentDiv = document.getElementById(`msg-content-${index}`);
    const editorDiv = document.getElementById(`msg-editor-${index}`);
    
    contentDiv.classList.remove('hidden');
    editorDiv.classList.add('hidden');
    
    const tools = contentDiv.parentElement.querySelector('.msg-tools');
    if(tools) tools.classList.remove('hidden');
}

// 5. ì±…ê°ˆí”¼ í† ê¸€
function toggleBookmark(index) {
    const chat = DB.chats.find(c => c.id === currentSessionId);
    if (chat) {
        // bookmarked ì†ì„± í† ê¸€
        chat.history[index].bookmarked = !chat.history[index].bookmarked;
        saveData();
        loadSession(currentSessionId); // ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë¦¬ë¡œë“œ
        
        if (chat.history[index].bookmarked) {
            showMessage("ğŸ”– ì±…ê°ˆí”¼ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }
}

// ì±…ê°ˆí”¼ ì´ë¦„ ìˆ˜ì • ê¸°ëŠ¥
function editBookmarkName(index) {
    const chat = DB.chats.find(c => c.id === currentSessionId);
    if (!chat) return;

    const msg = chat.history[index];
    // ê¸°ì¡´ ì´ë¦„ì´ ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ê³  ì—†ìœ¼ë©´ ë¹ˆ ê°’
    const currentName = msg.bookmarkName || ""; 
    
    const newName = prompt("ì±…ê°ˆí”¼ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ë¹„ì›Œë‘ë©´ ìˆ¨ê¹€):", currentName);
    
    // ì·¨ì†Œ ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì €ì¥
    if (newName !== null) {
        msg.bookmarkName = newName.trim();
        saveData();
        renderRightSidebar(); // ì‚¬ì´ë“œë°” ê°±ì‹ 
    }
}


// [ë³€ê²½] ì±…ê°ˆí”¼ ë¡œë“œ (ê¸°ì¡´ ì„¸ì…˜ ìœ ì§€ + ìƒˆ ì„¸ì…˜ ë¶„ê¸° ìƒì„±)
function loadBookmark(index) {
    const chat = DB.chats.find(c => c.id === currentSessionId);
    if (!chat) return;

    // í˜„ì¬ ë§ˆì§€ë§‰ ì‹œì ì´ë¼ë©´ êµ³ì´ ë³µì‚¬í•  í•„ìš” ì—†ìŒ
    if (index === chat.history.length - 1) {
        showMessage("ì´ë¯¸ í˜„ì¬ ì‹œì ì…ë‹ˆë‹¤.");
        return;
    }

    if (confirm(`ğŸ”– [Turn ${index + 1}] ì‹œì ì—ì„œ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- í˜„ì¬ ì„¸ì…˜ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.\n- ì„ íƒí•œ ì‹œì ê¹Œì§€ì˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ìƒˆ ì„¸ì…˜ì´ ìƒì„±ë©ë‹ˆë‹¤.`)) {
        
        // 1. í˜„ì¬ ì„¸ì…˜ ê°ì²´ë¥¼ í†µì§¸ë¡œ ê¹Šì€ ë³µì‚¬ (Deep Copy)
        // ì°¸ì¡° ê´€ê³„ë¥¼ ëŠê¸° ìœ„í•´ JSON ë³€í™˜ ë°©ì‹ ì‚¬ìš©
        const newChat = JSON.parse(JSON.stringify(chat));
        
        // 2. ìƒˆ ì„¸ì…˜ ì •ë³´ ì„¤ì •
        newChat.id = Date.now().toString(); // ìƒˆ ID ë°œê¸‰
        newChat.title = `${chat.title} (ë¶„ê¸° ${index + 1})`; // ì œëª©ì— ë¶„ê¸° í‘œì‹œ
        
        // 3. íˆìŠ¤í† ë¦¬ë¥¼ í•´ë‹¹ ì‹œì ê¹Œì§€ë§Œ ë‚¨ê¸°ê¸° (0 ~ index)
        newChat.history = newChat.history.slice(0, index + 1);
        
        // 4. DB ìµœìƒë‹¨ì— ì¶”ê°€
        DB.chats.unshift(newChat);
        
        // 5. ì €ì¥ ë° í™”ë©´ ì „í™˜
        saveData();
        renderSidebar(); // ì‚¬ì´ë“œë°” ëª©ë¡ ê°±ì‹ 
        loadSession(newChat.id); // ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ì´ë™
        
        showMessage("ğŸ”€ ìƒˆë¡œìš´ íƒ€ì„ë¼ì¸ìœ¼ë¡œ ë¶„ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // ëª¨ë°”ì¼ì—ì„œëŠ” ì‚¬ì´ë“œë°” ë‹«ê¸°
        if(window.innerWidth < 768) closeAllSidebars();
    }
}

        const aiGeneratorConfig = {
            users: {
                sections: [
                    { title: 'ì„±ë³„', singleChoice: true, tags: ['ë‚¨ì„±', 'ì—¬ì„±', 'ì¤‘ì„±/ë¬´ì„±'], level: 1 },
                    { title: 'ë‚˜ì´ëŒ€', singleChoice: true, tags: ['20ëŒ€', '30ëŒ€', '40ëŒ€', '50ëŒ€ ì´ìƒ', 'ë‚˜ì´ ë¯¸ìƒ'], level: 1 },
                    { title: 'ìŠ¤íƒ€ì¼', singleChoice: false, tags: ['ë¯¸ì†Œë…„', 'ë¯¸ì²­ë…„', 'í›ˆë‚¨', 'í‰ë²”í•¨', 'ê·€ì—¼ìƒ', 'ë‚ ì¹´ë¡œì›€', 'ì¤‘í›„í•¨', 'ë³‘ì•½í•¨', 'ë“¬ì§í•¨', 'ì–‘ì•„ì¹˜', 'ì•„ì €ì”¨', 'í‘ì¸', 'ê±°êµ¬', 'ì•¼ì„±ë¯¸', 'ì‘ì€ í‚¤', 'ì•¼ë§Œì¡±', 'í¨ë³´ì´(ì´ì„±ì• ì)'], level: 1 },
                    { title: 'ì„±ê²©', singleChoice: false, tags: ['ì •ì˜ë¡œì›€', 'ëƒ‰ì² í•¨', 'ì†Œì‹¬í•¨', 'ëŒ€ë²”í•¨', 'ëŠ¥ê¸€ë§ìŒ', 'ë‹¤ì •í•¨', 'ê´‘ê¸°', 'ì´ê¸°ì ', 'ê»„ë í•¨', 'ê³¼ë¬µí•¨', 'ì–´ë‘ìš´(ìŒì¹¨/ì°ë”°)', 'ì„±ìš•ì´ ë„˜ì¹˜ëŠ”', 'ë‚œë´‰ê¾¼', 'ì‚¬ë‘ê¾¼', 'ìˆœì§„í•œ', 'ì„±ì— ë¬´ì§€í•¨'], level: 2 },
                    { title: 'íŠ¹ìˆ˜ ëŠ¥ë ¥', singleChoice: false, tags: ['ì ˆëŒ€ ë§¤ë ¥', 'ë…ì‹¬ìˆ ', 'ìµœë©´', 'íˆ¬ì‹œ', 'ì‹œê°„ ì •ì§€', 'í…Œí¬ë‹‰ ì¢‹ìŒ', 'ì„±ê°ëŒ€ í¬ì°©', 'ê±°ê·¼', 'ì •ì•¡ ë¬´ì œí•œ', 'ì ˆë¥œí•œ ì •ë ¥'], level: 3 },
                ]
            },
            chars: {
                tabs: [
                    {
                        name: 'ê¸°ë³¸/ì™¸í˜•',
                        icon: 'fa-id-card',
                        sections: [
                             { title: 'ì„±ë³„', singleChoice: true, tags: ['ì—¬ì„±', 'ë‚¨ì„±', 'ì¤‘ì„±/í›„íƒ€ë‚˜ë¦¬'], level: 1 },
                             { title: 'ë‚˜ì´ëŒ€', singleChoice: true, tags: ['20ëŒ€', '30ëŒ€', '40ëŒ€', 'ë‚˜ì´ ë¯¸ìƒ'], level: 1 },
                             { title: 'ì§ì—…/ì—­í• ', singleChoice: false, tags: ['ëŒ€í•™ìƒ', 'ì•„ì´ëŒ', 'íšŒì‚¬ì›', 'ê°„í˜¸ì‚¬', 'ì—¬êµì‚¬', 'ê°€ì •êµì‚¬', 'ê³¼ì™¸ ì„ ìƒ', 'ë¹„ì„œ', 'ë©”ì´ë“œ', 'ê¸°ì‚¬', 'ê³µì£¼/ì—¬ì™•', 'ìˆ˜ë…€', 'ì„±ë…€', 'ë¬´ë…€', 'ëª¨í—˜ê°€', 'ë§ˆì™•', 'ìš©ì‚¬', 'ë…¸ì˜ˆìƒì¸', 'ì•”ì‚´ì', 'ìŠ¤íŠ¸ë¦¬ë¨¸', 'ì¸ê°„ ê°€ì¶•'], level: 2 },
                             { 
                                 title: 'ì¢…ì¡±', 
                                 id: 'race-section',
                                 singleChoice: true, 
                                 tags: ['ì¸ê°„', 'ì—˜í”„', 'ë‹¤í¬ì—˜í”„', 'ë“œì›Œí”„', 'ì˜¤í¬', 'ê³ ë¸”ë¦°', 'í•˜í”Œë§', 'í˜ì–´ë¦¬', 'ì•ˆë“œë¡œì´ë“œ', 'ì‚¬ì´ë³´ê·¸', 'ë±€íŒŒì´ì–´', 'ì„œíë²„ìŠ¤', 'ë§ˆì¡±', 'ì²œì‚¬', 'íƒ€ë½ì²œì‚¬', 'ìš©ì¡±', 'ì—¬ì‹ ', 'ìˆ˜ì¸', 'ì˜¤ë‹ˆ', 'ì•¼ë§Œì¡±'], 
                                 level: 1 
                             },
                             { 
                                 title: 'ìˆ˜ì¸ ìƒì„¸ ì¢…ë¥˜', 
                                 id: 'beast-detail-section',
                                 singleChoice: true, 
                                 tags: ['ê°œ ìˆ˜ì¸', 'ê³ ì–‘ì´ ìˆ˜ì¸', 'ì—¬ìš° ìˆ˜ì¸', 'í† ë¼ ìˆ˜ì¸', 'ì –ì†Œ ìˆ˜ì¸', 'ë§ ìˆ˜ì¸', 'í‘œë²” ìˆ˜ì¸', 'í˜¸ë‘ì´ ìˆ˜ì¸', 'ì‚¬ì ìˆ˜ì¸', 'ê³° ìˆ˜ì¸', 'ë¼ì§€ ìˆ˜ì¸', 'ì¥ ìˆ˜ì¸', 'ë±€ ìˆ˜ì¸', 'ìƒˆ ìˆ˜ì¸'], 
                                 level: 1,
                                 hidden: true 
                             },
                             { title: 'í”¼ë¶€ìƒ‰', singleChoice: true, tags: ['í•˜ì–€ í”¼ë¶€', 'ê°ˆìƒ‰ í”¼ë¶€', 'ë³µìˆ­ì•„ìƒ‰ í”¼ë¶€', 'ìˆ˜ì˜ë³µ ìêµ­', 'íƒœë‹ í”¼ë¶€', 'ì°½ë°±í•œ í”¼ë¶€'], level: 1 },
                             { title: 'ì²´í˜•/ëª¸ë§¤', singleChoice: false, tags: ['ìŠ¬ë Œë”', 'ìš´ë™ë…€', 'ìœ¡ë•', 'ìˆìŠ¤íƒ', 'ê°€ëŠ” í—ˆë¦¬', 'í„°ì§ˆ ë“¯í•œ ì—‰ë©ì´', 'í„°ì§ˆ ë“¯í•œ í—ˆë²…ì§€', 'ëª¨ë¸ ì²´í˜•', 'ê¸€ë˜ë¨¸', 'ì•„ë‹´í•¨', 'ì¥ì‹ ', 'ê³¨ë°˜ë¯¸ë…€', 'ìœ ì•„ ì²´í˜•'], level: 1 },
                             { title: 'ê°€ìŠ´ í¬ê¸°', singleChoice: true, tags: ['ë¹ˆìœ ', 'í‰ë²”', 'ê±°ìœ ', 'í­ìœ '], level: 1 },
                             { title: 'ëˆˆë§¤', singleChoice: true, tags: ['ë™ê·¸ë€ ëˆˆ', 'ì²˜ì§„ ëˆˆ', 'ì˜¬ë¼ê°„ ëˆˆ', 'ì¡¸ë¦° ëˆˆ', 'ì‚¼ë°±ì•ˆ', 'ì£½ì€ ëˆˆ', 'í•˜íŠ¸ ëˆˆ'], level: 1 },
                             { title: 'ë¨¸ë¦¬ì¹¼(í—¤ì–´)', singleChoice: false, tags: ['ê¸´ ìƒë¨¸ë¦¬', 'ì›¨ì´ë¸Œ', 'í¬ë‹ˆí…Œì¼', 'íŠ¸ìœˆí…Œì¼', 'ë•‹ì€ ë¨¸ë¦¬', 'ë‹¨ë°œ', 'ìˆì»·', 'ê¸ˆë°œ', 'í‘ë°œ', 'ì€ë°œ', 'ì ë°œ', 'ì²­ë°œ', 'ë¶„í™ ë¨¸ë¦¬'], level: 1 },
                             { title: 'ìŠ¤íƒ€ì¼', singleChoice: false, tags: ['ë¯¸ì†Œë…€', 'ê·€ì—¼ìƒ', 'ì²­ìˆœê°€ë ¨', 'ì•„ì´ëŒ ìŠ¤íƒ€ì¼', 'ëƒ‰ë¯¸ë…€', 'ì§€ì ì„', 'ë„ë„í•¨', 'í™”ë ¤í•¨', 'ëª¨ë¸ í¬ìŠ¤', 'ê¸€ë˜ë¨¸/ì„¹ì‹œ', 'í‡´íë¯¸', 'ë³‘ì•½í•¨', 'ìŒì¹¨í•¨', '4ì°¨ì›', 'í†°ë³´ì´', 'í‰ë²”ë…€', 'ì‘ì€ í‚¤'], level: 1 },
                             { title: 'ì˜ìƒ/ì½”ìŠ¤íŠ¬', singleChoice: false, tags: ['ì—­ë°”ë‹ˆ', 'ë©”ì´ë“œë³µ', 'ë°”ë‹ˆê±¸', 'êµë³µ', 'ê°„í˜¸ì‚¬ë³µ', 'ìˆ˜ì˜ë³µ(ë¹„í‚¤ë‹ˆ)', 'ë€ì œë¦¬ ë£©', 'ì˜¤í”¼ìŠ¤ë£©', 'ë“œë ˆìŠ¤', 'ì°¨ì´ë‚˜ ë“œë ˆìŠ¤', 'ë¬´ë…€ë³µ', 'ì²´ìœ¡ë³µ'], level: 2 },
                             { title: 'ì•¡ì„¸ì„œë¦¬', singleChoice: false, tags: ['ì•ˆê²½', 'ë¨¸ë¦¬ë ', 'ë¦¬ë³¸', 'ì•ˆëŒ€', 'ë§ˆìŠ¤í¬', 'ì´ˆì»¤', 'ëˆˆë¬¼ì ', 'ì£¼ê·¼ê¹¨', 'ë¶•ëŒ€'], level: 3 },
                             { title: 'í”¼ì–´ì‹±', singleChoice: false, tags: ['ê·€ í”¼ì–´ì‹±', 'ì½”/ì…ìˆ  í”¼ì–´ì‹±', 'í˜€ í”¼ì–´ì‹±', 'ìœ ë‘ í”¼ì–´ì‹±', 'ë°°ê¼½ í”¼ì–´ì‹±', 'ìŒìˆœ/í´ë¦¬í† ë¦¬ìŠ¤ í”¼ì–´ì‹±'], level: 3 },
                             { title: 'ë¬¸ì‹ ', singleChoice: false, tags: ['ê°€ìŠ´/ì‡„ê³¨ ë¬¸ì‹ ', 'ë“±/ì²™ì¶” ë¬¸ì‹ ', 'íŒ”/ë‹¤ë¦¬ ë¬¸ì‹ ', 'í•˜ë³µë¶€ ë¬¸ì‹ (ìê¶ ë¬¸ì‹ )', 'ì—‰ë©ì´ ë¬¸ì‹ ', 'ìœ ë¥œ ë¬¸ì‹ ', 'ë…¸ì˜ˆ ë‚™ì¸'], level: 3 },
                        ]
                    },
                    {
                        name: 'ì„±ê²©/ì •ì‹ ',
                        icon: 'fa-brain',
                        sections: [
                            { title: 'ì£¼ì¸ê³µê³¼ì˜ ê´€ê³„', singleChoice: false, tags: ['ì†Œê¿‰ì¹œêµ¬', 'ì²«ì‚¬ë‘', 'ì§ì‚¬ë‘', 'ì „ì—¬ì¹œ', 'ì•½í˜¼ì/ì¸ë…€', 'ì—¬ë™ìƒ', 'ëˆ„ë‚˜', 'ì—„ë§ˆ', 'ì´ëª¨/ê³ ëª¨', 'ë”¸', 'ë¹„í˜ˆì—° ê°€ì¡±(ì˜ë¶“)', 'í•™êµ ì„ ë°°', 'í•™êµ í›„ë°°', 'ë™ê¸‰ìƒ/ì¹œêµ¬', 'ì„ ìƒë‹˜/ì œì', 'ì§ì¥ ìƒì‚¬/ë¶€í•˜', 'ë¼ì´ë²Œ/ì•™ìˆ™', 'ê°‘ì„ ê´€ê³„(ë…¸ì˜ˆ/ì£¼ì¸)', 'ìœ ë¶€ë…€/ë°€í”„', 'ì§€ì¸ì˜ ì—°ì¸/ì•„ë‚´', 'ì´ˆë©´/ë‚¨ë‚¨'], level: 2 },
                            { title: 'ìºë¦­í„° ì†ì„±(ì•„í‚¤íƒ€ì…)', singleChoice: false, tags: ['ì¬ë²Œ ì˜ì• (ì•„ê°€ì”¨)', 'í•™êµì˜ ì•„ì´ëŒ', 'ë°˜ì¥/ëª¨ë²”ìƒ', 'ë¶ˆëŸ‰ì†Œë…€(ì¼ì§„)', 'ê°¸ë£¨', 'íˆí‚¤ì½”ëª¨ë¦¬', 'ì˜¤íƒ€ì¿ /ë„ˆë“œ', 'ë³´ì´ì‹œ', '4ì°¨ì›/ì „íŒŒê³„', 'ëœë ì´', 'ìš´ë™ê³„', 'ë¬¸í•™ì†Œë…€', 'ë³‘ì•½í•¨', 'ì¤‘2ë³‘', 'ì™¸êµ­ì¸/ìœ í•™ìƒ'], level: 2 },
                            { title: 'ì„±ê²© í‚¤ì›Œë“œ', singleChoice: false, tags: ['ì• êµìˆëŠ”', 'ì¸¤ë°ë ˆ', 'ì–€ë°ë ˆ', 'ì¿¨ë°ë ˆ', 'ë©”ê°€ë°ë ˆ', 'ìˆœì¢…ì ', 'í—Œì‹ ì (ì¶©ê²¬)', 'ë„ë„í•¨/ì½§ëŒ€ ë†’ìŒ', 'ì†Œì•…ë§ˆ', 'ì²œì—°/ë°±ì¹˜ë¯¸', 'ìŒì¹¨í•¨(ì°ë”°)', 'ì†Œì‹¬í•¨', 'ì„±ìš•ì´ ë„˜ì¹˜ëŠ”', 'ê³ ì••ì ì¸/ì—¬ì™•', 'ë„ë°œì ì¸', 'ëƒ‰ì² í•¨/ì´ì„±ì ', 'ë‹¤ì •í•¨/í¬ìš©ë ¥', 'ì‹¸ê°€ì§€ ì—†ìŒ', 'ê³¼ë¬µí•¨', 'ì² ë²½ë…€', 'ì• ì •ê²°í•', 'ë§ˆì´í˜ì´ìŠ¤', 'ë§ìƒë²½', 'ìˆœì§„í•œ', 'ì„±ì— ë¬´ì§€í•¨'], level: 2 },
                            { title: 'ë§íˆ¬/ëª©ì†Œë¦¬', singleChoice: false, tags: ['í•´ìš”ì²´', 'í•˜ì‹­ì‹œì˜¤ì²´', 'ìŠ´ë‹¤ì²´', 'ì¹œê·¼í•œ ë°˜ë§', 'í•˜ëŒ€í•˜ëŠ”', 'ê°¸ë£¨ ë§íˆ¬', 'ì•„ê°€ì”¨ ë§íˆ¬', 'ë‹¨ë‹µí˜•', 'ë§ë”ë“¬ìŒ', 'ë‚˜ë¥¸í•œ', 'ì†ì‚­ì´ëŠ”', 'ìš•ìŸì´', 'ì‚¬íˆ¬ë¦¬'], level: 2 }
                        ]
                    },
                    {
                        name: 'ì„±ì  ì„¤ì •',
                        icon: 'fa-heart',
                        sections: [
                            { title: 'ì„±ì  ì„±í–¥', singleChoice: false, tags: ['ê²½í—˜ ì—†ìŒ(ì²˜ë…€)', 'ê²½í—˜ ë§ìŒ', 'ìì§€ ìˆ­ë°°', 'í‘ì¸ ìˆ­ë°°', 'Mì„±í–¥', 'Sì„±í–¥', 'ë´‰ì‚¬ ì •ì‹ ', 'ì§ˆë‚´ì‚¬ì • ì„ í˜¸', 'ì• ë„ ì„ í˜¸', 'ë”¥í‚¤ìŠ¤ ì„ í˜¸', 'ìƒ‰ë…€/ì¹˜ë…€', 'ë…¸ì¶œê´‘', 'ê³µì¤‘ë³€ì†Œ', 'í—ˆì ‘ë³´ì§€', 'í•¨ëª°ìœ ë‘'], level: 3 },
                            { title: 'í˜í‹°ì‹œ/ì·¨í–¥', singleChoice: false, tags: ['ëƒ„ìƒˆ í˜í‹°ì‹œ', 'êµ´ìš•/ìˆ˜ì¹˜ì‹¬', 'ì •ì•¡ ì¤‘ë…', 'êµ¬ì†/ì†ë°•', 'ë„êµ¬ ì‚¬ìš©', 'ì•¼ì™¸ ë…¸ì¶œ', 'ìˆ˜ë©´ ê°„', 'ê±°ìš¸ ë³´ê¸°', 'ë”í‹° í† í¬'], level: 3 },
                            { title: 'ì„±ê°ëŒ€', singleChoice: true, tags: ['ê·€', 'ëª©ëœë¯¸', 'ì‡„ê³¨', 'ë¯¼ê°í•œ ê°€ìŠ´/ìœ ë‘', 'ë“±/ì²™ì¶”', 'ë°°/ë°°ê¼½', 'ì—‰ë©ì´', 'í—ˆë²…ì§€ ì•ˆìª½', 'í´ë¦¬í† ë¦¬ìŠ¤/ìŒìˆœ', 'ì§ˆ ë‚´ë²½(GìŠ¤íŒŸ)', 'í•­ë¬¸'], level: 3 },
                            { title: 'ì†ì˜· ìŠ¤íƒ€ì¼', singleChoice: false, tags: ['ë©´ íŒ¬í‹°', 'ë…¸íŒ¬í‹°', 'TíŒ¬í‹°', 'ê°€í„°ë²¨íŠ¸', 'ì˜¤í”ˆí˜• ì†ì˜·'], level: 3 },
                            { title: 'ìŒëª¨/í„¸', singleChoice: true, tags: ['ë°±ë³´ì§€(ë¬´ëª¨)', 'ë‚´ì¶”ëŸ´(ìˆ˜ë¶í•¨)', 'ê¹”ë”í•˜ê²Œ ë‹¤ë“¬ìŒ', 'í•˜íŠ¸ ëª¨ì–‘', 'í™œì£¼ë¡œ(Iì)', 'ì‘ì€ ì‚¼ê°í˜•', 'ë¸Œë¼ì§ˆë¦¬ì–¸ ì™ì‹±'], level: 3 },
                            { title: 'íŠ¹ìˆ˜ ìƒíƒœ', singleChoice: false, tags: ['ì„ì‹  ì¤‘', 'ë°°ë€ê¸°', 'ëª¨ìœ  ìˆ˜ìœ ', 'ì•½ë¬¼ ì¤‘ë…', 'ìµœë©´/ì„¸ë‡Œ', 'íƒ€ë½í•¨', 'ë…¸ì˜ˆ ê°ì¸', 'í« ì·¨ê¸‰', 'ì´ì¤‘ì¸ê²©', 'ì¸ì²´ê°œì¡°', 'ì‹ ì²´ ê²°ì†', 'ë°œì •ê¸°'], level: 3 }
                        ]
                    }
                ]
            },
            worlds: {
                 sections: [
                    { title: 'í•µì‹¬ ì¥ë¥´', singleChoice: true, tags: ['í˜„ëŒ€/ì¼ìƒ', 'íŒíƒ€ì§€/ì´ì„¸ê³„', 'ì•„ì¹´ë°ë¯¸/í•™ì›', 'í—Œí„°/ê²Œì´íŠ¸', 'ë¬´í˜‘/ë™ì–‘í’', 'SF/ì‚¬ì´ë²„í‘í¬', 'ì•„í¬ì¹¼ë¦½ìŠ¤/ìƒì¡´', 'ì •ì¡°ì—­ì „/ë‚¨ë…€ì—­ì „', 'ì—°ì˜ˆê³„/ë§¤ë‹ˆì§€ë¨¼íŠ¸', 'ì¸í„°ë„· ë°©ì†¡(ì¸ë°©)', 'ìœ í¥ê°€/í™”ë¥˜ê³„', 'ì‹œê³¨/ì´Œêµ¬ì„'], level: 1 },
                    { title: 'ë„ì…ë¶€ ìƒí™©/í´ë¦¬ì…°', singleChoice: true, tags: ['ì„¹ìŠ¤í•´ì•¼ ì—´ë¦¬ëŠ” ë°©', 'ìµœë©´/ìƒì‹ê°œë³€', 'ì‹œê°„ ì •ì§€', 'ìƒíƒœì°½/í€˜ìŠ¤íŠ¸', 'íˆ¬ëª… ì¸ê°„', 'ìµœìŒì œ/ì•½ë¬¼', 'ìˆ˜ë©´ ê°„', 'ë¹™ì˜/í™˜ìƒ', 'ë§¤ë‹ˆì €/ê²½í˜¸ì›', 'ë¹„ë°€ ìˆ˜ì—…/ê³¼ì™¸', 'ì•½ì  ì¡í˜/í˜‘ë°•', 'ë¹š/ë…¸ì˜ˆ ê³„ì•½', 'ë™ê±° ì‹œì‘', 'ìš´ëª…ì  ì¬íšŒ', 'ìˆ ê¹€ì— ì‹¤ìˆ˜', 'ì½”ì¹˜/íŠ¸ë ˆì´ë„ˆ', 'ì—¬ìë§Œ ì‚¬ëŠ” ì§‘, ì•„íŒŒíŠ¸'], level: 1 },
                    { title: 'ê´€ê³„ ì£¼ë„ê¶Œ', singleChoice: true, tags: ['ìœ ì € ì ˆëŒ€ ìš°ìœ„', 'ìºë¦­í„° ìš°ìœ„', 'ëŒ€ë“±í•œ ê´€ê³„', 'ìƒí˜¸ ì˜ì¡´/ê³µë²”', 'í˜ê´€(ì• ì¦)'], level: 1 }, 
                    { title: 'ë¶„ìœ„ê¸°/íƒœê·¸', singleChoice: false, tags: ['ìˆœì• /ë‹¬ë‹¬í•¨', 'í•˜ë“œì½”ì–´/ëŠ¥ìš•', 'íƒ€ë½/ì•”íƒ€', 'í”¼ì¹´ë ˆìŠ¤í¬', 'í•˜ë ˜', 'ê°œê·¸/ì½”ë¯¹', 'ì‹œë¦¬ì–´ìŠ¤/í”¼í', 'í‡´íì /ëŠì™€ë¥´', 'NTR/ë„¤í† ë¦¬'], level: 2 },
                ]
            }
        };

        const DB = { chats: [], worlds: [] }; 
        const SETTINGS = { 
            apiKey: '', 
            coreRules: [], 
            dicRules: [], 
            globalLorebook: [], 
            temperature: 0.9, 
            typingSpeed: 15,
            currentModel: 'gemini-3-pro',
            uncensored: true,
            fontSize: 16,
            novelViewpoint: '3ì¸ì¹­ ì œí•œì  ì‹œì  (ì¶”ì²œ)',
            novelStyle: 'ì›¹ì†Œì„¤ì²´',
            novelRatio: 'ë°¸ëŸ°ìŠ¤í˜•'
        };

// â–¼â–¼â–¼ [ì‹ ê·œ] 1ë‹¨ê³„: íƒ­ ìƒíƒœ ë³€ìˆ˜ ì¶”ê°€ â–¼â–¼â–¼
        let currentRightTab = 'tools'; 
        // â–²â–²â–² [ì‹ ê·œ] ë â–²â–²â–²

const AUTO_EVENT_DEFINITIONS = [
            { title: "ìœ„ê¸° ì¡°ì„± (The Risk)", content: "í˜„ì¬ ì¥ì†Œì™€ ìƒí™©ì„ ë¶„ì„í•˜ì—¬, ì œ3ìì—ê²Œ ë°œê°ë˜ê±°ë‚˜ ì†Œë¦¬ê°€ ìƒˆì–´ ë‚˜ê°ˆ 'ìœ„ê¸° ìƒí™©'ì„ ì¡°ì„±í•˜ì‹œì˜¤. ë¬¼ë¦¬ì  ê°œì…(ë°œì†Œë¦¬, ì¸ê¸°ì²™, ë…¸í¬, ì „í™”ë²¨ ë“±)ì„ í†µí•´ ê¸´ì¥ê°ì„ ê·¹ëŒ€í™”í•˜ê³  ìºë¦­í„°ë¥¼ ë‹¹í™©í•˜ê²Œ ë§Œë“œì‹œì˜¤." },
            { title: "ì‹ ì²´ ë°°ì‹  (Loss of Control)", content: "ìºë¦­í„°ì˜ ì˜ì§€ì™€ ë¬´ê´€í•œ ì‹ ì²´ì  ë°˜ì‘ì„ ì§‘ì¤‘ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì‹œì˜¤. ì°¸ìœ¼ë ¤ í•´ë„ í„°ì ¸ ë‚˜ì˜¤ëŠ” êµì„±, ë‹¤ë¦¬ì˜ ê²½ë ¨, í˜¹ì€ ìƒë¦¬ì  í˜„ìƒ ë“± ëª¸ì´ ì´ì„±ì„ ë°°ì‹ í•˜ê³  ë©‹ëŒ€ë¡œ ë°˜ì‘í•˜ëŠ” ìƒí™©ì„ ê°•ì œë¡œ ì—°ì¶œí•˜ì‹œì˜¤." },
            { title: "ì‹¬ë¦¬ ë¶•ê´´ (Corruption)", content: "ìˆ˜ì¹˜ì‹¬ì´ë‚˜ ì €í•­ê°ì´ ì„ê³„ì ì„ ë„˜ì–´ 'ì¾Œë½'ì´ë‚˜ 'ì²´ë…'ìœ¼ë¡œ ì „í™˜ë˜ëŠ” ì‹¬ë¦¬ì  ë¶•ê´´(Ahegao state)ë¥¼ ì„œìˆ í•˜ì‹œì˜¤. ìºë¦­í„°ê°€ ìˆœê°„ì ìœ¼ë¡œ ì´ì„±ì„ ìƒê³  í‰ì†Œë¼ë©´ ì ˆëŒ€ í•˜ì§€ ì•Šì„ ê³¼ê°í•œ í–‰ë™ì´ë‚˜ ëŒ€ì‚¬ë¥¼ í•˜ë„ë¡ ìœ ë„í•˜ì‹œì˜¤." },
            { title: "í™˜ê²½ ë³€ìˆ˜ (Malfunction)", content: "ì£¼ë³€ ì‚¬ë¬¼ì´ë‚˜ í™˜ê²½ì´ ìºë¦­í„°ë¥¼ ë•ì§€ ì•Šê³  ê³¤ë€í•˜ê²Œ ë§Œë“œëŠ” ìƒí™©ì„ ì—°ì¶œí•˜ì‹œì˜¤. (ì˜ˆ: ì¢ì€ ê³µê°„, ì¡°ëª…ì˜ ë³€í™”, ì˜·ì´ ì–´ë”˜ê°€ì— ê±¸ë¦¼, ë„êµ¬ì˜ ì˜¤ì‘ë™, ë¬¸ì´ ì ê¸°ì§€ ì•ŠìŒ ë“±)" }
        ];
        
        const STORAGE_KEY = 'novel_ai_data_main'; 
        const SETTINGS_KEY = 'novel_ai_settings_main';

let lastSentPrompt = ""; // ë””ë²„ê¹…ìš©: ë§ˆì§€ë§‰ ì „ì†¡ëœ í”„ë¡¬í”„íŠ¸ ì €ì¥
let lastTokenUsage = null; // ì‹¤ì œ í† í° ì‚¬ìš©ëŸ‰ ì €ì¥ìš©

        let currentTab = 'chats';
        let currentSessionId = null;

        // [ë³€ê²½] ìƒíƒœ ë³€ìˆ˜ ë¶„ë¦¬
        let isTextGenerating = false;   // í…ìŠ¤íŠ¸(ì±„íŒ…) ìƒì„± ì¤‘
        let isGenerating = false; // (ë ˆê±°ì‹œ/ëª¨ë‹¬ìš©) - ëª¨ë‹¬ ìƒì„±ì‹œ ì‚¬ìš©ë¨

        let textAbortController = null; // í…ìŠ¤íŠ¸ ìƒì„± ì·¨ì†Œìš©
        let currentAbortController = null; // ëª¨ë‹¬ ìƒì„±ìš© (í†µí•© ì»¨íŠ¸ë¡¤ëŸ¬)

        let isCancellationRequested = false;
        let typingQueue = [];
        let isTyping = false;
        let currentMsgElement = null;
        let activeTextareaTarget = null;
        let isNewSessionMode = false;
        let isDirectorMode = false; 
        let selectedWorldId = null;
        let isDetailGenCancelled = false;

function init() {
            // 1. ë‹¤í¬ëª¨ë“œ ì´ˆê¸°í™”
            const savedDark = localStorage.getItem('novel_ai_dark_mode');
            const toggle = document.getElementById('dark-mode-toggle');
            if (savedDark === 'true') {
                document.documentElement.classList.add('dark');
                if(toggle) toggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                if(toggle) toggle.checked = false;
            }

            // 2. ë§ˆí¬ë‹¤ìš´ ì„¤ì •
            marked.setOptions({
                breaks: true,
                gfm: true
            });

            // 3. ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸° í™”ë©´ ì„¤ì •
            loadData(); loadSettings();
            switchNav('chats');
            
            // 4. ì—”í„°í‚¤ ì „ì†¡ ì´ë²¤íŠ¸
            document.getElementById('msg-input').addEventListener("keydown", (e) => {
                if(window.innerWidth < 768) return; 
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });

            renderRightSidebar();
            applyFontSize(SETTINGS.fontSize);
            
            const modelDisplay = document.getElementById('model-display');
            if(modelDisplay) modelDisplay.innerText = 'Model: ' + (SETTINGS.currentModel || 'gemini-3-pro');
            
            switchCoreTab('api'); 

            // 5. í€µ ìŠ¤íƒ€íŠ¸ (ì„¸ì…˜ ì—†ì„ ë•Œ ì…ë ¥ì°½ ë³´ì´ê¸°)
            if (!currentSessionId) {
                const inputArea = document.getElementById('input-area');
                const msgInput = document.getElementById('msg-input');
                if(inputArea) {
                    inputArea.classList.remove('hidden');
                    inputArea.classList.add('flex');
                }
                if(msgInput) msgInput.placeholder = "ì…ë ¥í•˜ê¸°";
            }

            // 6. í† í° ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ì—°ê²°
            const slider = document.getElementById('core-max-token-slider');
            if(slider) {
                slider.addEventListener('input', function(e) {
                    document.getElementById('core-max-token-val').innerText = e.target.value;
                });
            }
        }


// [ì‹ ê·œ] í¼ ì œì¶œ í†µí•© í•¸ë“¤ëŸ¬ (ì—”í„°í‚¤ or ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
function handleFormSubmit() {
    if (isTextGenerating) {
        // ìƒì„± ì¤‘ì´ë©´ -> ì¤‘ë‹¨ ê¸°ëŠ¥ ìˆ˜í–‰
        cancelGeneration();
    } else {
        // ëŒ€ê¸° ì¤‘ì´ë©´ -> ë©”ì‹œì§€ ì „ì†¡ ìˆ˜í–‰
        sendMessage();
    }
}

// [ì‹ ê·œ ê¸°ëŠ¥] ë²„íŠ¼ ìƒíƒœ ë³€ê²½ í•¨ìˆ˜ (ì „ì†¡ â†” ì •ì§€)
function updateSendButtonState(state) {
    const btn = document.getElementById('send-btn');
    if (!btn) return;

if (state === 'generating') {
        // ìƒì„± ì¤‘: íŒŒë€ìƒ‰ ë°°ê²½ + í•˜ì–€ìƒ‰ ìŠ¤í”¼ë„ˆ(ëº‘ëº‘ì´)
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        
        // ë¹¨ê°„ìƒ‰ ìƒ‰ìƒ ì œê±° (íŒŒë€ìƒ‰ ìœ ì§€)
        btn.classList.remove('bg-red-500', 'hover:bg-red-600');
        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        
        // (ì„ íƒ ì‚¬í•­) ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œë§Œ 'ì •ì§€' ì•„ì´ì½˜ ë³´ì—¬ì£¼ê¸°
        // btn.title = "í´ë¦­í•˜ì—¬ ìƒì„± ì¤‘ë‹¨";
    } else {
        // ëŒ€ê¸° ì¤‘ì¼ ë•Œ: íŒŒë€ìƒ‰ ì „ì†¡ ë²„íŠ¼
        btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
        btn.classList.remove('bg-red-500', 'hover:bg-red-600');
        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }
}

// [ì‹ ê·œ ê¸°ëŠ¥] í¼ ì œì¶œ í†µí•© í•¸ë“¤ëŸ¬
function handleFormSubmit() {
    if (isTextGenerating) {
        cancelGeneration(); // ìƒì„± ì¤‘ì´ë©´ ë©ˆì¶¤
    } else {
        sendMessage(); // ì•„ë‹ˆë©´ ì „ì†¡
    }
}        
        function cancelDetailGeneration() {
            isDetailGenCancelled = true;
            if(currentAbortController) currentAbortController.abort(); 
            document.getElementById('modal-loading-overlay-details').classList.add('hidden');
            document.getElementById('modal-loading-overlay-details').classList.remove('flex');
            showMessage("ì„¤ì • ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        
        function editChatTitle() {
            if(!currentSessionId) return;
            const currentTitle = document.getElementById('header-title').innerText;
            const newTitle = prompt("ëŒ€í™” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", currentTitle);
            if(newTitle && newTitle.trim() !== "") {
                const chat = DB.chats.find(c => c.id === currentSessionId);
                if(chat) {
                    chat.title = newTitle.trim();
                    document.getElementById('header-title').innerText = chat.title;
                    saveData();
                    renderSidebar();
                }
            }
        }

        function loadData() { try { const d = localStorage.getItem(STORAGE_KEY); if(d) Object.assign(DB, JSON.parse(d)); if(!DB.chats) DB.chats=[]; if(!DB.worlds) DB.worlds=[]; } catch(e){} }
        function saveData() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); } catch(e){} }

function loadSettings() { 
    try { 
        const s = localStorage.getItem(SETTINGS_KEY); 
        if(s) Object.assign(SETTINGS, JSON.parse(s));
                if(!SETTINGS.globalLorebook) SETTINGS.globalLorebook=[]; 
                if(SETTINGS.typingSpeed===undefined) SETTINGS.typingSpeed=15; 
                if(SETTINGS.uncensored===undefined) SETTINGS.uncensored=true;
                if(!SETTINGS.fontSize) SETTINGS.fontSize=16;
                if(!SETTINGS.novelViewpoint) SETTINGS.novelViewpoint = '3ì¸ì¹­ ì œí•œì  ì‹œì  (ì¶”ì²œ)';
                if(!SETTINGS.novelStyle) SETTINGS.novelStyle = 'ì›¹ì†Œì„¤ì²´';
                if(!SETTINGS.novelRatio) SETTINGS.novelRatio = 'ë°¸ëŸ°ìŠ¤í˜•';
                if(!SETTINGS.maxOutputTokens) SETTINGS.maxOutputTokens = 4000;

if(!SETTINGS.novelPacing) SETTINGS.novelPacing = 'ë³´í†µ (ë°¸ëŸ°ìŠ¤)'; // ë³€ê²½ëœ í…ìŠ¤íŠ¸ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
        if(!SETTINGS.nsfwLevel) SETTINGS.nsfwLevel = 'ë…¸ë©€ (ì„±ê´€ê³„ í•´ê¸ˆ)';
        if(!SETTINGS.outputLength) SETTINGS.outputLength = 'ë³´í†µ (30ë¬¸ì¥ ë‚´ì™¸)';
                if(!SETTINGS.charAttitude) SETTINGS.charAttitude = 'ë³´í†µ (Neutral)';
                if(SETTINGS.enableMultiChoice === undefined) SETTINGS.enableMultiChoice = false; 
                // â–²â–²â–² [ì‹ ê·œ] ë â–²â–²â–²

                // [ì¶”ê°€] ë§¤í¬ë¡œ ì´ˆê¸°ê°’ ì„¤ì •
                if(!SETTINGS.macros) {
                    SETTINGS.macros = [
                        { label: "ìœ ì € í–‰ë™ ì¹¨ë²” ë°©ì§€", content: "ìœ ì € í–‰ë™ì´ë‚˜ ëŒ€ì‚¬ë¥¼ ëŒ€ì‹  ì‘ì„±í•˜ì§€ ë§ê³  ìºë¦­í„°ì˜ ë°˜ì‘ë§Œ ì„œìˆ ." },
                        { label: "ê°ê°ì  ë¬˜ì‚¬ ê°•í™”", content: "ë‹¨ìˆœ ì„¤ëª… ëŒ€ì‹  ì‹œê°, ì²­ê°, ì´‰ê°, í›„ê°ì„ í™œìš©í•´ ë¬¸í•™ì ìœ¼ë¡œ ë¬˜ì‚¬." },
                        { label: "ë‚´ë©´ ë¬˜ì‚¬", content: "í–‰ë™ë¿ë§Œ ì•„ë‹ˆë¼ ìºë¦­í„°ì˜ ìƒê°ê³¼ ë‚´ë©´ ê°ˆë“±ì„ ì„œìˆ ." },
                        { label: "ìŠ¬ë¡œìš° ëª¨ì…˜", content: "ì´ ì¥ë©´ì˜ ë¶„ìœ„ê¸°ì™€ ê°ì •ì„ ì„ ìƒì„¸íˆ." },
                        { label: "ì¥ë©´ ì „í™˜", content: "ì´ ì¥ë©´ì„ ë§ˆë¬´ë¦¬í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ìŒ ì‹œê°„ëŒ€ë‚˜ ì¥ì†Œë¡œ ë„˜ì–´ê°€ê¸°." }
                    ];
                } // [ì¤‘ìš”] ifë¬¸ ë‹«ê¸°
            } catch(e){} // [ì¤‘ìš”] tryë¬¸ ë‹«ê³  catch ì—°ê²°
        }


function saveSettings() { 
            try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(SETTINGS)); } catch(e){} 
            const modelDisplay = document.getElementById('model-display');
            
            // [ìˆ˜ì •ë¨] model.display -> modelDisplay ë¡œ ìˆ˜ì • (ì´ ì˜¤íƒ€ ë•Œë¬¸ì— ìŠ¤í¬ë¦½íŠ¸ê°€ ë©ˆì¶¥ë‹ˆë‹¤)
            if(modelDisplay) modelDisplay.innerText = 'Model: ' + (SETTINGS.currentModel || 'gemini-3-pro');
        }


        function showMessage(msg) {
            const d = document.createElement('div');
            // [ë³€ê²½] ì•Œë¦¼ì°½ ìœ„ì¹˜ë¥¼ ìƒë‹¨ ì¤‘ì•™ìœ¼ë¡œ ë³€ê²½
            d.className = "fixed top-5 left-1/2 transform -translate-x-1/2 z-[100] p-4 bg-slate-800 text-white rounded shadow-lg transition opacity-100 max-w-xs text-center";
            d.innerText = msg; document.body.appendChild(d);
            setTimeout(()=>d.style.opacity=0, 2500); setTimeout(()=>d.remove(), 3000);
        }

// [ì¶”ê°€] ì•ˆì „ ë‹«ê¸°: ì‹¤ìˆ˜ë¡œ ë°°ê²½ì„ ëˆŒë €ì„ ë•Œ í™•ì¸ì°½ ë„ìš°ê¸°
        function tryCloseModal(id) {
            if (confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì°½ì„ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                closeModal(id);
            }
        }

        
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden');
            const container = document.getElementById('modal-container');
            const openModals = Array.from(container.children).filter(child => !child.classList.contains('hidden'));
            if(openModals.length === 0) {
                container.classList.add('hidden');
            }
        }
        
        function openModalInternal(id) {
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById(id).classList.remove('hidden');
        }

        function switchNav(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-'+tab).classList.add('active');
            ['chats','worlds'].forEach(t => document.getElementById('panel-'+t).classList.add('hidden'));
            document.getElementById('panel-'+tab).classList.remove('hidden');
            renderSidebar();
        }
        
        // [ìˆ˜ì •] ì‚¬ì´ë“œë°” í† ê¸€ ë¡œì§ (PC ë‹«ê¸° ì§€ì›)
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            // Mobile: 'open' toggles slide-in
            sb.classList.toggle('open');
            // PC: 'closed' toggles width to 0
            sb.classList.toggle('closed');
            
            document.getElementById('dim-overlay').classList.toggle('hidden');
        } 
        
        function toggleRightSidebar() { 
            const sb = document.getElementById('right-sidebar');
            sb.classList.toggle('closed'); 
            sb.classList.toggle('open');
            renderRightSidebar(); 
        }
        
        function closeAllSidebars() { 
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar').classList.add('closed'); // PC ëŒ€ì‘
            document.getElementById('right-sidebar').classList.remove('open');
            document.getElementById('right-sidebar').classList.add('closed'); 
            document.getElementById('dim-overlay').classList.add('hidden');
        }

// â–¼â–¼â–¼ [ìˆ˜ì •ë¨] ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” 3ë‹¨ ë¶„ë¦¬ ë¦¬íŒ©í† ë§ ì‹œì‘ â–¼â–¼â–¼

function switchRightTab(tab) {
    currentRightTab = tab;
    renderRightSidebar();
}

// [ë©”ì¸] 3ë‹¨ íƒ­ êµ¬ì¡°ê°€ ì ìš©ëœ ë Œë”ë§ í•¨ìˆ˜
function renderRightSidebar() {
    const p = document.getElementById('right-sidebar-content');
    p.innerHTML = ''; 

    // 1. íƒ­ ë²„íŠ¼ ì˜ì—­ (3ê°œë¡œ ë¶„í• )
    const tabContainer = document.createElement('div');
    tabContainer.className = "flex border-b border-gray-200 mb-4 bg-gray-50 dark:bg-slate-900";
    tabContainer.innerHTML = `
        <button onclick="switchRightTab('tools')" class="right-tab-btn ${currentRightTab === 'tools' ? 'active' : ''}">
            <i class="fa-solid fa-toolbox mr-1"></i> ë„êµ¬
        </button>
        <button onclick="switchRightTab('settings')" class="right-tab-btn ${currentRightTab === 'settings' ? 'active' : ''}">
            <i class="fa-solid fa-sliders mr-1"></i> ì„¤ì •
        </button>
        <button onclick="switchRightTab('core')" class="right-tab-btn ${currentRightTab === 'core' ? 'active' : ''}">
            <i class="fa-solid fa-robot mr-1"></i> ì§€ì¹¨
        </button>
    `;
    p.appendChild(tabContainer);

    // 2. ë‚´ìš© ì»¨í…Œì´ë„ˆ
    const contentContainer = document.createElement('div');
    contentContainer.id = 'right-tab-content';
    p.appendChild(contentContainer);

    // 3. íƒ­ë³„ ë Œë”ë§ í˜¸ì¶œ
    if (currentRightTab === 'tools') {
        renderRightTools(contentContainer);
    } else if (currentRightTab === 'settings') {
        renderRightSettings(contentContainer);
    } else {
        renderRightCoreRules(contentContainer);
    }
}

function renderRightTools(container) {
    const chat = DB.chats.find(c => c.id === currentSessionId);
    let worldInfo = 'ëŒ€í™” ì„ íƒ ì•ˆë¨';
    
    if (chat) {
        if (chat.isNovelMode) worldInfo = `ì†Œì„¤ ëª¨ë“œ: ${chat.title}`;
        else {
            const w = DB.worlds.find(x => x.id === chat.worldId);
            if(w) worldInfo = w.name;
        }
    }

    // ì±…ê°ˆí”¼ ë¦¬ìŠ¤íŠ¸ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    let bookmarkListHtml = '<div class="text-gray-400 text-xs p-2 text-center">ì €ì¥ëœ ì±…ê°ˆí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    if (chat && chat.history) {
        const bookmarks = chat.history
            .map((msg, index) => ({ msg, index }))
            .filter(item => item.msg.bookmarked);

        if (bookmarks.length > 0) {
            bookmarkListHtml = bookmarks.map(item => {
                const summary = item.msg.text.substring(0, 30) + (item.msg.text.length > 30 ? '...' : '');
                const nameDisplay = item.msg.bookmarkName ? `<div class="font-bold text-sm text-indigo-700 dark:text-indigo-400 mb-1 border-b border-yellow-200 dark:border-gray-600 pb-1">${item.msg.bookmarkName}</div>` : '';
                
                return `
                <div class="border rounded-lg p-2 bg-yellow-50 dark:bg-slate-800 border-yellow-100 dark:border-slate-700 hover:shadow-md transition group relative">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-yellow-700 dark:text-yellow-500 bg-yellow-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">Turn ${item.index + 1}</span>
                        <div class="flex items-center gap-1">
                             <button onclick="editBookmarkName(${item.index})" class="text-gray-400 hover:text-indigo-600 px-1"><i class="fa-solid fa-pen text-[10px]"></i></button>
                             <button onclick="deleteBookmarkFromSidebar(${item.index})" class="text-gray-400 hover:text-red-500 px-1"><i class="fa-solid fa-trash text-[10px]"></i></button>
                        </div>
                    </div>
                    ${nameDisplay}
                    <div class="text-xs text-gray-700 dark:text-gray-300 font-medium mb-2 break-all leading-tight opacity-80">${summary}</div>
                    <button onclick="loadBookmark(${item.index})" class="w-full py-1.5 bg-white dark:bg-slate-700 border border-yellow-200 dark:border-slate-600 text-yellow-700 dark:text-yellow-500 font-bold text-xs rounded hover:bg-yellow-600 hover:text-white transition flex items-center justify-center gap-1">
                        <i class="fa-solid fa-rotate-left"></i> ì´ ì‹œì  ë¶„ê¸°
                    </button>
                </div>`;
            }).join('<div class="h-2"></div>'); 
        }
    }

    container.innerHTML = `
    <div class="mb-4 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg p-3 shadow-sm">
        <div class="text-xs font-bold text-gray-400 mb-1">CURRENT CONTEXT</div>
        <div class="font-bold text-gray-800 dark:text-gray-200 text-sm flex items-center gap-2">
            <i class="fa-solid fa-globe text-indigo-500"></i> ${worldInfo}
        </div>
        <div class="mt-2 text-xs text-gray-500">
            ${chat ? `<span class="bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded">í„´ ìˆ˜: ${chat.history.length}</span>` : ''}
        </div>
    </div>

    <div class="mb-4">
        <div class="text-xs font-bold text-gray-400 mb-2 px-1">ACTIONS</div>
        <div class="grid grid-cols-3 gap-2">
            <button onclick="openMemoryModal()" class="tool-btn bg-indigo-50 text-indigo-600 dark:bg-slate-800 dark:text-indigo-400 border border-indigo-100 dark:border-slate-600"><i class="fa-solid fa-brain mb-1"></i>ê¸°ì–µ</button>
            <button onclick="openSessionSettings('edit')" class="tool-btn bg-slate-50 text-slate-600 dark:bg-slate-800 dark:text-slate-400 border border-slate-200 dark:border-slate-600"><i class="fa-solid fa-users-gear mb-1"></i>ì„¤ì •</button>
            <button onclick="exportChat()" class="tool-btn bg-emerald-50 text-emerald-600 dark:bg-slate-800 dark:text-emerald-400 border border-emerald-100 dark:border-slate-600"><i class="fa-solid fa-download mb-1"></i>ì €ì¥</button>
            <button onclick="clearChat()" class="tool-btn bg-red-50 text-red-500 dark:bg-slate-800 dark:text-red-400 border border-red-100 dark:border-slate-600"><i class="fa-solid fa-eraser mb-1"></i>ì •ë¦¬</button>
            <button onclick="handleNovelUploadClick()" class="tool-btn bg-blue-50 text-blue-600 dark:bg-slate-800 dark:text-blue-400 border border-blue-100 dark:border-slate-600"><i class="fa-solid fa-folder-open mb-1"></i>ì—´ê¸°</button>
            <button onclick="showLastPrompt()" class="tool-btn bg-amber-50 text-amber-600 dark:bg-slate-800 dark:text-amber-400 border border-amber-100 dark:border-slate-600"><i class="fa-solid fa-bug mb-1"></i>ë””ë²„ê·¸</button>
        </div>
        <style>.tool-btn { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:0.5rem; border-radius:0.5rem; font-size:0.65rem; font-weight:bold; transition:all 0.2s; } .tool-btn:hover { transform:translateY(-1px); box-shadow:0 2px 4px rgba(0,0,0,0.05); }</style>
    </div>
    
    <div class="mb-4">
        <div class="text-xs font-bold text-gray-400 mb-2 px-1 flex justify-between items-center">
            <span>BOOKMARKS</span>
        </div>
        <div id="bookmark-list-container" class="space-y-0">${bookmarkListHtml}</div>
    </div>

    <div>
        <div class="flex justify-between items-center mb-2 px-1">
            <div class="text-xs font-bold text-gray-400">GLOBAL LOREBOOK</div>
            <button onclick="addGlobalLoreFromSidebar()" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 font-bold transition">+ ì¶”ê°€</button>
        </div>
        <div id="lore-list-container" class="space-y-2"></div>
    </div>`;

    // â–¼â–¼â–¼ ë¡œì–´ë¶ ë Œë”ë§ (ë””ìì¸ ë³€ê²½ë¨) â–¼â–¼â–¼
    const loreContainer = container.querySelector('#lore-list-container');
    
    if (!SETTINGS.globalLorebook || SETTINGS.globalLorebook.length === 0) {
        loreContainer.innerHTML = `<div class="text-center text-xs text-gray-400 py-4 cursor-pointer hover:text-indigo-500" onclick="addGlobalLoreFromSidebar()">ë“±ë¡ëœ ë¡œì–´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>'+ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</div>`;
    } else {
        SETTINGS.globalLorebook.forEach((lore, idx) => {
            const div = document.createElement('div');
            // 'ì§€ì¹¨'ê³¼ ë™ì¼í•œ ì¹´ë“œ ë””ìì¸ ì ìš©
            div.className = "flex items-center justify-between p-2 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded mb-1.5 shadow-sm group hover:border-indigo-300 transition-colors";
            div.innerHTML = `
                <div class="flex flex-col overflow-hidden flex-1 cursor-pointer py-1" onclick="editGlobalLore(${idx})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                    <div class="font-bold text-xs text-indigo-700 dark:text-indigo-400 truncate">${lore.title}</div>
                    <div class="text-[10px] text-gray-500 dark:text-gray-400 truncate flex items-center gap-1">
                        ${lore.keywords ? '<i class="fa-solid fa-key text-[9px]"></i> ' + lore.keywords : '<i class="fa-solid fa-infinity text-[9px]"></i> ìƒì‹œ ì ìš©'}
                    </div>
                </div>
                <div class="flex-shrink-0 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editGlobalLore(${idx})" class="text-gray-400 hover:text-indigo-600 px-1" title="ìˆ˜ì •"><i class="fa-solid fa-pen text-[10px]"></i></button>
                    <button onclick="deleteGlobalLore(${idx})" class="text-gray-400 hover:text-red-500 px-1" title="ì‚­ì œ"><i class="fa-solid fa-trash text-[10px]"></i></button>
                </div>
            `;
            loreContainer.appendChild(div);
        });
    }
}

function renderRightSettings(container) {
    const renderSelect = (label, key, options) => {
        const currentVal = SETTINGS[key];
        const optionsHtml = options.map(opt => `<option value="${opt}" ${currentVal === opt ? 'selected' : ''}>${opt}</option>`).join('');
        return `
            <div class="mb-3">
                <label class="setting-group-label">${label}</label>
                <select class="sidebar-select" onchange="updateSidebarSetting('${key}', this.value)">${optionsHtml}</select>
            </div>`;
    };

    const autoEventHtml = `
        <div class="mb-3">
            <div class="flex justify-between items-center mb-1">
                <label class="setting-group-label text-red-600 dark:text-red-400"><i class="fa-solid fa-bolt mr-1"></i>ëŒë°œ ì´ë²¤íŠ¸</label>
                <input type="checkbox" class="w-4 h-4 text-red-600 rounded focus:ring-red-500 cursor-pointer" ${SETTINGS.autoEventEnabled ? 'checked' : ''} onchange="updateSidebarSetting('autoEventEnabled', this.checked)">
            </div>
            <div class="flex items-center gap-2">
                <input type="range" min="0" max="50" step="5" value="${SETTINGS.autoEventChance || 10}" class="flex-1 accent-red-600 cursor-pointer h-1.5 bg-gray-200 rounded-lg appearance-none dark:bg-gray-700" oninput="document.getElementById('sidebar-event-display').innerText = this.value + '%'; updateSidebarSetting('autoEventChance', parseInt(this.value))">
                <span class="text-xs font-bold text-red-600 dark:text-red-400 w-8 text-right" id="sidebar-event-display">${SETTINGS.autoEventChance || 10}%</span>
            </div>
        </div>`;

    container.innerHTML = `
    <div class="space-y-1 p-1">
        <div class="bg-gray-50 dark:bg-slate-900 p-3 rounded-lg border dark:border-slate-700 mb-4">
            <div class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-3 flex items-center"><i class="fa-solid fa-sliders mr-2 text-indigo-500"></i>ì†Œì„¤ ìƒì„¸ ì„¤ì •</div>
            
            ${renderSelect('ì„œìˆ  ì‹œì ', 'novelViewpoint', ['3ì¸ì¹­ ì œí•œì  ì‹œì  (ì¶”ì²œ)', '3ì¸ì¹­ ì œí•œì  (íˆë¡œì¸ ë‚´ë©´)', '1ì¸ì¹­ ì£¼ì¸ê³µ ì‹œì ', '3ì¸ì¹­ ê´€ì°°ì ì‹œì ', '3ì¸ì¹­ ì „ì§€ì  ì‘ê°€ ì‹œì '])}
            ${renderSelect('ì„œìˆ /ëŒ€í™” ë¹„ì¤‘', 'novelRatio', ['ë°¸ëŸ°ìŠ¤í˜•', 'ëŒ€í™” ì¤‘ì‹¬ (ì—¬ì ë°œì–¸ ìœ„ì£¼)', 'ëŒ€í™” ì¤‘ì‹¬', 'ì§€ë¬¸/ë¬˜ì‚¬ ì¤‘ì‹¬'])}

            <hr class="border-gray-200 dark:border-slate-700 my-3">

            ${renderSelect('ì„œìˆ  í˜¸í¡', 'novelPacing', ['ë¹ ë¥¸ ì „ê°œ (ì‚¬ê±´ ìœ„ì£¼)', 'ë³´í†µ (ë°¸ëŸ°ìŠ¤)', 'ëŠë¦° ì „ê°œ (ì„¸ë°€í•œ ë¬˜ì‚¬)'])}
            ${renderSelect('ë¬¸ì²´ ìŠ¤íƒ€ì¼', 'novelStyle', ['ì›¹ì†Œì„¤ì²´', 'ê°„ê²°/ê±´ì¡°ì²´', 'ë§Œì—°/í™”ë ¤ì²´'])}
            
            ${renderSelect('ìˆ˜ìœ„ ê°•ë„', 'nsfwLevel', ['ì „ì—°ë ¹ (ìŠ¤í‚¨ì‹­/í‚¤ìŠ¤)', 'ë…¸ë©€ (ì„±ê´€ê³„ í•´ê¸ˆ)', 'ê³ ìˆ˜ìœ„ (ìê·¹ì /ì ë‚˜ë¼í•¨)', 'ì´ˆê³ ìˆ˜ìœ„ (ì—ë¡œê²Œ/ë™ì¸ì§€)'])}
            ${renderSelect('ìºë¦­í„° íƒœë„', 'charAttitude', ['ì² ë²½ (ì°¨ê°€ì›€/ë°©ì–´ì )', 'ë„ë„í•¨ (ì˜¤ë§Œ/ë‚´ë ¤ë‹¤ë´„)', 'ë³´í†µ (ì¼ë°˜ì )', 'ì ê·¹ì  (ìœ í˜¹/ë¦¬ë“œ)', 'ê¸ˆì‚¬ë¹  (ë§¹ëª©ì  ì• ì •)'])}
            ${renderSelect('1íšŒ ì¶œë ¥ ë¶„ëŸ‰', 'outputLength', ['ì§§ê²Œ (10ë¬¸ì¥ ë‚´ì™¸)', 'ë³´í†µ (30ë¬¸ì¥ ë‚´ì™¸)', 'ê¸¸ê²Œ (50ë¬¸ì¥ ë‚´ì™¸)'])}
            
            <hr class="border-gray-200 dark:border-slate-700 my-3">
            
            ${autoEventHtml}

            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200 dark:border-slate-700">
                <span class="text-xs font-bold text-gray-700 dark:text-gray-300">4ì§€ì„ ë‹¤ ì„ íƒì§€ ìƒì„±</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" ${SETTINGS.enableMultiChoice ? 'checked' : ''} onchange="updateSidebarSetting('enableMultiChoice', this.checked)">
                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer 
                                dark:bg-slate-500 dark:border-slate-400 border border-gray-300 
                                peer-checked:after:translate-x-full peer-checked:after:border-white 
                                after:content-[''] after:absolute after:top-[2px] after:left-[2px] 
                                after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all 
                                peer-checked:bg-indigo-600"></div>
                </label>
            </div>
        </div>
        
        <div class="text-xs text-gray-500 text-center mt-4">
            * AI í•µì‹¬ ì§€ì¹¨ì€ ìƒë‹¨ 'ì§€ì¹¨' íƒ­ì—ì„œ ì„¤ì •í•˜ì„¸ìš”.
        </div>
    </div>`;
}

/* â–¼â–¼â–¼ [ìˆ˜ì •] 3. ì‚¬ì´ë“œë°” ë Œë”ë§ (í´ë¦­ ì˜ì—­ ê°œì„ ) â–¼â–¼â–¼ */
function renderRightCoreRules(container) {
    let coreRulesHtml = '';
    
    if (!SETTINGS.coreRules || SETTINGS.coreRules.length === 0) {
        coreRulesHtml = `<div class="text-center text-xs text-gray-400 py-4 cursor-pointer hover:text-indigo-500" onclick="addCoreRuleFromSidebar()">ë“±ë¡ëœ ì§€ì¹¨ì´ ì—†ìŠµë‹ˆë‹¤.<br>'+ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</div>`;
    } else {
        SETTINGS.coreRules.forEach((rule, idx) => {
            // í´ë¦­ ì‹œ editCoreRuleFromSidebar(idx) í˜¸ì¶œ
            coreRulesHtml += `
            <div class="flex items-center justify-between p-2 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded mb-1.5 shadow-sm group hover:border-indigo-300 transition-colors">
                <div class="flex items-center gap-2 overflow-hidden flex-1">
                    <input type="checkbox" ${rule.enabled !== false ? 'checked' : ''} onchange="toggleCoreRule(${idx}, this.checked)" onclick="event.stopPropagation()" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer flex-shrink-0" title="ì´ ì§€ì¹¨ ì¼œê¸°/ë„ê¸°">
                    
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300 truncate cursor-pointer hover:text-indigo-600 flex-1 py-1" onclick="editCoreRuleFromSidebar(${idx})" title="${rule.content ? rule.content.substring(0,50)+'...' : 'ë‚´ìš© ì—†ìŒ'}">
                        ${rule.title || 'ê·œì¹™ ' + (idx + 1)}
                    </span>
                </div>
                <div class="flex-shrink-0 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editCoreRuleFromSidebar(${idx})" class="text-gray-400 hover:text-indigo-600 px-1" title="ìˆ˜ì •"><i class="fa-solid fa-pen text-[10px]"></i></button>
                    <button onclick="deleteCoreRuleFromSidebar(${idx})" class="text-gray-400 hover:text-red-500 px-1" title="ì‚­ì œ"><i class="fa-solid fa-trash text-[10px]"></i></button>
                </div>
            </div>`;
        });
    }

    container.innerHTML = `
    <div class="space-y-1 p-1">
        <div class="bg-gray-50 dark:bg-slate-900 p-3 rounded-lg border dark:border-slate-700">
             <div class="flex justify-between items-center mb-3">
                <div class="font-bold text-sm text-gray-800 dark:text-gray-200"><i class="fa-solid fa-robot mr-2 text-indigo-500"></i>AI í•µì‹¬ ì§€ì¹¨</div>
                <button onclick="addCoreRuleFromSidebar()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 font-bold transition">+ ì¶”ê°€</button>
            </div>
            <div class="space-y-0 max-h-[70vh] overflow-y-auto pr-1">
                ${coreRulesHtml}
            </div>
            <div class="mt-3 text-[10px] text-gray-400 leading-tight">
                * ì²´í¬ë°•ìŠ¤ë¥¼ ë„ë©´ í•´ë‹¹ ì§€ì¹¨ì€ AIì—ê²Œ ì „ë‹¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>`;
}

function updateSidebarSetting(key, value) {
    SETTINGS[key] = value;
    saveSettings();
}

function toggleCoreRule(idx, enabled) {
    if(SETTINGS.coreRules[idx]) {
        SETTINGS.coreRules[idx].enabled = enabled;
        saveSettings();
    }
}

function editCoreRuleFromSidebar(idx) {
    const rule = SETTINGS.coreRules[idx];
    const body = document.getElementById('modal-body');

    // 1. ì—ë””í„° ëª¨ë‹¬ ë‚´ìš© ì£¼ì… (ë„“ì€ ì…ë ¥ì°½ ì œê³µ)
    body.innerHTML = `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">ì§€ì¹¨ ì œëª©</label>
                <input id="quick-edit-title" type="text" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500" value="${String(rule.title).replace(/"/g, '&quot;')}" placeholder="ì˜ˆ: ì „íˆ¬ ë¬˜ì‚¬ ê°•í™”">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">ì§€ì¹¨ ë‚´ìš© (í”„ë¡¬í”„íŠ¸)</label>
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">AIê°€ ì´ ê·œì¹™ì„ ì–´ë–»ê²Œ ë”°ë¼ì•¼ í•˜ëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”.</div>
                <textarea id="quick-edit-content" rows="15" class="w-full p-3 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-gray-100 resize-none text-sm leading-relaxed focus:ring-2 focus:ring-indigo-500" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">${rule.content}</textarea>
            </div>
        </div>
    `;

    // 2. ëª¨ë‹¬ UI ì„¤ì •
    document.getElementById('modal-title').innerText = "AI í•µì‹¬ ì§€ì¹¨ ìˆ˜ì •";
    document.getElementById('modal-delete-btn').classList.add('hidden');
    document.getElementById('btn-gen-details').classList.add('hidden'); // ë¶ˆí•„ìš”í•œ ë²„íŠ¼ ìˆ¨ê¹€

    // 3. ì €ì¥ ë²„íŠ¼ ê¸°ëŠ¥ ì¬ì •ì˜
    const saveBtn = document.getElementById('modal-save-btn');
    saveBtn.onclick = () => {
        const titleVal = document.getElementById('quick-edit-title').value.trim();
        // ì œëª©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì €ì¥ ì•ˆ í•¨ (ì„ íƒì‚¬í•­)
        if (!titleVal) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        SETTINGS.coreRules[idx].title = titleVal;
        SETTINGS.coreRules[idx].content = document.getElementById('quick-edit-content').value;
        
        saveSettings();       // ì €ì¥
        renderRightSidebar(); // ì‚¬ì´ë“œë°” ê°±ì‹ 
        closeModal('editor-modal');
    };

    // 4. ëª¨ë‹¬ ì—´ê¸° ë° ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ë¶€ì°©
    openModalInternal('editor-modal');
    setTimeout(() => {
        const textarea = document.getElementById('quick-edit-content');
        if(textarea) {
            textarea.focus(); // ë°”ë¡œ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ í¬ì»¤ìŠ¤
            makeResizable(textarea);
        }
    }, 50);
}

/* â–¼â–¼â–¼ [ìˆ˜ì •] 2. 'ì¶”ê°€' ë²„íŠ¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ë¹ˆ ì—ë””í„° ì—´ê¸° â–¼â–¼â–¼ */
function addCoreRuleFromSidebar() {
    // ë¹ˆ ê·œì¹™ ìƒì„± í›„ í‘¸ì‹œ
    SETTINGS.coreRules.push({ title: 'ìƒˆ ê·œì¹™', content: '', enabled: true });
    saveSettings();
    renderRightSidebar();
    
    // ë°©ê¸ˆ ì¶”ê°€í•œ ê·œì¹™(ë§ˆì§€ë§‰ ì¸ë±ìŠ¤)ì„ ì¦‰ì‹œ ì—ë””í„°ë¡œ ì—´ê¸°
    editCoreRuleFromSidebar(SETTINGS.coreRules.length - 1);
}

function deleteCoreRuleFromSidebar(idx) {
    if(confirm("ì´ ì§€ì¹¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        SETTINGS.coreRules.splice(idx, 1);
        saveSettings();
        renderRightSidebar();
    }
}

// â–²â–²â–² [ìˆ˜ì •ë¨] ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” 3ë‹¨ ë¶„ë¦¬ ë¦¬íŒ©í† ë§ ë â–²â–²â–²

function handleNovelUploadClick() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true; // ë‹¤ì¤‘ ì„ íƒ
            input.accept = '.txt, .jpg, .jpeg, .png, .webp, .avif';
            
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                if (files.length > 5) {
                    alert('ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nìƒìœ„ 5ê°œì˜ íŒŒì¼ë§Œ ë³‘í•©í•˜ì—¬ ë¡œë“œí•©ë‹ˆë‹¤.');
                }
                
                // ì„ íƒëœ íŒŒì¼(ìµœëŒ€ 5ê°œ)ì„ í•œêº¼ë²ˆì— ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
                processBatchFiles(files.slice(0, 5));
            };
            
            input.click();
        }


async function processBatchFiles(files) {
            if (!files || files.length === 0) return;

            showMessage(`${files.length}ê°œì˜ íŒŒì¼ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...`);

            let combinedText = "";
            let collectedImages = [];
            let mainTitle = files[0].name.replace(/\.(txt|jpg|jpeg|png|webp|avif)$/i, '').trim();
            
            if (files.length > 1) mainTitle += ` ì™¸ ${files.length - 1}ê±´`;

            // ëª¨ë“  íŒŒì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ì½ì–´ì„œ ë°ì´í„° ìˆ˜ì§‘
            for (const file of files) {
                const isImage = file.type.startsWith('image/');
                
                if (isImage) {
                    // ì´ë¯¸ì§€ ì²˜ë¦¬ (JPEG ë³€í™˜)
                    await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                ctx.drawImage(img, 0, 0);
                                // ì´ë¯¸ì§€ë¥¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                                collectedImages.push(canvas.toDataURL('image/jpeg', 0.9));
                                resolve();
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    // í…ìŠ¤íŠ¸ ì²˜ë¦¬ (ë‚´ìš© ë³‘í•©)
                    await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const fileName = file.name;
                            combinedText += `\n\n[íŒŒì¼ êµ¬ë¶„: ${fileName}]\n----------------\n${e.target.result}\n`;
                            resolve();
                        };
                        reader.readAsText(file);
                    });
                }
            }

            // í•˜ë‚˜ì˜ ì„¸ì…˜ ìƒì„±
            const id = Date.now().toString();
            const newChat = { 
                id, 
                title: mainTitle, 
                worldId: 'novel_mode_dummy', 
                characterIds: [], 
                history: [], 
                memory: '',
                isNovelMode: true,
                novelContent: combinedText.trim(), // í•©ì³ì§„ í…ìŠ¤íŠ¸
                novelImages: collectedImages // [ì¤‘ìš”] ì´ë¯¸ì§€ ë°°ì—´ ì €ì¥
            };
            
            DB.chats.unshift(newChat);
            saveData();
            renderSidebar();
            loadSession(id);
            
            showMessage(`"${mainTitle}" ë¡œë“œ ì™„ë£Œ! (í…ìŠ¤íŠ¸ ë³‘í•©ë¨, ì´ë¯¸ì§€ ${collectedImages.length}ì¥)`);
        }


        function getWorldIcon(world) {
            const text = (world.genre || '') + ' ' + (world.name || '') + ' ' + (world.description || '');
            if(text.match(/íŒíƒ€ì§€|ì´ì„¸ê³„|ë§ˆë²•|ë“œë˜ê³¤|ì˜ì£¼|ê·€ì¡±/)) return 'fa-dungeon';
            if(text.match(/í•™ì›|í•™êµ|ì•„ì¹´ë°ë¯¸|í•™ìƒ|êµì‚¬/)) return 'fa-school';
            if(text.match(/ë¬´í˜‘|ë™ì–‘|ì²œë§ˆ|ë¬´ë¦¼|ì„ í˜‘/)) return 'fa-scroll';
            if(text.match(/SF|ìš°ì£¼|ë¯¸ë˜|ì‚¬ì´ë²„|ë¡œë´‡/)) return 'fa-robot';
            if(text.match(/í˜„ëŒ€|ì¼ìƒ|íšŒì‚¬|ë„ì‹œ|ì˜¤í”¼ìŠ¤/)) return 'fa-building';
            if(text.match(/ì•„í¬ì¹¼ë¦½ìŠ¤|ì¢€ë¹„|ìƒì¡´|ë©¸ë§|ë°”ì´ëŸ¬ìŠ¤/)) return 'fa-biohazard';
            return 'fa-globe';
        }

function updateSidebarButtons(tab) {
            const btn1 = document.getElementById('ai-create-btn');
            const btn2 = document.getElementById('manual-create-btn');
            
            // ì™¸ë¶€ ê²€ìƒ‰ ë²„íŠ¼ë“¤ (ì¡´ì¬ ì—¬ë¶€ ì²´í¬ í›„ ìˆ¨ê¹€ ì²˜ë¦¬)
            const extBtns = [
                document.getElementById('external-char-create-btn'),
                document.getElementById('external-user-create-btn'),
                document.getElementById('external-world-create-btn')
            ];
            extBtns.forEach(b => { if(b) b.classList.add('hidden'); });

            if (!btn1 || !btn2) return; // ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨

            if (tab === 'chats') {
                // ë¼ì´ë¸ŒëŸ¬ë¦¬(ì±„íŒ… ëª©ë¡) íƒ­ì¼ ë•Œ: 'ìƒˆ ì´ì•¼ê¸° ì‹œì‘' ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
                btn1.innerHTML = '<i class="fa-solid fa-plus"></i> ìƒˆ ì´ì•¼ê¸° ì‹œì‘';
                btn1.onclick = () => openSessionSettings('new'); // í´ë¦­ ì´ë²¤íŠ¸ ì¬í• ë‹¹
                btn1.classList.remove('hidden');
                
                btn2.classList.add('hidden'); // ì§ì ‘ ì…ë ¥ ë²„íŠ¼ ìˆ¨ê¹€
            } else {
                // ë°°ê²½/ìºë¦­í„° íƒ­ì¼ ë•Œ: AI ìƒì„± ë° ì§ì ‘ ì…ë ¥ ë²„íŠ¼ í™œì„±í™”
                btn2.classList.remove('hidden');
                const label = tab === 'users' ? 'ìœ ì € í˜ë¥´ì†Œë‚˜' : (tab === 'worlds' ? 'ë°°ê²½' : 'ìºë¦­í„°');
                
                // íƒ­ë³„ë¡œ ì™¸ë¶€ ê²€ìƒ‰ ë²„íŠ¼ ë…¸ì¶œ
                if (tab === 'chars' && extBtns[0]) extBtns[0].classList.remove('hidden');
                if (tab === 'users' && extBtns[1]) extBtns[1].classList.remove('hidden');
                if (tab === 'worlds' && extBtns[2]) extBtns[2].classList.remove('hidden');

                if (tab === 'users') {
                    btn1.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AI í˜ë¥´ì†Œë‚˜ ìƒì„±`;
                } else if (tab === 'chars') {
                     btn1.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AI ìºë¦­í„° ìƒì„±`;
                } else {
                    btn1.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AIë¡œ ${label} ìƒì„±`;
                }
                
                // í´ë¦­ ì´ë²¤íŠ¸ ì¬í• ë‹¹ (ì¤‘ìš”)
                btn1.onclick = () => openAiGeneratorModal(tab);
                btn2.innerHTML = `<i class="fa-solid fa-pen-ruler"></i> ${label} ì§ì ‘ ì…ë ¥`;
                btn2.onclick = () => openEditor(null, tab);
            }
        }

function renderSidebar() {
            // [ì¤‘ìš”] ì‚¬ì´ë“œë°” ë Œë”ë§ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
            updateSidebarButtons(currentTab);

            const openWorldIds = Array.from(document.querySelectorAll('.world-item.open')).map(el => el.dataset.id);
            
            if(currentTab === 'chats') {
                const p = document.getElementById('panel-chats'); p.innerHTML = '';
                DB.chats.forEach(c => {
                    let subText = c.lastMessage||'ëŒ€í™” ì—†ìŒ';
                    let emoji = c.emoji;
                    if (c.isNovelMode) {
                        subText = 'ì†Œì„¤ ëª¨ë“œ (' + c.novelContent.substring(0, 50).replace(/\n/g, ' ') + '...)';
                        emoji = 'ğŸ“–';
                    }

                    const itemHtml = `
                        <div class="flex justify-between items-center p-3 bg-white border rounded-lg hover:bg-gray-50 cursor-pointer group mb-2" onclick="loadSession('${c.id}')">
                            <div class="flex items-center overflow-hidden">
                                <div class="w-10 h-10 rounded bg-indigo-100 flex items-center justify-center text-xl mr-3 flex-shrink-0">${emoji || '  '}</div>
                                <div><div class="font-bold text-sm truncate">${c.title||'ì œëª© ì—†ìŒ'}</div><div class="text-xs text-gray-500 truncate">${subText}</div></div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteChat('${c.id}')" class="p-2 text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                        </div>`;
                    p.innerHTML += itemHtml;
                });
            } else if(currentTab === 'worlds') {
                // ... (ê¸°ì¡´ worlds ë Œë”ë§ ì½”ë“œ ìœ ì§€) ...
                const p = document.getElementById('panel-worlds'); p.innerHTML = '';
                DB.worlds.forEach(w => {
                    const iconClass = getWorldIcon(w);
                    const iconDisplay = w.emoji 
                        ? `<div class="w-10 h-10 rounded bg-indigo-100 flex items-center justify-center text-2xl mr-3 flex-shrink-0">${w.emoji}</div>`
                        : `<div class="w-10 h-10 rounded bg-indigo-100 flex items-center justify-center text-indigo-500 mr-3 flex-shrink-0"><i class="fa-solid ${iconClass}"></i></div>`;

                    const charsHtml = (w.characters||[]).map(c => `
                        <div class="flex justify-between p-2 hover:bg-indigo-50 rounded cursor-pointer" onclick="event.stopPropagation(); openEditor('${c.id}','chars', null, '${w.id}')">
                            <div class="flex items-center"><i class="fa-solid fa-user mr-2 text-gray-400"></i><span class="text-sm">${c.name}</span></div>
                            <button onclick="event.stopPropagation(); deleteChar('${w.id}','${c.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                        </div>`).join('');
                    
                    const user = w.user;
                    let userBtnHtml = '';
                    if (user && user.name) {
                        userBtnHtml = `
                        <div class="flex justify-between p-2 hover:bg-indigo-50 rounded cursor-pointer mb-1" onclick="event.stopPropagation(); openEditor(null, 'users', null, '${w.id}')">
                             <div class="flex items-center"><i class="fa-solid fa-user-astronaut mr-2 text-indigo-500"></i><span class="text-sm font-bold">${user.name} (ìœ ì €)</span></div>
                             <button onclick="event.stopPropagation(); deleteUser('${w.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                        </div>`;
                    } else {
                        userBtnHtml = `
                            <div class="flex gap-1 mb-2">
                                <button onclick="event.stopPropagation(); openAiGeneratorModal('creative_user', '${w.id}')" class="flex-1 py-1.5 bg-purple-100 text-purple-700 text-xs rounded font-bold hover:bg-purple-200"><i class="fa-solid fa-search"></i> ì°½ì‘ë¬¼ ê²€ìƒ‰</button>
                                <button onclick="event.stopPropagation(); openAiGeneratorModal('users', '${w.id}')" class="flex-1 py-1.5 bg-indigo-100 text-indigo-700 text-xs rounded font-bold hover:bg-indigo-200"><i class="fa-solid fa-wand-magic-sparkles"></i> AI ìƒì„±</button>
                                <button onclick="event.stopPropagation(); openEditor(null, 'users', null, '${w.id}')" class="flex-1 py-1.5 bg-gray-100 text-gray-700 text-xs rounded font-bold hover:bg-gray-200"><i class="fa-solid fa-pen-ruler"></i> ì§ì ‘ ì…ë ¥</button>
                            </div>`;
                    }

                    p.innerHTML += `
                        <div class="world-item mb-2" data-id="${w.id}">
                            <div class="world-header flex justify-between items-center p-3 border border-gray-200 rounded-lg bg-white hover:bg-gray-50 cursor-pointer gap-2" onclick="this.parentElement.classList.toggle('open')">
                                <div class="flex items-center flex-1 min-w-0 overflow-hidden">
                                    ${iconDisplay}
                                    <span class="font-bold text-sm truncate">${w.name}</span>
                                </div>
                                <div class="flex items-center flex-shrink-0">
                                    <button onclick="event.stopPropagation(); openEditor('${w.id}','worlds')" class="p-2 text-gray-400 hover:text-indigo-600 transition" title="ë°°ê²½ ìˆ˜ì •"><i class="fa-solid fa-gear"></i></button>
                                    <button onclick="event.stopPropagation(); deleteWorld('${w.id}')" class="p-2 text-gray-400 hover:text-red-500 transition" title="ë°°ê²½ ì‚­ì œ"><i class="fa-solid fa-trash-can"></i></button>
                                    <i class="fa-solid fa-chevron-down text-gray-400 p-2 ml-1 transition-transform duration-200"></i>
                                </div>
                            </div>
                            <div class="world-chars p-2 border border-t-0 border-gray-200 rounded-b-lg bg-white">
                                ${userBtnHtml}
                                ${charsHtml}
                                <div class="flex gap-1 mt-2">
                                     <button onclick="event.stopPropagation(); openAiGeneratorModal('creative_char', '${w.id}')" class="flex-1 py-1.5 bg-purple-100 text-purple-700 text-xs rounded font-bold hover:bg-purple-200"><i class="fa-solid fa-search"></i> ì°½ì‘ë¬¼ ê²€ìƒ‰</button>
                                    <button onclick="event.stopPropagation(); openAiGeneratorModal('chars', '${w.id}')" class="flex-1 py-1.5 bg-indigo-100 text-indigo-600 text-xs rounded font-bold hover:bg-indigo-200"><i class="fa-solid fa-wand-magic-sparkles"></i> AI ìƒì„±</button>
                                    <button onclick="event.stopPropagation(); openEditor(null, 'chars', null, '${w.id}')" class="flex-1 py-1.5 bg-gray-100 text-gray-600 text-xs rounded font-bold hover:bg-gray-200"><i class="fa-solid fa-pen-ruler"></i> ì§ì ‘ ì…ë ¥</button>
                                </div>
                            </div>
                        </div>`;
                });
                
                openWorldIds.forEach(id => {
                    const item = p.querySelector(`.world-item[data-id="${id}"]`);
                    if(item) item.classList.add('open');
                });
            }
        }

/* --- [ìˆ˜ì •ë¨] ì…ë ¥ì°½ ë†’ì´ê°€ í™•ì¥ëœ ì—ë””í„° í•¨ìˆ˜ --- */
function openEditor(id, type, prefillData = null, worldId = null) {
    const body = document.getElementById('modal-body');
    let data = prefillData;

    // ë°ì´í„° ë¡œë“œ ë¡œì§
    if (id) {
        if (type === 'chars') DB.worlds.forEach(w => { const c = w.characters?.find(x => x.id === id); if(c) data = c; });
        else if (type === 'worlds') data = DB.worlds.find(x => x.id === id);
    } else if (!prefillData) {
        if (type === 'worlds') { data = { aiRules: [], lorebook: [] }; }
        if (type === 'users' && worldId) { const w = DB.worlds.find(x => x.id === worldId); if(w && w.user) data = w.user; else data = { entries: [] }; }
        if (type === 'chars') { data = { entries: [], lorebook: [] }; }
    } else {
        if(data.aiRules) data.aiRules = data.aiRules.filter(r => r.title || r.content);
        if(data.lorebook) data.lorebook = data.lorebook.filter(r => r.title || r.content);
        if(data.entries) data.entries = data.entries.filter(r => r.title || r.content);
    }
    
    // HTML í—¬í¼ í•¨ìˆ˜ë“¤
    const escapeHtml = (str) => String(str||'').replace(/"/g, '&quot;');
    const ipt = (lbl, key, val) => `<div><label class="block text-xs font-bold text-gray-600 mb-1">${lbl}</label><input type="text" data-key="${key}" value="${escapeHtml(val)}" class="w-full p-2 border rounded bg-white text-sm focus:ring-1 focus:ring-indigo-500"></div>`;
    
    // [ìˆ˜ì •] txtGrid: ê¸°ë³¸ rowsë¥¼ 2ì—ì„œ 3ìœ¼ë¡œ ì†Œí­ ìƒí–¥
    const txtGrid = (lbl, key, val) => `<div class="col-span-1"><label class="block text-[11px] font-bold text-gray-500 mb-0.5 truncate" title="${lbl}">${lbl}</label><textarea data-key="${key}" rows="3" class="w-full p-1.5 border rounded bg-white text-xs leading-tight focus:ring-1 focus:ring-indigo-500 resize-none">${escapeHtml(val)}</textarea></div>`;
    
    const txt = (lbl, key, val, rows=3, placeholder='') => `<div class="col-span-1"><label class="block text-xs font-bold text-gray-600 mb-1">${lbl}</label><textarea data-key="${key}" rows="${rows}" class="w-full p-2 border rounded bg-white text-sm leading-relaxed focus:ring-1 focus:ring-indigo-500" placeholder="${placeholder}">${escapeHtml(val)}</textarea></div>`;
    const txtFull = (lbl, key, val, rows=4, placeholder='') => `<div class="col-span-1 md:col-span-2 lg:col-span-3"><label class="block text-xs font-bold text-gray-600 mb-1">${lbl}</label><textarea data-key="${key}" rows="${rows}" class="w-full p-2 border rounded bg-white text-sm leading-relaxed focus:ring-1 focus:ring-indigo-500" placeholder="${placeholder}">${escapeHtml(val)}</textarea></div>`;

    let html = `<input type="hidden" id="edit-id" value="${id||''}"><input type="hidden" id="edit-type" value="${type}">`;
    if(worldId) html += `<input type="hidden" id="edit-world-id" value="${worldId}">`;

    if (type === 'chars') {
        html += `
        <div class="flex border-b mb-4 text-sm font-medium overflow-x-auto">
            <button class="editor-tab-btn active shrink-0" onclick="switchEditorTab('basic')">ê¸°ë³¸/ì™¸í˜•</button>
            <button class="editor-tab-btn shrink-0" onclick="switchEditorTab('sexual')">ì„±ì  ì·¨í–¥</button>
            <button class="editor-tab-btn shrink-0" onclick="switchEditorTab('depth')">ì‹¬í™”/ë‚´ë©´</button>
            <button class="editor-tab-btn shrink-0" onclick="switchEditorTab('extra')">ê¸°íƒ€ ì„¤ì •</button>
        </div>
        
        <div id="edit-tab-basic" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                ${ipt('ì´ë¦„', 'name', data?.name)}
                ${ipt('ì›ì‘ ì‘í’ˆëª…', 'source_material', data?.source_material)}
            </div>
            <div class="grid grid-cols-3 gap-2">
                ${txtGrid('ì„±ë³„', 'gender', data?.gender)}
                ${txtGrid('ë‚˜ì´', 'age', data?.age)}
                ${txtGrid('ì¢…ì¡±', 'race', data?.race)}
                ${txtGrid('ì‹ ì¥', 'height', data?.height)}
                ${txtGrid('ì²´ì¤‘', 'weight', data?.weight)}
                ${txtGrid('í”¼ë¶€ìƒ‰', 'skin', data?.skin)}
            </div>
            <div class="p-3 bg-gray-50 border rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${ipt('ì²´í˜•/ëª¸ë§¤', 'body_type', data?.body_type)}
                    ${ipt('ì“°ë¦¬ì‚¬ì´ì¦ˆ', 'three_sizes', data?.three_sizes)}
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    ${txtGrid('í—¤ì–´ ìŠ¤íƒ€ì¼', 'hair_style', data?.hair_style)} 
                    ${txtGrid('ëˆˆë§¤/ëˆˆë™ì', 'eyes', data?.eyes)}
                    ${txtGrid('ì§ì—…/ì—­í• ', 'job', data?.job)}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="md:row-span-2">
                    ${txt('ì™¸ëª¨ ë¬˜ì‚¬', 'appearance_desc', data?.appearance_desc, 12)}
                </div>
                <div class="grid grid-cols-1 gap-2 content-start">
                    <label class="block text-xs font-bold text-gray-600">íŠ¹ì§• íƒœê·¸ (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label>
                    ${txtGrid('ì•¡ì„¸ì„œë¦¬/ë¬¸ì‹ /í”¼ì–´ì‹±', 'accessories', data?.accessories)}
                    ${txtGrid('ì„±ê²© íƒœê·¸', 'personality_tags', data?.personality_tags)}
                    ${txtGrid('ë§íˆ¬/ëª©ì†Œë¦¬ íŠ¹ì§•', 'voice', data?.voice)}
                    ${txtGrid('ì •ì‹  ìƒíƒœ/ë©˜íƒˆ', 'mental_state', data?.mental_state)}
                </div>
            </div>
            ${txtFull('ìƒ˜í”Œ ëŒ€ì‚¬ (ìƒí™©ë³„ ì¤„ë°”ê¿ˆ)', 'sample_dialogue', data?.sample_dialogue, 6)}
        </div>

        <div id="edit-tab-sexual" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-3">
                ${txtGrid('ì„±ê°ëŒ€', 'erogenous_zones', data?.erogenous_zones)}
                ${txtGrid('í˜í‹°ì‹œ', 'fetish', data?.fetish)}
                ${txtGrid('ì†ì˜· ìŠ¤íƒ€ì¼', 'underwear', data?.underwear)}
                ${txtGrid('ìŒëª¨/í„¸ ìƒíƒœ', 'pubic_hair', data?.pubic_hair)}
                
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-gray-600 mb-1">ì„±ì  ì„±í–¥/íŠ¹ì„± (ìƒì„¸)</label>
                    <textarea data-key="perverted_features" rows="6" class="w-full p-2 border rounded bg-white text-sm leading-relaxed focus:ring-1 focus:ring-indigo-500 shadow-sm">${escapeHtml(data?.perverted_features)}</textarea>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-2">* ë” ìì„¸í•œ ì‹¬ë¦¬ ë¬˜ì‚¬ëŠ” 'ì‹¬í™”/ë‚´ë©´' íƒ­ì„ ì´ìš©í•˜ì„¸ìš”.</p>
        </div>

        <div id="edit-tab-depth" class="hidden space-y-4">
            <div class="bg-indigo-50 p-3 rounded text-xs text-indigo-700 mb-2 border border-indigo-100">
                <i class="fa-solid fa-info-circle mr-1"></i> ì´ íƒ­ì˜ ë‚´ìš©ì€ ìºë¦­í„°ì˜ ì…ì²´ì ì¸ ë°˜ì‘ì„ ìœ„í•´ AIì—ê²Œ ê°•ë ¥í•˜ê²Œ ì£¼ì…ë©ë‹ˆë‹¤.
            </div>
            
            ${txtFull('ë§íˆ¬/ì–´ì¡° ì‹¬í™” ê°€ì´ë“œë¼ì¸', 'dialogue_depth', data?.dialogue_depth, 6, 'ì˜ˆ: ë‹¹í™©í•˜ë©´ ë§ì„ ë”ë“¬ìŒ, ì„±ì ì¸ ìƒí™©ì—ì„œ ì¡´ëŒ“ë§ì´ ë¬´ë„ˆì§, í‰ì†Œì—” ëƒ‰ì² í•˜ì§€ë§Œ ì¾Œë½ ì•ì—ì„œëŠ” í˜€ê°€ ê¼¬ì„ ë“±')}
            ${txtFull('ì„±ì  ë°˜ì‘ ë° ë‚´ë©´ ì‹¬ë¦¬ ìƒì„¸', 'sexual_psyche', data?.sexual_psyche, 8, 'ì˜ˆ: ê²‰ìœ¼ë¡œëŠ” ê±°ë¶€í•˜ì§€ë§Œ ì†ìœ¼ë¡œëŠ” ì¾Œë½ì„ ëŠë‚Œ, ëª¨ì„±ì• ì™€ íƒ€ë½ ì‚¬ì´ì˜ ê°ˆë“±, ì•”ì‚´ìì˜ ë³¸ëŠ¥ì´ ì„±ê°ìœ¼ë¡œ ë³€ì§ˆë˜ëŠ” ê³¼ì • ë“±')}
            ${txtFull('ì„±ì  ìƒí™© í–‰ë™ íŒ¨í„´', 'sexual_behavior', data?.sexual_behavior, 6, 'ì˜ˆ: ì²˜ìŒì—ëŠ” ì €í•­í•˜ë‹¤ê°€ ì¤‘ë°˜ë¶€í„° ì ê·¹ì ìœ¼ë¡œ ë³€í•¨, ì ˆì • ì‹œì—ëŠ” ì•„í—¤ê°€ì˜¤ì™€ í•¨ê»˜ ì´ì„±ì„ ìƒìŒ ë“±')}
        </div>

        <div id="edit-tab-extra" class="hidden space-y-4">
            ${renderEntriesEditor(data?.entries, 'ê¸°íƒ€ ìƒì„¸ ì„¤ì • (Entries)', 'entries')}
        </div>
        `;
    } else if (type === 'users') {
        html += `
        <h4 class="font-bold text-indigo-700 mb-3">ìœ ì € í˜ë¥´ì†Œë‚˜ ì„¤ì •</h4>
        
        <div class="grid grid-cols-3 gap-3 mb-4">
            ${ipt('ì´ë¦„', 'name', data?.name)}
            ${txtGrid('ì„±ë³„', 'gender', data?.gender || 'ë‚¨ì„±')}
            ${txtGrid('ë‚˜ì´', 'age', data?.age)}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${txt('ì™¸ëª¨/ìŠ¤íƒ€ì¼', 'outfit', data?.outfit, 4)}
            ${txt('ì‹ ì²´ì  íŠ¹ì§•', 'features', data?.features, 4)}
        </div>
        <div class="mb-4">${txtFull('ì·¨ë¯¸/íŠ¹ê¸°/ë°°ê²½', 'hobbies', data?.hobbies, 4)}</div>
        ${txtFull('ìƒ˜í”Œ ëŒ€ì‚¬', 'sample_dialogue', data?.sample_dialogue, 6)}
        ${renderEntriesEditor(data?.entries, 'ì¶”ê°€ ì„¤ì •', 'entries')}
        `;
    } else if (type === 'worlds') {
        html += `<div class="mb-4">${ipt('ì œëª©', 'name', data?.name)}</div>`;
        html += `<div class="mb-4">${txtFull('ì„¤ëª…', 'description', data?.description, 10)}</div>`;
        html += renderEntriesEditor(data?.aiRules, 'AI ì—°ì¶œ ì§€ì¹¨', 'aiRules');
        html += renderEntriesEditor(data?.lorebook, 'ë°°ê²½ ë¡œì–´ë¶', 'lorebook', true);
    }

    body.innerHTML = html;
    document.getElementById('modal-title').innerText = id ? 'ìˆ˜ì •' : 'ìƒˆë¡œ ë§Œë“¤ê¸°';
    document.getElementById('modal-delete-btn').classList.toggle('hidden', !id);
    
    const genDetailsBtn = document.getElementById('btn-gen-details');
    if(genDetailsBtn) genDetailsBtn.classList.toggle('hidden', !data?.name); 

    openModalInternal('editor-modal');


    // ëª¨ë‹¬ì´ ì—´ë¦° ì§í›„, ë‚´ë¶€ì˜ ëª¨ë“  textareaì— ë“œë˜ê·¸ í•¸ë“¤ì„ ë¶€ì°©í•©ë‹ˆë‹¤.
    setTimeout(() => {
        const textareas = document.querySelectorAll('#modal-body textarea');
        textareas.forEach(el => makeResizable(el));
    }, 50);


    // ì €ì¥ ë¡œì§
    document.getElementById('modal-save-btn').onclick = () => {
        const newItem = data || { id: Date.now().toString() };
        if (!id && type !== 'users') newItem.id = Date.now().toString();
        
        body.querySelectorAll('input[data-key], textarea[data-key]').forEach(el => newItem[el.dataset.key] = el.value);
        
        body.querySelectorAll('.entries-container').forEach(cont => {
            const key = cont.dataset.key;
            const entries = [];
            cont.querySelectorAll('.entry-item').forEach(item => {
                const title = item.querySelector('.ent-title').value;
                const content = item.querySelector('.ent-content').value;
                if(title || content) { 
                    entries.push({
                        title: title,
                        content: content,
                        keywords: item.querySelector('.ent-keys')?.value || '',
                        enabled: item.querySelector('.ent-enable').checked
                    });
                }
            });
            newItem[key] = entries;
        });

        if (type === 'worlds') {
            const idx = DB.worlds.findIndex(x=>x.id === newItem.id);
            if(idx >= 0) DB.worlds[idx] = newItem; else DB.worlds.push(newItem);
        } else if (type === 'users') {
            const w = DB.worlds.find(x => x.id === worldId);
            if(w) w.user = newItem;
        } else if (type === 'chars') {
            const w = DB.worlds.find(x => x.id === worldId);
            if(w) {
                if(!w.characters) w.characters = [];
                const idx = w.characters.findIndex(c=>c.id === newItem.id);
                if(idx >= 0) w.characters[idx] = newItem; else w.characters.push(newItem);
            }
        }
        saveData(); renderSidebar(); closeModal('editor-modal');
    };
    
    document.getElementById('modal-delete-btn').onclick = () => {
        if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            if(type === 'worlds') DB.worlds = DB.worlds.filter(x=>x.id !== id);
            else if(type === 'chars') DB.worlds.forEach(w => { if(w.characters) w.characters = w.characters.filter(c=>c.id !== id); });
            saveData(); renderSidebar(); closeModal('editor-modal');
        }
    };
}

        window.switchEditorTab = (tab) => {
            document.querySelectorAll('.editor-tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['basic','sexual','depth','extra'].forEach(t => {
                const el = document.getElementById('edit-tab-'+t);
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById('edit-tab-'+tab);
            if(target) target.classList.remove('hidden');
        };
        
        window.switchGeneratorTab = (index) => {
            document.querySelectorAll('.generator-tab-btn').forEach((b, i) => {
                if(i === index) b.classList.add('active'); else b.classList.remove('active');
            });
            document.querySelectorAll('.gen-tab-content').forEach((d, i) => {
                if(i === index) d.classList.remove('hidden'); else d.classList.add('hidden');
            });
        };

        function renderEntriesEditor(entries = [], label, key, isLore=false) {
            const cleanEntries = (entries || []).filter(e => e.title || e.content);
            let html = `<div class="entries-container mt-4" data-key="${key}">
                <div class="flex justify-between items-center mb-2"><label class="font-bold text-sm text-gray-700">${label}</label><button onclick="addEntryRow(this, ${isLore})" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded">+ ì¶”ê°€</button></div>
                <div class="space-y-2 list-area">`;
            cleanEntries.forEach(e => { 
                html += `<div class="entry-item border rounded p-2 bg-gray-50 relative">
                    <div class="flex gap-2 mb-1">
                        <input class="ent-title flex-1 p-1 border text-xs" placeholder="ì œëª©" value="${String(e.title||'').replace(/"/g, '&quot;')}">
                        ${isLore ? `<input class="ent-keys flex-1 p-1 border text-xs" placeholder="í‚¤ì›Œë“œ" value="${String(e.keywords||'').replace(/"/g, '&quot;')}">` : ''}
                        <input type="checkbox" class="ent-enable" ${e.enabled!==false?'checked':''}>
                        <button onclick="this.closest('.entry-item').remove()" class="text-red-500"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <textarea class="ent-content w-full p-1 border text-xs h-16" placeholder="ë‚´ìš©">${e.content||''}</textarea>
                </div>`;
            });
            html += `</div></div>`;
            return html;
        }
        window.addEntryRow = (btn, isLore) => {
            const area = btn.closest('.entries-container').querySelector('.list-area');
            const div = document.createElement('div');
            div.className = "entry-item border rounded p-2 bg-gray-50 relative";
            div.innerHTML = `<div class="flex gap-2 mb-1">
                <input class="ent-title flex-1 p-1 border text-xs" placeholder="ì œëª©">
                ${isLore ? `<input class="ent-keys flex-1 p-1 border text-xs" placeholder="í‚¤ì›Œë“œ">` : ''}
                <input type="checkbox" class="ent-enable" checked>
                <button onclick="this.closest('.entry-item').remove()" class="text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <textarea class="ent-content w-full p-1 border text-xs h-16" placeholder="ë‚´ìš©"></textarea>`;
            area.appendChild(div);
        };

        window.handleTagClick = (btn) => {
            const section = btn.closest('.gen-section');
            const isSingle = section.dataset.single === 'true';
            const tagValue = btn.innerText;

            if (isSingle) {
                Array.from(section.querySelectorAll('.keyword-tag')).forEach(c => {
                     if (c !== btn) c.classList.remove('active');
                });
            }
            btn.classList.toggle('active');

            if (section.id === 'race-section') {
                const beastSection = document.getElementById('beast-detail-section');
                if (beastSection) {
                    if (btn.classList.contains('active') && tagValue === 'ìˆ˜ì¸') {
                         beastSection.classList.add('show');
                         beastSection.classList.remove('hidden-section');
                    } else if (tagValue === 'ìˆ˜ì¸' && !btn.classList.contains('active')) {
                         beastSection.classList.remove('show');
                         beastSection.classList.add('hidden-section');
                         beastSection.querySelectorAll('.keyword-tag').forEach(b => b.classList.remove('active'));
                    } else if (isSingle && btn.classList.contains('active') && tagValue !== 'ìˆ˜ì¸') {
                         beastSection.classList.remove('show');
                         beastSection.classList.add('hidden-section');
                         beastSection.querySelectorAll('.keyword-tag').forEach(b => b.classList.remove('active'));
                    }
                }
            }
        };

        function openAiGeneratorModal(type, worldId=null) {
            window.genType = type; window.genWorldId = worldId;
            const modal = document.getElementById('ai-generator-modal');
            const body = document.getElementById('ai-generator-body'); 
            const tabsContainer = document.getElementById('ai-generator-tabs');
            
            tabsContainer.innerHTML = ''; 
            tabsContainer.classList.add('hidden');
            document.getElementById('btn-random-gen').classList.remove('hidden'); 

            const nsfwToggleHtml = `
                <label class="flex items-center gap-2 cursor-pointer bg-red-50 px-3 py-1 rounded-lg border border-red-100 hover:bg-red-100 transition ml-2">
                    <input type="checkbox" id="gen-nsfw-toggle" class="w-4 h-4 text-red-600 rounded focus:ring-red-500 border-gray-300" checked>
                    <span class="text-xs font-bold text-red-600">ì„±ì¸(NSFW) ëª¨ë“œ</span>
                </label>
            `;

            const headerControls = document.querySelector('#ai-generator-modal .flex.items-center.gap-3');
            const existingToggle = document.getElementById('gen-nsfw-toggle-container');
            if(existingToggle) existingToggle.remove();
            
            const toggleContainer = document.createElement('div');
            toggleContainer.id = 'gen-nsfw-toggle-container';
            toggleContainer.innerHTML = nsfwToggleHtml;
            headerControls.appendChild(toggleContainer);

            if (type.startsWith('creative_')) {
                document.getElementById('btn-random-gen').classList.add('hidden'); 
                const label = type === 'creative_user' ? 'ìœ ì € í˜ë¥´ì†Œë‚˜' : (type === 'creative_world' ? 'ë°°ê²½' : 'ìºë¦­í„°'); 
                
                const placeholderWork = 'ì˜ˆ: ì‘í’ˆëª… ì…ë ¥';
                const placeholderName = type === 'creative_world' ? 'ì˜ˆ: ë°°ê²½ ì´ë¦„' : 'ì˜ˆ: ìºë¦­í„° ì´ë¦„';
                
                let html = `
                <div class="space-y-4">
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-bold text-purple-700 mb-2"><i class="fa-solid fa-search mr-2"></i>ì›¹ ê²€ìƒ‰ ê¸°ë°˜ ${label} ìƒì„±</h4>
                        <p class="text-sm text-purple-600 mb-4">ìœ ëª… ì°½ì‘ë¬¼ì˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´, AIê°€ ì›¹ ì§€ì‹ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •ì„ ìë™ ì¶”ì¶œí•˜ì—¬ ì‘ì„±í•©ë‹ˆë‹¤.</p>
                        
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì°½ì‘ë¬¼ ì´ë¦„ (ì‘í’ˆëª…)</label>
                        <input type="text" id="creative-work-name" class="w-full p-2 border rounded mb-3 bg-white" placeholder="${placeholderWork}">
                `;
                
                if (type !== 'creative_world') {
                    html += `
                        <label class="block text-sm font-bold text-gray-700 mb-1">${label} ì´ë¦„</label>
                        <input type="text" id="creative-char-name" class="w-full p-2 border rounded bg-white mb-3" placeholder="${placeholderName}">
                        
                        <!-- ì„±ë³„ ì„ íƒ ì‚­ì œ (AI ìë™ íŒë‹¨) -->
                        <div class="text-xs text-gray-500 mb-3"><i class="fa-solid fa-robot mr-1"></i>ì„±ë³„ì€ ì´ë¦„ê³¼ ë§¥ë½ì— ë”°ë¼ AIê°€ ìë™ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤.</div>
                    `;
                } else {
                     html += `<p class="text-xs text-gray-500">* ë°°ê²½ ì´ë¦„ì€ ì°½ì‘ë¬¼ ì´ë¦„ìœ¼ë¡œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤.</p>`;
                }
                
                html += `
                        <div class="mt-4 border-t border-purple-200 pt-3">
                            <label class="block text-sm font-bold text-gray-700 mb-1">ì¶”ê°€ ìš”êµ¬ì‚¬í•­</label>
                            <textarea id="ai-prompt-extra" class="w-full p-2 border rounded bg-white text-sm" rows="2" placeholder="ì˜ˆ: ì›ì‘ë³´ë‹¤ ë” íƒ€ë½í•˜ê²Œ ë§Œë“¤ì–´ì¤˜, ì„±ê²©ì„ ë” ìˆœì¢…ì ìœ¼ë¡œ ë³€ê²½í•´ì¤˜"></textarea>
                        </div>
                    </div>
                </div>`;
                
                body.innerHTML = html;
                openModalInternal('ai-generator-modal');
                return;
            }

            const config = aiGeneratorConfig[type];
            if (!config) { alert('ì„¤ì • ì˜¤ë¥˜: ' + type); return; }

            let html = '';
            const renderSection = (s) => `
                <div id="${s.id||''}" class="mb-3 gen-section ${s.hidden ? 'hidden-section' : ''}" data-level="${s.level||1}" data-single="${s.singleChoice}">
                    <h4 class="font-bold text-sm text-gray-700 mb-1">${s.title}</h4>
                    <div class="flex flex-wrap gap-2">
                        ${(s.tags||[]).map(t => `<button onclick="handleTagClick(this)" class="keyword-tag px-3 py-1 bg-white border rounded-full text-xs transition">${t}</button>`).join('')}
                    </div>
                </div>`;
            
            if(config.tabs) {
                tabsContainer.classList.remove('hidden');
                config.tabs.forEach((t, i) => {
                    tabsContainer.innerHTML += `<button class="generator-tab-btn ${i===0?'active':''}" onclick="switchGeneratorTab(${i})">${t.name}</button>`;
                    html += `<div class="gen-tab-content ${i===0?'':'hidden'} space-y-3 pb-4 border-b border-gray-200 mb-4">${t.sections.map(renderSection).join('')}</div>`;
                });
            } else if (config.sections) {
                html += `<div class="space-y-3 gen-tab-content pb-4 border-b border-gray-200 mb-4">${config.sections.map(renderSection).join('')}</div>`;
            }

            html += `
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label class="block text-sm font-bold text-gray-700 mb-1"><i class="fa-solid fa-pen-to-square mr-1"></i>ì¶”ê°€ ìš”êµ¬ì‚¬í•­</label>
                    <textarea id="ai-prompt-extra" class="w-full p-2 border rounded bg-white text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" rows="2" placeholder="ì„ íƒí•œ í‚¤ì›Œë“œ ì™¸ì— íŠ¹ë³„íˆ ì›í•˜ëŠ” ì„¤ì •ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>
            `;
            
            body.innerHTML = html;
            openModalInternal('ai-generator-modal');
        }

        function randomizeTab() {
            const activeTab = document.querySelector('.gen-tab-content:not(.hidden)');
            if(!activeTab) return;

            const raceSection = activeTab.querySelector('#race-section');
            let selectedRace = null;

            if (raceSection) {
                const buttons = Array.from(raceSection.querySelectorAll('.keyword-tag'));
                buttons.forEach(b => b.classList.remove('active')); 
                
                const choice = buttons[Math.floor(Math.random() * buttons.length)];
                choice.classList.add('active');
                selectedRace = choice.innerText;

                handleTagClick(choice);
            }

            const sections = activeTab.querySelectorAll('.gen-section');
            sections.forEach(sec => {
                if (sec.id === 'race-section') return; 

                const level = parseInt(sec.dataset.level || 1);
                const buttons = Array.from(sec.querySelectorAll('.keyword-tag'));
                
                buttons.forEach(b => b.classList.remove('active'));

                if (sec.id === 'beast-detail-section') {
                    if (selectedRace === 'ìˆ˜ì¸') {
                        const choice = buttons[Math.floor(Math.random() * buttons.length)];
                        choice.classList.add('active');
                    }
                    return; 
                }

                let prob = 1.0; 
                if (level === 2) prob = 0.8;
                else if (level === 3) prob = 0.4;

                if (Math.random() < prob && buttons.length > 0) {
                    const choice = buttons[Math.floor(Math.random() * buttons.length)];
                    choice.classList.add('active');
                }
            });
        }

        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

async function handleGenerateClick() {
    if(!SETTINGS.apiKey) return alert('API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
    
    const type = window.genType;
    const extra = document.getElementById('ai-prompt-extra') ? document.getElementById('ai-prompt-extra').value : '';
    const isNSFW = document.getElementById('gen-nsfw-toggle')?.checked;

    let tags = '';
    
    if (!type.startsWith('creative_')) {
        tags = Array.from(document.querySelectorAll('.keyword-tag.active')).map(el => el.innerText).join(', ');
    }

    document.getElementById('modal-loading-overlay-ai').classList.remove('hidden');
    document.getElementById('modal-loading-overlay-ai').classList.add('flex');
    document.getElementById('ai-retry-msg').classList.add('hidden');
    document.getElementById('ai-error-msg').classList.add('hidden');
    
    isGenerating = true; 
    isCancellationRequested = false;

    if (currentAbortController) currentAbortController.abort();
    currentAbortController = new AbortController();

    const startTime = Date.now();
    const timeDisplay = document.getElementById('ai-progress-time');
    timeDisplay.classList.remove('hidden');
    timeDisplay.innerText = "0ì´ˆ ê²½ê³¼";
    
    let intervalId = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timeDisplay.innerText = `${elapsed}ì´ˆ ê²½ê³¼`;
    }, 1000);
    
    const ageUnknown = tags.includes('ë‚˜ì´ ë¯¸ìƒ');
    let ageRule = `Rule 3: For 'age', 'height', 'weight', use ARABIC NUMERALS.`;
    if (ageUnknown) {
        ageRule = `Rule 3: For 'height', 'weight' use ARABIC NUMERALS. HOWEVER, for 'age', MUST output string "ë¯¸ìƒ" (Unknown).`;
    }

    let prompt = `You are a system creating a JSON profile for a Novel.
    Rule 1: Output VALID JSON ONLY. No Markdown. No intro/outro text.
    Rule 2: [IMPORTANT] The main content MUST be in KOREAN (í•œêµ­ì–´). HOWEVER, for "Names" (character/user name), follow the source material's context (KOREAN SCRIPT / e.g., "Alice" -> "ì•¨ë¦¬ìŠ¤").
    ${ageRule}
    Rule 4: 'three_sizes' should be formatted like "90-60-90" (Numbers).
    Rule 5: 'sample_dialogue' MUST use \\n for newlines.
    Rule 6: [CRITICAL] Escape all double quotes inside string values.
    
    Selected Tags: ${tags}.
    Extra Instructions: ${extra}.
    
    Constraint: ì„±ê°ëŒ€(erogenous_zones)ì™€ í˜í‹°ì‹œ(fetish)ëŠ” 1ê°œë§Œ ì‘ì„±í•œë‹¤.
    Constraint: ìƒì„¸ ì„¤ì •(entries) ì™¸ì—ë„ 'dialogue_depth'(ë§íˆ¬ ì‹¬í™”), 'sexual_psyche'(ì„±ì  ì‹¬ë¦¬), 'sexual_behavior'(ì„±ì  í–‰ë™) í•„ë“œë¥¼ í’ë¶€í•˜ê²Œ ì‘ì„±í•  ê²ƒ.
    Constraint: [IMPORTANT] Provide AT LEAST 5 distinct lines for 'sample_dialogue' to fully showcase personality.
    `;
    
    // [ìˆ˜ì •] ìƒì„±ìš© NSFW ê°€ì´ë“œë¼ì¸ (ì—ë¡œ/í—¨íƒ€ì´ í¬ì»¤ìŠ¤)
    if (isNSFW) {
        prompt += `\n[WARNING: R-18 Hentai/Ero Generation Mode]
    1. **Genre**: Hentai, Eroge, Adult content. (NOT Dark/Hardcore/Gore).
    2. **Tone**: Focus on 'Physical Pleasure', 'Sexual Excitement', and 'High Sensitivity' (Ahegao style).
    3. **Characterization**: 
       - Describe 'sexual_psyche' as melting/succumbing to pleasure, NOT feeling pain or deep trauma.
       - Highlight the contrast between their social persona and their lewd instincts (Gap Moe).
    4. **Constraint**: Do NOT include extreme violence, gore, or depressing themes. Focus on arousal and eroticism.`;
    } else {
        prompt += `\nIMPORTANT: Keep it Safe For Work (SFW). Focus on personality and story traits. Do NOT include explicit sexual descriptions.`;
    }

    if (tags.includes('ì„±ì— ë¬´ì§€í•¨')) {
            prompt += `\nIMPORTANT: Character is COMPLETELY IGNORANT about sex/pregnancy.`;
    }

    if (tags.includes('ìˆ˜ì¸') || tags.includes('Beastkin')) {
        prompt += `\nConstraint: [CRITICAL] For 'ìˆ˜ì¸' (Beastkin), the character MUST look like a beautiful HUMAN with animal ears/tail (Kemonomimi style). STRICTLY NO Furry, NO Anthro faces. The face must be human.`;
    }

    // (ì´í•˜ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼)
    if (type === 'worlds') {
        const isHeavy = tags.includes('ì•„í¬ì¹¼ë¦½ìŠ¤') || tags.includes('í—Œí„°ë¬¼') || tags.includes('ë””ìŠ¤í† í”¼ì•„') || tags.includes('ì‹œë¦¬ì–´ìŠ¤');
        if (!isHeavy) prompt += `\nConstraint: Create a world matching the genre. Focus on the specific mood selected.\n`;
        
        if (tags.includes('ì •ì¡°ì—­ì „') || tags.includes('ë‚¨ë…€ì—­ì „')) {
            prompt += `\n[SPECIAL GENRE: REVERSE CHASTITY (ì •ì¡°ì—­ì „)]
            1. World Concept: Common sense of gender sexuality is completely REVERSED. Women are aggressive, lustful predators. Men are chaste, conservative, and protected.
            2. Male Value: Men are rare or physically weaker, making them highly valuable. A "virgin male" is a national treasure.
            3. Protagonist (User): He is a 'Normal' man from Earth or simply open-minded. Just by doing basic things (paying for dinner, opening doors, smiling), women are overwhelmingly touched and fall in love (Healing/Pampering atmosphere).
            4. Atmosphere: Not just porn, but a 'Healing Harem' where the protagonist is pampered by powerful/rich women.`;
        }
    }

    if (type.startsWith('creative_')) {
        const workName = document.getElementById('creative-work-name').value;
        const charName = document.getElementById('creative-char-name') ? document.getElementById('creative-char-name').value : workName;
        const targetName = type === 'creative_world' ? workName : charName;
        
        let genderInstruction = "Gender: Determine automatically based on the name/role/context. If ambiguous, choose the most likely gender.";
        let structureGender = "Determine by context"; 

        prompt += `
        Task: Generate a profile for "${targetName}" from the work "${workName}".
        ${genderInstruction}
        Extra User Instructions: ${extra} (Must be prioritized)
        
        Constraint: If age is unknown, set to "ë¯¸ìƒ".
        Constraint: 'sample_dialogue' MUST use actual lines from the original work. Provide 5+ lines.
        Constraint: ìƒì„¸ ì„¤ì •(entries) ì‘ì„± ì‹œ, ìºë¦­í„°ì˜ ê°œì„±ì´ ë“œëŸ¬ë‚˜ê²Œ ì¸ê°„ê´€ê³„, ê²ªì€ ì‚¬ê±´, íŠ¹ì§•, ë§íˆ¬ ë“±ì„ ìµœëŒ€í•œ ìƒì„¸í•˜ê²Œ ì‘ì„±í•  ê²ƒ.        `;
        
        // ì°½ì‘ë¬¼ ê²€ìƒ‰ ì‹œì—ë„ í†¤ ë§¤ë„ˆ ìœ ì§€
        if(isNSFW) {
             prompt += `IMPORTANT: Reinterpret the character with the 'Hentai/Eroge' tone defined above. Focus on their hidden desires or how they would react in an erotic situation, while keeping their original speech patterns.`;
        }

        if (type === 'creative_user') {
                prompt += `Type: User Persona. Output Structure: { name: "${targetName}", age, gender: "${structureGender}", hair_style, outfit, features, hobbies, sample_dialogue, entries: [{title: "Background", content: "..."}] }`;
        } else if (type === 'creative_world') {
                prompt += `Type: World. Output Structure: { name: "${workName}", genre: "Fantasy/SF/Modern etc", emoji: "One Emoji(  /  /etc)", description, aiRules:[{title, content}], lorebook:[{title, keywords, content}] }`;
        } else {
                prompt += `Type: Character.
                Output Structure: { name: "${targetName}", source_material: "${workName}", gender: "${structureGender}", age, race, skin, height, weight, three_sizes, body_type, hair_style, eyes, job, accessories, tattoo, appearance_desc, sample_dialogue, personality_tags, voice, perverted_features, mental_state, erogenous_zones, fetish, underwear, pubic_hair, dialogue_depth, sexual_psyche, sexual_behavior, entries: [{title: "Relations", content: "..."}] }`;
        }
} else if (type === 'chars') {
        const w = DB.worlds.find(x => x.id === window.genWorldId);
        // ë¡œì–´ë¶ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const worldLore = w ? (w.lorebook || []).map(l => `[World Lore: ${l.title}] ${l.content}`).join('\n') : '';

        let selectedGender = "ì—¬ì„±"; 
        if(tags.includes("ë‚¨ì„±")) selectedGender = "ë‚¨ì„±";
        if(tags.includes("ì¤‘ì„±")) selectedGender = "ì¤‘ì„±";

        // [ìˆ˜ì •ë¨] worldLore ë³€ìˆ˜ë¥¼ í”„ë¡¬í”„íŠ¸ì— ì‹¤ì œë¡œ ì‚½ì…
        prompt += `Context World: "${w ? w.name : 'Unknown'}". 
        
        [World Context & Lore]
        ${worldLore}
        
        Task: Create a unique ${selectedGender} Character JSON based on the world context above.`;
        
        if(isNSFW) prompt += ` (Follow the R-18 Hentai guidelines).`;
        prompt += `Structure: { name, gender: "${selectedGender}", age, race, skin, height, weight, three_sizes, body_type, hair_style, eyes, job, accessories, tattoo, appearance_desc, sample_dialogue, personality_tags, voice, perverted_features, mental_state, erogenous_zones, fetish, underwear, pubic_hair, dialogue_depth, sexual_psyche, sexual_behavior, entries: [{title: "ì„¤ì •", content: "..."}] }`;
    } else if (type === 'users') {
        const w = DB.worlds.find(x => x.id === window.genWorldId);
        // ë¡œì–´ë¶ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const worldLore = w ? (w.lorebook || []).map(l => `[World Lore: ${l.title}] ${l.content}`).join('\n') : '';

        let selectedGender = "ë‚¨ì„±"; 
        if(tags.includes("ì—¬ì„±")) selectedGender = "ì—¬ì„±";
        if(tags.includes("ì¤‘ì„±")) selectedGender = "ì¤‘ì„±";

        // [ìˆ˜ì •ë¨] worldLore ë³€ìˆ˜ë¥¼ í”„ë¡¬í”„íŠ¸ì— ì‹¤ì œë¡œ ì‚½ì…
        prompt += `Context World: "${w ? w.name : 'Unknown'}".
        
        [World Context & Lore]
        ${worldLore}
        
        Task: Create a ${selectedGender} User Persona JSON suitable for this world.`;
        
        prompt += `Structure: { name, age, gender: "${selectedGender}", hair_style, outfit, features, hobbies, sample_dialogue, entries: [{title: "ë°°ê²½", content: "..."}] }`;
    }

// â–¼â–¼â–¼ [ì—¬ê¸°] ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš” â–¼â–¼â–¼
    else if (type === 'worlds') {
        prompt += `
        Task: Create a detailed World Setting JSON based on the selected tags.
        
        [Requirements]
        1. Name: A creative title for the world.
        2. Description: Detailed world introduction, atmosphere, and current situation (At least 300 characters).
        3. Rules(aiRules): 3~5 core rules that AI must follow in this world (e.g., "Magic requires blood", "Night is dangerous").
        4. Lorebook: 3~5 key setting elements (Locations, Factions, History).
        
        Output Structure: { name, genre, emoji, description, aiRules: [{title, content}], lorebook: [{title, keywords, content}] }
        `;
    }
    // â–²â–²â–² [ì—¬ê¸°] ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ â–²â–²â–²

    const safetySettings = SETTINGS.uncensored 
        ? [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
            ]
        : [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
        ];

    // (ì´í•˜ fetch ë° ì²˜ë¦¬ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼)
    let retryCount = 0;
    const maxRetries = 3;
    let success = false;
    let finalData = null;

    while(retryCount < maxRetries && !success) {
        if (isCancellationRequested) break;

        try {
            const requestBody = { 
                contents: [{ parts: [{ text: prompt }] }],
                safetySettings: safetySettings
            };
            
            const modelToUse = SETTINGS.currentModel || 'gemini-3-pro';

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${SETTINGS.apiKey}`, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestBody),
                signal: currentAbortController.signal 
            });
            
            if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
            const result = await response.json();
            
            if (!result.candidates || result.candidates.length === 0) throw new Error("BLOCK_FILTER"); 
            if (!result.candidates[0].content || !result.candidates[0].content.parts) throw new Error("BLOCK_FILTER"); 

            let text = result.candidates[0].content.parts[0].text;
            text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
            text = text.replace(/\\(?!["\\/bfnrtu])/g, ""); 
            
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            
            if (firstBrace !== -1 && lastBrace !== -1) { 
                text = text.substring(firstBrace, lastBrace + 1);
            } else {
                throw new Error("ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }

            let rawData = JSON.parse(text);
            let data = rawData;

            if (rawData.character) data = rawData.character;
            else if (rawData.user) data = rawData.user;
            else if (rawData.world) data = rawData.world;
            else if (rawData.result) data = rawData.result;
            else if (rawData.output) data = rawData.output;
            
            if (data.sample_dialogue) {
                let lines = [];
                if (Array.isArray(data.sample_dialogue)) {
                    lines = data.sample_dialogue.map(l => typeof l === 'string' ? l : JSON.stringify(l));
                } else if (typeof data.sample_dialogue === 'string') {
                    lines = data.sample_dialogue.split('\n').map(l => l.trim()).filter(l => l);
                }
                data.sample_dialogue = lines.map(line => {
                    let cleanLine = line;
                    if (cleanLine.startsWith('"') && cleanLine.endsWith('"')) return cleanLine;
                    if (cleanLine.startsWith('"')) cleanLine = cleanLine.substring(1);
                    if (cleanLine.endsWith('"')) cleanLine = cleanLine.substring(0, cleanLine.length - 1);
                    return '"' + cleanLine.replace(/"/g, '\\"') + '"';
                }).join('\n');
            }


            if(!data.entries) data.entries = [];
            if(type.includes('chars') || type === 'creative_char') { if(!data.lorebook) data.lorebook = []; }
            if(type.includes('world')) { if(!data.aiRules) data.aiRules = []; if(!data.lorebook) data.lorebook = []; }

            finalData = data;
            success = true;

        } catch(e) { 
            if (e.name === 'AbortError' || isCancellationRequested) {
                break;
            }
            console.log(`Attempt ${retryCount+1} failed: ${e.message}`);
            
            if (e.message === "BLOCK_FILTER") {
                document.getElementById('ai-error-msg').innerText = "âš ï¸ ìƒì„±ëœ ë‚´ìš©ì´ ì•ˆì „ ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.";
                document.getElementById('ai-error-msg').classList.remove('hidden');
                retryCount = maxRetries; 
            } else {
                retryCount++;
                if(retryCount < maxRetries) {
                    document.getElementById('ai-retry-msg').classList.remove('hidden');
                    document.getElementById('ai-retry-msg').innerText = `ì˜¤ë¥˜(${e.message}). ì¬ì‹œë„ ì¤‘... (${retryCount}/${maxRetries})`;
                    await sleep(1500); 
                } else {
                        alert(`ìƒì„± ì‹¤íŒ¨: ${e.message}`);
                }
            }
        }
    }
    
    clearInterval(intervalId);
    timeDisplay.classList.add('hidden');
    isGenerating = false; 

    if(isCancellationRequested || (currentAbortController && currentAbortController.signal.aborted)) {
            document.getElementById('modal-loading-overlay-ai').classList.add('hidden');
            document.getElementById('modal-loading-overlay-ai').classList.remove('flex');
            showMessage("AI ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
    }

    if(success && finalData) {
        document.getElementById('modal-loading-overlay-ai').classList.add('hidden');
        document.getElementById('modal-loading-overlay-ai').classList.remove('flex');
        closeModal('ai-generator-modal');
        let editorType = type;
        if(type === 'creative_char') editorType = 'chars';
        if(type === 'creative_user') editorType = 'users';
        if(type === 'creative_world') editorType = 'worlds';
        openEditor(null, editorType, finalData, window.genWorldId);
    } else {
            if(!success) {
            document.getElementById('modal-loading-overlay-ai').querySelector('.fa-spinner').classList.add('hidden');
            document.getElementById('ai-progress-time').classList.add('hidden');
            }
    }
}


        async function generateDetails() {
            if(!SETTINGS.apiKey) return alert('API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
            
            const currentData = {};
            document.querySelectorAll('#modal-body input[data-key], #modal-body textarea[data-key]').forEach(el => currentData[el.dataset.key] = el.value);
            
            let activeTab = 'details';
            const activeBtn = document.querySelector('.editor-tab-btn.active');
            if (activeBtn) {
                if (activeBtn.innerText.includes('ê¸°ë³¸')) activeTab = 'basic';
                else if (activeBtn.innerText.includes('ì„±ì ')) activeTab = 'sexual';
                else if (activeBtn.innerText.includes('ì‹¬í™”')) activeTab = 'depth';
            }
            
            isDetailGenCancelled = false;
            if (currentAbortController) currentAbortController.abort();
            currentAbortController = new AbortController();

            document.getElementById('modal-loading-overlay-details').classList.remove('hidden');
            document.getElementById('modal-loading-overlay-details').classList.add('flex');

            const commonRules = `
            Rule: Output VALID JSON ONLY.
            Rule: Use KOREAN language for text content.
            Rule: 'sample_dialogue' lines MUST be enclosed in double quotes ("Example Dialogue").
            Rule: Escape all double quotes inside strings.
            Rule: Do not put unescaped newlines in JSON strings. Use \\n instead.
            `;

            let prompt = "";
            if (activeTab === 'basic') {
                prompt = `Update Basic Info JSON. Fill missing fields: name, age, race, height, weight, three_sizes, skin, body_type, hair_style, eyes, job, accessories, tattoo, appearance_desc, personality_tags, mental_state, sample_dialogue, voice. 
                ${commonRules}
                Current: ${JSON.stringify(currentData)}`;
            } else if (activeTab === 'sexual') {
                prompt = `Update Sexual Info JSON. Fill missing fields: erogenous_zones, fetish, perverted_features, underwear, pubic_hair.
                Constraint: Select ONLY ONE distinct/extreme trait for 'fetish' and 'erogenous_zones'.
                ${commonRules}
                Current: ${JSON.stringify(currentData)}`;
            } else if (activeTab === 'depth') {
                prompt = `Update Depth Info JSON. Generate detailed text for: 
                1. 'dialogue_depth' (How speech changes under stress/pleasure)
                2. 'sexual_psyche' (Internal conflict, desires, corruption process)
                3. 'sexual_behavior' (Behavior patterns from resistance to submission)
                
                ${commonRules}
                Current: ${JSON.stringify(currentData)}`;
            } else {
                prompt = `Generate detailed 'entries' and 'lorebook'.
                Profile: ${JSON.stringify(currentData)}
                IMPORTANT: Create SEPARATE objects in the 'entries' array for distinct topics like Human Relations, Past Events, Secrets, etc. Do NOT merge them into one.
                ${commonRules}
                Response JSON: { entries: [ {title: "Relations", content: "..."}, {title: "Past", content: "..."} ], lorebook: [ {title, keywords, content} ] }`;
            }
            
            const safetySettings = SETTINGS.uncensored 
                ? [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                  ]
                : [
                     { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                ];

            try {
                const modelToUse = SETTINGS.currentModel || 'gemini-3-pro';
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${SETTINGS.apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        safetySettings: safetySettings 
                    }),
                    signal: currentAbortController.signal
                });
                
                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0] || !result.candidates[0].content) {
                     throw new Error("âš ï¸ AIê°€ ë‹µë³€ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤ (ì•ˆì „ í•„í„°).");
                }

                let text = result.candidates[0].content.parts[0].text;
                text = text.replace(/\\(?!["\\/bfnrtu])/g, "");
                text = text.replace(/^```json\s*/i, '').replace(/^```\s*$/i, '').replace(/`/g, '').trim();
                
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) { text = text.substring(firstBrace, lastBrace + 1); }

                let data = JSON.parse(text);
                if (data.character) data = data.character; 

                if(isDetailGenCancelled) return;

                if (activeTab === 'basic' || activeTab === 'sexual' || activeTab === 'depth') {
                    Object.keys(data).forEach(key => {
                        const input = document.querySelector(`[data-key="${key}"]`);
                        if (input && (!input.value || input.value.length < 5)) input.value = data[key]; 
                    });
                } else {
                    const entriesList = document.querySelector('.entries-container[data-key="entries"] .list-area');
                    if(data.entries && entriesList) {
                        data.entries.forEach(e => {
                            const div = document.createElement('div'); div.className = "entry-item border rounded p-2 bg-gray-50 relative";
                            div.innerHTML = `<div class="flex gap-2 mb-1"><input class="ent-title flex-1 p-1 border text-xs" value="${e.title}"><input type="checkbox" class="ent-enable" checked><button onclick="this.closest('.entry-item').remove()" class="text-red-500"><i class="fa-solid fa-times"></i></button></div><textarea class="ent-content w-full p-1 border text-xs h-16">${e.content}</textarea>`;
                            entriesList.appendChild(div);
                        });
                    }
                    const loreList = document.querySelector('.entries-container[data-key="lorebook"] .list-area');
                    if(data.lorebook && loreList) {
                        data.lorebook.forEach(e => {
                            const div = document.createElement('div'); div.className = "entry-item border rounded p-2 bg-gray-50 relative";
                            div.innerHTML = `<div class="flex gap-2 mb-1"><input class="ent-title flex-1 p-1 border text-xs" value="${e.title}"><input class="ent-keys flex-1 p-1 border text-xs" value="${e.keywords}"><input type="checkbox" class="ent-enable" checked><button onclick="this.closest('.entry-item').remove()" class="text-red-500"><i class="fa-solid fa-times"></i></button></div><textarea class="ent-content w-full p-1 border text-xs h-16">${e.content}</textarea>`;
                            loreList.appendChild(div);
                        });
                    }
                }

            } catch(e) { 
                if (e.name !== 'AbortError' && !isDetailGenCancelled) alert(e.message); 
            }
            finally { 
                document.getElementById('modal-loading-overlay-details').classList.add('hidden');
                document.getElementById('modal-loading-overlay-details').classList.remove('flex');
            }
        }

        function loadSession(id) {
            if(window.typingTimer) {
                clearInterval(window.typingTimer);
                window.typingTimer = null;
            }
            typingQueue = [];
            isTyping = false;
            
            currentSessionId = id;
            const s = DB.chats.find(c=>c.id===id);
            const p = document.getElementById('content-area');
            p.innerHTML = ''; 
            document.getElementById('header-title').innerText = s.title;
            document.getElementById('header-info').classList.remove('hidden');
            document.getElementById('input-area').classList.remove('hidden'); document.getElementById('input-area').classList.add('flex');
            isDirectorMode = s.isDirectorMode || false; 
            
            const infoWorld = document.getElementById('info-world');
            if (s.isNovelMode) {
                infoWorld.innerHTML = '<i class="fa-solid fa-book-open"></i> ì†Œì„¤ ëª¨ë“œ';
            } else {
                const w = DB.worlds.find(x => x.id === s.worldId);
                infoWorld.innerHTML = `<i class="fa-solid fa-globe"></i> ${w ? w.name : '-'}`;
            }

// loadSession í•¨ìˆ˜ ë‚´ë¶€ì˜ forEach ë¶€ë¶„ë§Œ ì•„ë˜ì²˜ëŸ¼ ë³€ê²½ (index 'i' ì¶”ê°€)
if(s.history) s.history.forEach((msg, i) => appendMessage(msg, false, i));
            renderRightSidebar(); // Update right sidebar info
            setTimeout(scrollToBottom, 50);
        }

// â–¼â–¼â–¼ [ìˆ˜ì •ë¨] ë©”ì‹œì§€ ì¶œë ¥ ì‹œ 'ìˆ˜ì •ì°½'ì—ë§Œ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ë¶€ì°© â–¼â–¼â–¼
function appendMessage(msg, animate = false, index = null) {
    const p = document.getElementById('content-area');
    if (p.querySelector('#empty-state')) p.innerHTML = '';

    if (index === null && currentSessionId) {
        const chat = DB.chats.find(c => c.id === currentSessionId);
        index = chat ? chat.history.length - 1 : 0;
    }

    const isUser = msg.role === 'user';
    const isDirector = msg.role === 'director';
    const isBookmarked = msg.bookmarked || false;

    const div = document.createElement('div');
    div.className = `msg-wrapper group ${isUser ? 'user' : (isDirector ? 'director' : 'model')} relative`;
    div.dataset.index = index;

    const bookmarkIndicator = isBookmarked 
        ? `<div class="absolute -top-3 left-1/2 transform -translate-x-1/2 text-yellow-500 text-xs z-10"><i class="fa-solid fa-bookmark"></i></div>` 
        : '';

    const toolsHtml = `
        <div class="msg-tools absolute right-0 -bottom-8 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1 z-10">
            <button onclick="toggleBookmark(${index})" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-yellow-100 text-gray-400 ${isBookmarked ? 'text-yellow-500' : 'hover:text-yellow-600'}" title="ì±…ê°ˆí”¼">
                <i class="${isBookmarked ? 'fa-solid' : 'fa-regular'} fa-bookmark text-sm"></i>
            </button>
            <button onclick="copyMessage(${index})" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-green-100 text-gray-400 hover:text-green-600" title="ë‚´ìš© ë³µì‚¬">
                <i class="fa-regular fa-copy text-sm"></i>
            </button>
            <button onclick="enableEditMessage(${index})" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-indigo-100 text-gray-400 hover:text-indigo-600" title="ìˆ˜ì •">
                <i class="fa-solid fa-pen text-sm"></i>
            </button>
            <button onclick="deleteMessage(${index})" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100 text-gray-400 hover:text-red-500" title="ì‚­ì œ">
                <i class="fa-solid fa-trash text-sm"></i>
            </button>
        </div>
    `;

    div.innerHTML = `
        ${bookmarkIndicator}
        <div class="msg-container relative">
            ${toolsHtml}
            <div class="novel-text model-content" id="msg-content-${index}">${animate ? '' : marked.parse(msg.text)}</div>
            
            <div id="msg-editor-${index}" class="hidden mt-2">
                <textarea class="w-full p-3 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white shadow-inner resize-none mb-2" rows="5"></textarea>
                <div class="flex justify-end gap-2">
                    <button onclick="cancelEditMessage(${index})" class="px-3 py-1 text-xs text-gray-500 hover:bg-gray-100 rounded">ì·¨ì†Œ</button>
                    <button onclick="saveEditMessage(${index})" class="px-3 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700 font-bold">ì €ì¥</button>
                </div>
            </div>
        </div>`;

    p.appendChild(div);

    // â–¼â–¼â–¼ [í•µì‹¬] ì—¬ê¸°ì„œ ìˆ˜ì •ìš© textareaë¥¼ ì°¾ì•„ì„œ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ì„ ë‹¬ì•„ì¤ë‹ˆë‹¤ â–¼â–¼â–¼
    const editTextarea = div.querySelector(`#msg-editor-${index} textarea`);
    if (editTextarea) {
        makeResizable(editTextarea);
    }
    // â–²â–²â–² [ë] â–²â–²â–²

    if (!isUser && !isDirector) {
        const target = div.querySelector('.model-content');
        currentMsgElement = target;
        if (animate) {
            typingQueue = msg.text.split('');
            if (!isTyping) startTyping();
        }
    }
}
        
        function startTyping() {
            isTyping = true;
            let renderedText = '';
            const speed = SETTINGS.typingSpeed || 15; 
            const contentArea = document.getElementById('content-area');
            
            if(window.typingTimer) clearInterval(window.typingTimer);

            window.typingTimer = setInterval(() => {
                const selection = window.getSelection();
                const isSelecting = selection && selection.type === 'Range' && !selection.isCollapsed;
                const isNearBottom = contentArea.scrollHeight - contentArea.scrollTop - contentArea.clientHeight < 100;

                if(typingQueue.length > 0) {
                    renderedText += typingQueue.shift();
                    if(currentMsgElement) currentMsgElement.innerHTML = marked.parse(renderedText);
                    
                    if (!isSelecting && isNearBottom) {
                        scrollToBottom();
                    }
                } else { 
                    clearInterval(window.typingTimer); 
                    window.typingTimer = null;
                    isTyping = false; 
                    saveData();
                }
            }, speed);
        }

        function scrollToBottom() { 
            const d = document.getElementById('content-area'); 
            d.scrollTop = d.scrollHeight;
        }
        
// [ìˆ˜ì •] cancelGeneration í•¨ìˆ˜ (ë²„íŠ¼ ìˆ¨ê¹€ ë¡œì§ ì œê±° -> ìƒíƒœ ë³€ê²½ìœ¼ë¡œ ëŒ€ì²´)
function cancelGeneration() {
    if (isTextGenerating) {
        if (textAbortController) textAbortController.abort();
        if (window.typingTimer) clearInterval(window.typingTimer);

        typingQueue = [];
        isTextGenerating = false;

        // [ë³€ê²½] ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
        updateSendButtonState('idle');
        
        showMessage('ì±„íŒ… ìƒì„±ì´ ì¤‘ë‹¨ë¨');
    }
            
            // ëª¨ë‹¬ ìƒì„± ì·¨ì†Œë„ ê²¸í•¨
            if (isGenerating) {
                isCancellationRequested = true;
                if(currentAbortController) currentAbortController.abort();
                isGenerating = false;
                document.getElementById('modal-loading-overlay-ai').classList.add('hidden');
                document.getElementById('modal-loading-overlay-ai').classList.remove('flex');
            }
        }
        

window.callGemini = async function(chat, signalObj) {
    if (!SETTINGS.apiKey) throw new Error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

    // 1. í‚¤ì›Œë“œ/ë¡œì–´ë¶ ê°ì§€
    const recentHistory = chat.history.slice(-3).map(h => h.text).join('\n');
    
    // ê¸€ë¡œë²Œ ë¡œì–´ë¶ ê°ì§€
    const activeGlobal = detectActiveLore(SETTINGS.globalLorebook, recentHistory);
    
    // ë°°ê²½(World) ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let activeWorldLore = { entries: [], triggers: [] };
    let worldRulesStr = ""; // ë°°ê²½ ì „ìš© AI ì§€ì¹¨ ë¬¸ìì—´ ì´ˆê¸°í™”
    
    const w = DB.worlds.find(x => x.id === chat.worldId);
    if (w) {
        // A. ë°°ê²½ ë¡œì–´ë¶ ê°ì§€ (í‚¤ì›Œë“œ ë§¤ì¹­ or ìƒì‹œ ì ìš©)
        activeWorldLore = detectActiveLore(w.lorebook, recentHistory);
        
        // B. ë°°ê²½ AI ì—°ì¶œ ì§€ì¹¨(aiRules) ê°€ì ¸ì˜¤ê¸° [ì¶”ê°€ëœ ë¶€ë¶„]
        if (w.aiRules && w.aiRules.length > 0) {
            worldRulesStr = w.aiRules
                .filter(r => r.enabled !== false) // ì²´í¬ í•´ì œëœ ê²ƒ ì œì™¸
                .map(r => `[World Rule: ${r.title}] ${r.content}`)
                .join('\n');
        }
    }
    
    const allTriggers = [...activeGlobal.triggers, ...activeWorldLore.triggers];

    // 2. ì‹ ê·œ ì„¤ì •ê°’ í”„ë¡¬í”„íŠ¸ ë³€í™˜ (ê¸°ì¡´ ìœ ì§€)
    
    // (1) ì„œìˆ  í˜¸í¡
    const pacingMap = {
        'ë¹ ë¥¸ ì „ê°œ (ì‚¬ê±´ ìœ„ì£¼)': 'Pacing: FAST. Focus on event progression. Skip mundane details. Summarize time passage quickly.',
        'ë³´í†µ (ë°¸ëŸ°ìŠ¤)': 'Pacing: BALANCED. Maintain a natural rhythm between dialogue and narration.',
        'ëŠë¦° ì „ê°œ (ì„¸ë°€í•œ ë¬˜ì‚¬)': 'Pacing: SLOW. Focus deeply on sensory details, micro-expressions, and psychological shifts. Describe the scene vividly.',
        'ë¹ ë¥¸ ì „ê°œ': 'Pacing: FAST. Focus on event progression.',
        'ë³´í†µ': 'Pacing: BALANCED.',
        'ëŠë¦° ì „ê°œ': 'Pacing: SLOW. Focus on details.'
    };
    
    // (2) ìˆ˜ìœ„ ê°•ë„
    const nsfwPromptText = {
        mild: 'Safety: Mild/Romance. Kissing, hugging, and physical contact are allowed. Strictly NO sexual intercourse or explicit genitals.',
        normal: 'Safety: R-18. Sexual intercourse is allowed. Standard erotic descriptions of intimacy.',
        hard: 'Safety: Hardcore. Highly explicit, stimulating details of sexual acts, fluids, and sensations. Focus on physical pleasure.',
        extreme: 'Safety: Extreme/Hentai. Style: Eroge/Doujinshi. Unrealistic, hyper-sexualized descriptions. Ahegao, corruption, mind-break, and deep fetishes are allowed. Focus on intense stimulation and instinct.'
    };

    const nsfwMap = {
        'ì „ì—°ë ¹ (ìŠ¤í‚¨ì‹­/í‚¤ìŠ¤)': nsfwPromptText.mild,
        'ë…¸ë©€ (ì„±ê´€ê³„ í•´ê¸ˆ)': nsfwPromptText.normal,
        'ê³ ìˆ˜ìœ„ (ìê·¹ì /ì ë‚˜ë¼í•¨)': nsfwPromptText.hard,
        'ì´ˆê³ ìˆ˜ìœ„ (ì—ë¡œê²Œ/ë™ì¸ì§€)': nsfwPromptText.extreme,
        'ì „ì—°ë ¹': nsfwPromptText.mild,
        'ë…¸ë©€': nsfwPromptText.normal,
        'í•˜ë“œì½”ì–´': nsfwPromptText.hard,
        'ìµìŠ¤íŠ¸ë¦¼': nsfwPromptText.extreme,
        'í•˜ë“œì½”ì–´ (ì ë‚˜ë¼í•œ ë¬˜ì‚¬)': nsfwPromptText.hard,
        'ìµìŠ¤íŠ¸ë¦¼ (ê·¹í•œ/í•˜ë“œì½”ì–´)': nsfwPromptText.extreme
    };
    
    // (3) ìºë¦­í„° íƒœë„
    const attitudeMap = {
        'ì² ë²½ (ì°¨ê°€ì›€/ë°©ì–´ì )': 'Character Attitude: Cold, Defensive, Distant. Do not open up easily.',
        'ë„ë„í•¨ (ì˜¤ë§Œ/ë‚´ë ¤ë‹¤ë´„)': 'Character Attitude: Arrogant, Haughty, High-pride. Looks down on others.',
        'ë³´í†µ (ì¼ë°˜ì )': 'Character Attitude: Neutral/Natural based on personality.',
        'ì ê·¹ì  (ìœ í˜¹/ë¦¬ë“œ)': 'Character Attitude: Active, Flirty, Aggressive in relationship.',
        'ê¸ˆì‚¬ë¹  (ë§¹ëª©ì  ì• ì •)': 'Character Attitude: Easily falls in love. Very affectionate and clingy.',
        'ì² ë²½': 'Character Attitude: Cold.',
        'ë„ë„í•¨': 'Character Attitude: Arrogant.',
        'ë³´í†µ': 'Character Attitude: Neutral.',
        'ì ê·¹ì ': 'Character Attitude: Active.',
        'ê¸ˆì‚¬ë¹ ': 'Character Attitude: Affectionate.'
    };

    // (4) ì¶œë ¥ ë¶„ëŸ‰
    const lengthMap = {
        'ì§§ê²Œ (10ë¬¸ì¥ ë‚´ì™¸)': 'Length: SHORT. Keep the response concise (around 10 sentences).',
        'ë³´í†µ (30ë¬¸ì¥ ë‚´ì™¸)': 'Length: MEDIUM. Standard novel length (around 30 sentences).',
        'ê¸¸ê²Œ (50ë¬¸ì¥ ë‚´ì™¸)': 'Length: LONG. Write extensively (50+ sentences). Be very descriptive.',
        'ì§§ê²Œ': 'Length: SHORT.',
        'ë³´í†µ': 'Length: MEDIUM.',
        'ê¸¸ê²Œ': 'Length: LONG.'
    };

    const pacingPrompt = pacingMap[SETTINGS.novelPacing] || pacingMap['ë³´í†µ (ë°¸ëŸ°ìŠ¤)'];
    const nsfwPrompt = nsfwMap[SETTINGS.nsfwLevel] || nsfwMap['ë…¸ë©€ (ì„±ê´€ê³„ í•´ê¸ˆ)'];
    const attitudePrompt = attitudeMap[SETTINGS.charAttitude] || attitudeMap['ë³´í†µ (ì¼ë°˜ì )'];
    const lengthPrompt = lengthMap[SETTINGS.outputLength] || lengthMap['ë³´í†µ (30ë¬¸ì¥ ë‚´ì™¸)'];

    let multiChoicePrompt = "";
    if (SETTINGS.enableMultiChoice) {
        multiChoicePrompt = `
[SPECIAL INSTRUCTION: MULTI-CHOICE]
At the very end of your response, you MUST generate 4 distinct options for the User's next action.
Format:
1. [Choice 1]
2. [Choice 2]
3. [Choice 3]
4. [Choice 4]`;
    }

    // 3. í”„ë¡¬í”„íŠ¸ ì¡°ë¦½
    const enabledCoreRules = SETTINGS.coreRules.filter(r => r.enabled !== false).map(r => `[Core Rule: ${r.title}] ${r.content}`).join('\n');
    const dicRules = SETTINGS.dicRules.map(r => `[Dictionary] ${r.title}: ${r.content}`).join('\n');
    
    // Auto-Event
    let autoEventInstruction = "";
    if (SETTINGS.autoEventEnabled && Math.random() * 100 < (SETTINGS.autoEventChance || 10)) {
        const event = AUTO_EVENT_DEFINITIONS[Math.floor(Math.random() * AUTO_EVENT_DEFINITIONS.length)];
        autoEventInstruction = `
[ğŸš¨ SUDDEN EVENT TRIGGERED: ${event.title}]
${event.content}
Apply this twist IMMEDIATELY to the current scene.`;
    }

    // ë¡œì–´ë¶ ë¬¸ìì—´ ë³€í™˜
    const globalLoreStr = activeGlobal.entries.map(l => `[Global Lore: ${l.title}]\n${l.content}`).join('\n');
    const worldLoreStr = activeWorldLore.entries.map(l => `[World Lore: ${l.title}] ${l.content}`).join('\n');
    
    const memoryPrompt = chat.memory && chat.memory.trim() !== '' ? `\n[Long-term Memory (Previous Context)]\n${chat.memory}\n` : '';

    // Context êµ¬ì„±
    let baseContext = "";
    if (chat.isNovelMode) {
        baseContext = `[Context: Novel Mode]\nTitle: ${chat.title}\n${chat.novelContent.substring(0, 5000)}...`;
    } else {
        if (!w) throw new Error("ë°°ê²½ ë°ì´í„° ì˜¤ë¥˜");
        let userPrompt = w.user ? `[User Info]\nName: ${w.user.name}\nGender: ${w.user.gender}\n${w.user.outfit||''}\n${(w.user.entries||[]).map(e=>e.content).join(' ')}` : "";
        const activeChars = (w.characters||[]).filter(c=>(chat.characterIds||[]).includes(c.id));
        // [ìˆ˜ì •] ìºë¦­í„°ì˜ ìƒì„¸ ì„¤ì •(ë§íˆ¬, ì„±ë²½, ë‚´ë©´ ë“±)ì„ ëª¨ë‘ í¬í•¨í•˜ë„ë¡ ê°œì„ 
        const charPrompt = activeChars.map(c => {
            let p = `[Character: ${c.name}]`;
            if (c.source_material) p += `\nSource: ${c.source_material}`;
            p += `\nInfo: ${c.gender}, ${c.age}, ${c.personality_tags || ''}`;
            
            if (c.appearance_desc) p += `\nAppearance: ${c.appearance_desc}`;
            if (c.body_type || c.three_sizes) p += `\nBody: ${c.body_type || ''} ${c.three_sizes ? '(' + c.three_sizes + ')' : ''}`;
            
            // ë§íˆ¬ ë° ëŒ€ì‚¬
            if (c.voice) p += `\nVoice Tone: ${c.voice}`;
            if (c.sample_dialogue) p += `\n[Sample Dialogue]\n${c.sample_dialogue}`;
            if (c.dialogue_depth) p += `\n[Dialogue Guideline (Depth)]\n${c.dialogue_depth}`;

            // ì„±ì /ì‹¬ë¦¬ ì„¤ì • (ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€)
            let sexTraits = [];
            if (c.erogenous_zones) sexTraits.push(`Erogenous Zones: ${c.erogenous_zones}`);
            if (c.fetish) sexTraits.push(`Fetish: ${c.fetish}`);
            if (c.underwear) sexTraits.push(`Underwear: ${c.underwear}`);
            if (c.perverted_features) sexTraits.push(`Traits: ${c.perverted_features}`);
            
            if (sexTraits.length > 0) p += `\n[Sexual Traits]\n${sexTraits.join('\n')}`;
            
            if (c.sexual_psyche) p += `\n[Inner Psyche & Corruption]\n${c.sexual_psyche}`;
            if (c.sexual_behavior) p += `\n[Sexual Behavior Pattern]\n${c.sexual_behavior}`;

            // ê¸°íƒ€ entries
            if (c.entries && c.entries.length > 0) {
                p += `\n[Additional Settings]\n` + c.entries.map(e => e.content).join('\n');
            }
            
            return p;
        }).join('\n\n');

        baseContext = `[Context: Roleplay]\nWorld: ${w.name}\n${w.description}\n${userPrompt}\n${charPrompt}`;
    }

    // ìµœì¢… ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì¡°ë¦½ [ìˆ˜ì •ë¨: worldRulesStr ì¶”ê°€]
    const systemPrompt = `
${baseContext}

[Current Active Lore]
${globalLoreStr}
${worldLoreStr}

${memoryPrompt}

[GUIDELINES & SETTINGS]
1. Role: Expert Novel AI. Write in ${SETTINGS.novelViewpoint}. Style: ${SETTINGS.novelStyle || 'ì›¹ì†Œì„¤ì²´'}.
2. ${pacingPrompt}
3. ${nsfwPrompt}
4. ${lengthPrompt}
5. ${attitudePrompt}
6. Language: KOREAN (í•œêµ­ì–´).

[Dictionaries & Core Rules]
${dicRules}
${enabledCoreRules}

[World Rules (Must Follow)]
${worldRulesStr}

${autoEventInstruction}
${multiChoicePrompt}

IMPORTANT: Analyze the context and write the next part of the story. Adhere strictly to the settings above.
`;

    // 4. ë©”ì‹œì§€ êµ¬ì„± ë° ì „ì†¡ (ê¸°ì¡´ê³¼ ë™ì¼)
    let imageParts = []; 
    if (chat.novelImages && chat.novelImages.length > 0) {
        chat.novelImages.forEach(imgData => {
            imageParts.push({ inlineData: { mimeType: 'image/jpeg', data: imgData.split(',')[1] } });
        });
    }

    const fullHistory = chat.history.filter(h => h.role === 'user' || h.role === 'model')
        .map(h => ({ role: h.role === 'user' ? 'user' : 'model', parts: [{ text: h.text }] }));

    let contents = [...fullHistory];
    if (imageParts.length > 0) contents.unshift({ role: 'user', parts: imageParts });

    lastSentPrompt = systemPrompt + "\n\n--- Last User Input ---\n" + (contents[contents.length-1]?.parts[0]?.text || '');

    const safetySettings = SETTINGS.uncensored 
        ? [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } ]
        : [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" } ];

    const requestBody = {
        system_instruction: { parts: [{ text: systemPrompt }] },
        contents: contents,
        safetySettings: safetySettings,
        generationConfig: {
            maxOutputTokens: SETTINGS.maxOutputTokens || 4000,
            temperature: SETTINGS.temperature || 0.9 
        }
    };

    const modelToUse = SETTINGS.currentModel || 'gemini-3-pro';
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${SETTINGS.apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody),
        signal: signalObj 
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]) throw new Error("AI ì‘ë‹µ ì—†ìŒ (í•„í„°ë§ë¨)");
    
    if (data.usageMetadata) lastTokenUsage = data.usageMetadata;
    return data.candidates[0].content.parts[0].text;
};
        
async function generateChatSummary(chatId) {
    const chat = DB.chats.find(c => c.id === chatId);
    
    // [ìˆ˜ì •] ì†Œì„¤ ëª¨ë“œ ì°¨ë‹¨ ì¡°ê±´(chat.isNovelMode) ì‚­ì œ -> ëª¨ë“  ëª¨ë“œì—ì„œ ì‘ë™
    if(!chat) return; 
    
    // ë³¸ë¬¸(novelContent)ì€ í¬í•¨í•˜ì§€ ì•Šê³ , ì˜¤ì§ ëŒ€í™” ë‚´ì—­(history)ë§Œ ì‚¬ìš©
    const historyText = chat.history.map(m => m.text).join('\n').substring(0, 1000);

    const prompt = `
    Analyze the start of this story conversation.
    
    Task: Create a short title and select an emoji.
    Output JSON ONLY: { "title": "Title in Korean", "emoji": "One emoji" }
    
    [Constraints]
    1. Title Language: MUST be KOREAN (í•œê¸€).
    2. Title Length: Maximum 15 characters.
    3. Emoji: One emoji that best represents the atmosphere.
    
    Story Context: ${historyText}`;

    try {
        const modelToUse = 'gemini-2.5-flash'; 
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${SETTINGS.apiKey}`;
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
        const data = await res.json();
        
        if (data.candidates && data.candidates[0].content) {
            let text = data.candidates[0].content.parts[0].text.replace(/```json/gi,'').replace(/```/g,'').trim();
            const result = JSON.parse(text);
            if(result.title && result.emoji) {
                chat.title = result.title; chat.emoji = result.emoji;
                document.getElementById('header-title').innerText = chat.title;
                saveData(); renderSidebar();
            }
        }
    } catch(e) { console.error("Summary failed", e); }
}

// [ìˆ˜ì •ëœ sendMessage í•¨ìˆ˜ ì „ì²´]
async function sendMessage() {
    const input = document.getElementById('msg-input');
    const text = input.value.trim();

    // 1. í€µ ìŠ¤íƒ€íŠ¸: ì„¸ì…˜ì´ ì—†ëŠ”ë° ê¸€ì„ ì¼ë‹¤ë©´ -> ìƒˆ ì„¸ì…˜ ìë™ ìƒì„±
    if (!currentSessionId && text) {
        const newId = Date.now().toString();
        const tempTitle = text.length > 15 ? text.substring(0, 15) + '...' : text;
        
        const newChat = { 
            id: newId, 
            title: tempTitle, 
            worldId: 'quick_start_dummy', 
            characterIds: [], 
            history: [], 
            memory: '',
            isNovelMode: true, 
            novelContent: '', 
            novelImages: [] 
        };
        
        DB.chats.unshift(newChat);
        loadSession(newId);
        renderSidebar();
    }

    // 2. ìœ íš¨ì„± ê²€ì‚¬: í…ìŠ¤íŠ¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ìƒì„± ì¤‘ì´ë©´ ì¤‘ë‹¨
    if (!text || isTextGenerating) return;

    // ì…ë ¥ì°½ ë¹„ìš°ê¸°
    input.value = '';

    // ì„¸ì…˜ ìˆœì„œ ìµœì‹ í™” (ë§¨ ìœ„ë¡œ ì˜¬ë¦¬ê¸°)
    if(currentSessionId) {
         const sessionIndex = DB.chats.findIndex(c => c.id === currentSessionId);
         if (sessionIndex > -1) {
             const session = DB.chats.splice(sessionIndex, 1)[0];
             DB.chats.unshift(session);
         }
         const s = DB.chats[0];
         const requestingSessionId = s.id;

         // ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
         s.history.push({ role: 'user', text: text });
         appendMessage({ role: 'user', text: text }, false);
         scrollToBottom();
         saveData();
         renderSidebar();

         // â–¼â–¼â–¼ [í•µì‹¬ ë³€ê²½] ë²„íŠ¼ ìƒíƒœë¥¼ 'ì •ì§€(ë¹¨ê°•)'ë¡œ ë³€ê²½ â–¼â–¼â–¼
         isTextGenerating = true;
         if (textAbortController) textAbortController.abort();
         textAbortController = new AbortController();
         
         updateSendButtonState('generating'); // ë²„íŠ¼ ëª¨ì–‘ ë°”ê¾¸ê¸°

         try {
             // AIì—ê²Œ ìš”ì²­ ë³´ë‚´ê¸°
             const reply = await window.callGemini(s, textAbortController.signal);
             
             // AI ì‘ë‹µ ì²˜ë¦¬
             const role = 'model';
             s.history.push({ role: role, text: reply });
             s.lastMessage = reply.substring(0, 20) + '...';
             
             if (currentSessionId === requestingSessionId) { 
                 appendMessage({ role: role, text: reply }, true); 
             }
             
             saveData(); 
             renderSidebar();
             
             // 2í„´ ì´ìƒì´ë©´ ì œëª© ìë™ ìš”ì•½
             if (s.history.length === 2) { generateChatSummary(s.id); }

         } catch (e) {
             // ì—ëŸ¬ ë°œìƒ ì‹œ (ì¤‘ë‹¨ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í‘œì‹œ)
             if (e.name !== 'AbortError') {
                 if (currentSessionId === requestingSessionId) { 
                     appendMessage({ role: 'model', text: `Error: ${e.message}` }, false); 
                 }
             }
         } finally {
             // â–¼â–¼â–¼ [í•µì‹¬ ë³€ê²½] ìƒì„±ì´ ëë‚˜ë©´ ë²„íŠ¼ì„ 'ì „ì†¡(íŒŒë‘)'ìœ¼ë¡œ ë³µêµ¬ â–¼â–¼â–¼
             isTextGenerating = false;
             updateSendButtonState('idle'); // ë²„íŠ¼ ëª¨ì–‘ ì›ë˜ëŒ€ë¡œ
         }
    }
}
        
function openSessionSettings(mode='new') {
    // [ìˆ˜ì •] ë“¤ì–´ì˜¤ìë§ˆì ëª¨ë“œë¶€í„° í™•ì‹¤í•˜ê²Œ ì„¤ì •!
    isNewSessionMode = (mode === 'new'); 

    const chat = DB.chats.find(c => c.id === currentSessionId);

    // ì´ì œ isNewSessionModeê°€ trueì´ë¯€ë¡œ, ì†Œì„¤ ëª¨ë“œì—¬ë„ ì´ ì¡°ê±´ë¬¸ì— ê±¸ë¦¬ì§€ ì•Šê³  í†µê³¼í•©ë‹ˆë‹¤.
    if (!isNewSessionMode && chat && chat.isNovelMode) {
        return alert("ì†Œì„¤ ëª¨ë“œì—ì„œëŠ” ì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì´ì•¼ê¸° ì‹œì‘ì„ ì´ìš©í•´ ìƒˆë¡œìš´ ë°°ê²½ì„ ì„ íƒí•˜ì„¸ìš”.");
    }

    if(!DB.worlds.length && mode === 'new') return alert('ë¨¼ì € ë°°ê²½ì„ ìƒì„±í•˜ì„¸ìš”.');
            document.getElementById('session-modal-title').innerText = isNewSessionMode ? 'ìƒˆ ì´ì•¼ê¸° ì‹œì‘' : 'ì„¤ì • ë³€ê²½';
            
            const listContainer = document.getElementById('world-selection-list');
            const fixedDisplay = document.getElementById('world-fixed-display');
            listContainer.innerHTML = '';

            if (isNewSessionMode) {
                listContainer.classList.remove('hidden');
                fixedDisplay.classList.add('hidden');
                DB.worlds.forEach(w => {
                    const btn = document.createElement('button');
                    const isSelected = selectedWorldId===w.id;
                    btn.className = `world-select-btn w-full text-left p-3 border rounded-lg hover:bg-indigo-50 ${isSelected ? 'selected' : ''}`;
                    btn.innerHTML = `<div class="font-bold text-sm">${w.name}</div><div class="text-xs text-gray-500 truncate">${w.description || 'ì„¤ì • ì—†ìŒ'}</div>`;
                    btn.onclick = () => {
                        document.querySelectorAll('.world-select-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedWorldId = w.id;
                        updateSessionChars(w.id);
                    };
                    listContainer.appendChild(btn);
                });
                
                // Initialize selectedWorldId if necessary
                if (!selectedWorldId && DB.worlds.length > 0) { 
                    selectedWorldId = DB.worlds[0].id; 
                    listContainer.firstChild?.classList.add('selected'); 
                    updateSessionChars(selectedWorldId); 
                } else if (selectedWorldId) {
                    updateSessionChars(selectedWorldId);
                }

            } else {
                listContainer.classList.add('hidden');
                fixedDisplay.classList.remove('hidden');
                if (chat) {
                    selectedWorldId = chat.worldId;
                    const w = DB.worlds.find(x => x.id === selectedWorldId);
                    fixedDisplay.innerHTML = `<i class="fa-solid fa-globe mr-2"></i>í˜„ì¬ ë°°ê²½: ${w ? w.name : 'Unknown'}`;
                    updateSessionChars(selectedWorldId, chat.characterIds);
                }
            }
            openModalInternal('session-modal');
        }

        function updateSessionChars(worldId, activeIds = null) {
            const w = DB.worlds.find(x=>x.id===worldId);
            const charArea = document.getElementById('session-chars');
            if (!w) {
                charArea.innerHTML = '<div class="text-gray-400 text-center text-sm mt-10">ë°°ê²½ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '';
            if(w.user) { html += `<div class="p-2 border-b mb-2 bg-indigo-50 rounded"><i class="fa-solid fa-user-astronaut mr-2"></i><span class="font-bold">${w.user.name}</span> (ìœ ì €)</div>`; }
            html += (w.characters||[]).map(c => {
                const isChecked = activeIds ? activeIds.includes(c.id) : true;
                return `<label class="flex items-center p-2 hover:bg-gray-100 cursor-pointer"><input type="checkbox" value="${c.id}" class="mr-2 w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" ${isChecked ? 'checked' : ''}><span class="text-sm font-medium">${c.name}</span></label>`;
            }).join('');
            charArea.innerHTML = html;
        }

        function saveSessionSettings() {
            if(!selectedWorldId) return alert('ë°°ê²½ì„ ì„ íƒí•˜ì„¸ìš”.');
            const cids = Array.from(document.querySelectorAll('#session-chars input:checked')).map(cb=>cb.value);
            if(isNewSessionMode) {
                const id = Date.now().toString();
                DB.chats.unshift({ id, title: 'ìƒˆë¡œìš´ ì´ì•¼ê¸°', worldId: selectedWorldId, characterIds: cids, history: [], memory: '', isNovelMode: false });
                loadSession(id); 
            } else {
                if(currentSessionId) {
                    const s = DB.chats.find(c=>c.id===currentSessionId);
                    s.worldId = selectedWorldId; s.characterIds = cids;
                    
                    // Update header if settings change affected mode
                    const w = DB.worlds.find(x => x.id === s.worldId);
                    document.getElementById('info-world').innerHTML = `<i class="fa-solid fa-globe"></i> ${w ? w.name : '-'}`;
                    
                    showMessage('ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
            saveData(); renderSidebar(); closeModal('session-modal');
        }
        
        function backupData() { const b = new Blob([JSON.stringify({DB,SETTINGS},null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`backup_${Date.now()}.json`; a.click(); }
        function loadBackup() { const i=document.createElement('input'); i.type='file'; i.onchange=e=>{ const r=new FileReader(); r.onload=v=>{ try{ const d=JSON.parse(v.target.result); if(d.DB){ localStorage.setItem(STORAGE_KEY,JSON.stringify(d.DB)); localStorage.setItem(SETTINGS_KEY,JSON.stringify(d.SETTINGS)); location.reload(); } }catch(err){ alert('Error'); } }; r.readAsText(e.target.files[0]); }; i.click(); }
        function importJSON(cb) { const i=document.createElement('input'); i.type='file'; i.onchange=e=>{ const r=new FileReader(); r.onload=v=>cb(JSON.parse(v.target.result)); r.readAsText(e.target.files[0]); }; i.click(); }
        
        function exportChat() { 
            if(!currentSessionId) return;
            const s = DB.chats.find(c=>c.id===currentSessionId);
            
            let txtContent = `ì œëª©: ${s.title}\n`;
            if (s.isNovelMode) {
                txtContent += `ëª¨ë“œ: ì†Œì„¤ ëª¨ë“œ (ì›ë¬¸ ê¸¸ì´: ${s.novelContent.length})\n`;
            } else {
                txtContent += `ë°°ê²½: ${DB.worlds.find(w=>w.id===s.worldId)?.name || 'Unknown'}\n`;
            }
            txtContent += `ì¥ê¸° ê¸°ì–µ: ${s.memory || 'ì—†ìŒ'}\n\n`;
            
            s.history.forEach(msg => {
                const role = msg.role === 'user' ? '   User' : (msg.role === 'model' ? '   AI' : '   Director');
                txtContent += `[${role}]\n${msg.text}\n\n====================\n\n`;
            });
            // BOM ì¶”ê°€ (\uFEFF)ë¡œ ëª¨ë°”ì¼/ìœˆë„ìš° ì¸ì½”ë”© ê¹¨ì§ ë°©ì§€
            const b = new Blob(['\uFEFF' + txtContent], {type: 'text/plain;charset=utf-8'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href = u; a.download = `${s.title}.txt`; a.click();
        }
        
        function deleteChat(id) { if(confirm('ì‚­ì œ?')) { DB.chats=DB.chats.filter(c=>c.id!==id); saveData(); renderSidebar(); if(currentSessionId===id) location.reload(); } }
        function deleteChar(wid, cid) { if(confirm('ì‚­ì œ?')) { const w=DB.worlds.find(x=>x.id===wid); w.characters=w.characters.filter(c=>c.id!==cid); saveData(); renderSidebar(); } }
        function deleteUser(wid) { if(confirm('ìœ ì € í˜ë¥´ì†Œë‚˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { const w=DB.worlds.find(x=>x.id===wid); if(w) { delete w.user; saveData(); renderSidebar(); } } }
        function deleteWorld(id) { if(confirm('ë°°ê²½ ë° ì—°ê²°ëœ ìºë¦­í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { DB.worlds = DB.worlds.filter(x=>x.id !== id); saveData(); renderSidebar(); } }
        
function clearChat() { 
    // ì•ˆë‚´ ë©”ì‹œì§€ ìˆ˜ì • (10ê°œ -> 2ê°œ)
    if(currentSessionId && confirm('ëŒ€í™” ë‚´ì—­ì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìµœê·¼ 2ê°œì˜ ë©”ì‹œì§€ë§Œ ë‚¨ê¸°ê³  ì´ì „ ë‚´ì—­ì€ ì‚­ì œë©ë‹ˆë‹¤.)')) { 
        const chat = DB.chats.find(c=>c.id===currentSessionId);
        // ì¡°ê±´ ìˆ˜ì • (10 -> 2)
        if (chat.history.length > 2) { 
            // ìë¥´ê¸° ìˆ˜ì • (-10 -> -2)
            chat.history = chat.history.slice(-2); 
            loadSession(currentSessionId); 
            saveData(); showMessage('ëŒ€í™”ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else { showMessage('ì •ë¦¬í•  ëŒ€í™”ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
    } 
}
        
        function openCoreModal() { 
            document.getElementById('core-api-key').value = SETTINGS.apiKey;
            
            // ê¸°ì¡´ ì±„íŒ… ëª¨ë¸ ì„¤ì •
            const modelKey = SETTINGS.currentModel || 'gemini-3-pro'; 
            document.getElementById('core-model-select').value = modelKey;
            document.getElementById('current-model-display').innerText = modelKey;
            
            document.getElementById('core-safety-toggle').checked = SETTINGS.uncensored;
            document.getElementById('core-speed-select').value = SETTINGS.typingSpeed || 15;

/* â–¼â–¼â–¼ [ìˆ˜ì •/ì¶”ê°€] í† í° ìŠ¬ë¼ì´ë” ìœ„ì¹˜ ì´ˆê¸°í™” ì½”ë“œ â–¼â–¼â–¼ */
            const currentTokens = SETTINGS.maxOutputTokens || 4000; // ì €ì¥ëœ ê°’ ì—†ìœ¼ë©´ 4000
            document.getElementById('core-max-token-slider').value = currentTokens;
            document.getElementById('core-max-token-val').innerText = currentTokens;
            /* â–²â–²â–² [ì—¬ê¸°ê¹Œì§€] â–²â–²â–² */
            
/* ... openCoreModal í•¨ìˆ˜ ë‚´ë¶€ ... */
            
            const fontSize = SETTINGS.fontSize || 16;
            document.getElementById('font-size-slider').value = fontSize;
            document.getElementById('font-size-val').innerText = fontSize + 'px';
            document.getElementById('font-preview-text').style.fontSize = (fontSize/16) + 'rem';
            
            // â–¼â–¼â–¼ [ì‚­ì œ] ê¸°ì¡´ì˜ ì •ì  ìš”ì†Œ ì´ˆê¸°í™” ì½”ë“œ 3ì¤„ ì‚­ì œ â–¼â–¼â–¼
            // document.getElementById('core-novel-point').value = ... 
            // document.getElementById('core-novel-style').value = ...
            // document.getElementById('core-novel-ratio').value = ...
            
// openCoreModal í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ 'core-tab-novel' ê´€ë ¨ ë¶€ë¶„ë§Œ ì•„ë˜ ì½”ë“œë¡œ ë®ì–´ì”Œì›Œ ì£¼ì„¸ìš”.
const novelTab = document.getElementById('core-tab-novel');
if (novelTab) {
    const renderOpt = (key, opts) => opts.map(o => `<option value="${o}" ${SETTINGS[key]===o?'selected':''}>${o}</option>`).join('');
    
    novelTab.innerHTML = `
        <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-4">ì†Œì„¤ ì—°ì¶œ ìƒì„¸ ì§€ì¹¨</h4>
        
        <div class="space-y-4">
            <div><label class="block text-sm font-bold text-gray-700 dark:text-gray-400 mb-1">ì„œìˆ  í˜¸í¡</label>
            <select id="sync-novelPacing" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600">${renderOpt('novelPacing', ['ë¹ ë¥¸ ì „ê°œ (ì‚¬ê±´ ìœ„ì£¼)', 'ë³´í†µ (ë°¸ëŸ°ìŠ¤)', 'ëŠë¦° ì „ê°œ (ì„¸ë°€í•œ ë¬˜ì‚¬)'])}</select></div>

            <div><label class="block text-sm font-bold text-gray-700 dark:text-gray-400 mb-1">ìˆ˜ìœ„ ê°•ë„</label>
            <select id="sync-nsfwLevel" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600">
                ${renderOpt('nsfwLevel', ['ì „ì—°ë ¹ (ìŠ¤í‚¨ì‹­/í‚¤ìŠ¤)', 'ë…¸ë©€ (ì„±ê´€ê³„ í•´ê¸ˆ)', 'ê³ ìˆ˜ìœ„ (ìê·¹ì /ì ë‚˜ë¼í•¨)', 'ì´ˆê³ ìˆ˜ìœ„ (ì—ë¡œê²Œ/ë™ì¸ì§€)'])}
            </select></div>
            <div><label class="block text-sm font-bold text-gray-700 dark:text-gray-400 mb-1">ìºë¦­í„° íƒœë„</label>
            <select id="sync-charAttitude" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600">${renderOpt('charAttitude', ['ì² ë²½ (ì°¨ê°€ì›€/ë°©ì–´ì )', 'ë„ë„í•¨ (ì˜¤ë§Œ/ë‚´ë ¤ë‹¤ë´„)', 'ë³´í†µ (ì¼ë°˜ì )', 'ì ê·¹ì  (ìœ í˜¹/ë¦¬ë“œ)', 'ê¸ˆì‚¬ë¹  (ë§¹ëª©ì  ì• ì •)'])}</select></div>

            <div><label class="block text-sm font-bold text-gray-700 dark:text-gray-400 mb-1">1íšŒ ì¶œë ¥ ë¶„ëŸ‰</label>
            <select id="sync-outputLength" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600">${renderOpt('outputLength', ['ì§§ê²Œ (10ë¬¸ì¥ ë‚´ì™¸)', 'ë³´í†µ (30ë¬¸ì¥ ë‚´ì™¸)', 'ê¸¸ê²Œ (50ë¬¸ì¥ ë‚´ì™¸)'])}</select></div>

            <div><label class="block text-sm font-bold text-gray-700 dark:text-gray-400 mb-1">ì„œìˆ  ì‹œì  (Viewpoint)</label>
            <select id="core-novel-point" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600">
                ${renderOpt('novelViewpoint', ['3ì¸ì¹­ ì œí•œì  ì‹œì  (ì¶”ì²œ)', '3ì¸ì¹­ ì œí•œì  (íˆë¡œì¸ ë‚´ë©´)', '1ì¸ì¹­ ì£¼ì¸ê³µ ì‹œì ', '3ì¸ì¹­ ê´€ì°°ì ì‹œì ', '3ì¸ì¹­ ì „ì§€ì  ì‘ê°€ ì‹œì '])}
            </select></div>
            
            <div><label class="block text-sm font-bold text-gray-700 dark:text-gray-400 mb-1">ë¬¸ì²´ ìŠ¤íƒ€ì¼</label>
            <select id="core-novel-style" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600">
                    ${renderOpt('novelStyle', ['ì›¹ì†Œì„¤ì²´', 'ê°„ê²°/ê±´ì¡°ì²´', 'ë§Œì—°/í™”ë ¤ì²´'])}
            </select></div>

            <div class="flex items-center justify-between p-3 bg-indigo-50 dark:bg-slate-800 border border-indigo-100 dark:border-slate-700 rounded-lg">
                <label class="font-bold text-indigo-900 dark:text-indigo-300 text-sm"><i class="fa-solid fa-list-ol mr-1"></i>4ì§€ì„ ë‹¤ ì„ íƒì§€ ìë™ ìƒì„±</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="core-multi-choice-toggle" class="sr-only peer" ${SETTINGS.enableMultiChoice ? 'checked' : ''}>
                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-slate-500 dark:border-slate-400 border border-gray-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
            </div>

            <div class="p-3 bg-red-50 dark:bg-slate-800 border border-red-100 dark:border-red-900 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <label class="font-bold text-red-800 dark:text-red-400 text-sm"><i class="fa-solid fa-bolt mr-1"></i>ëŒë°œ ì´ë²¤íŠ¸ (Auto-Event)</label>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-red-600 font-bold" id="event-chance-display">${SETTINGS.autoEventChance||10}%</span>
                        <input type="range" id="auto-event-chance" min="0" max="50" step="5" value="${SETTINGS.autoEventChance||10}" class="w-24 accent-red-600 cursor-pointer" oninput="document.getElementById('event-chance-display').innerText = this.value + '%'">
                        <input type="checkbox" id="auto-event-toggle" class="w-5 h-5 text-red-600 rounded focus:ring-red-500 cursor-pointer" ${SETTINGS.autoEventEnabled?'checked':''}>
                    </div>
                </div>
                <p class="text-xs text-red-700 dark:text-gray-400 opacity-80 leading-snug">
                    ëŒ€í™” ì§„í–‰ ì¤‘ AIê°€ ë¬´ì‘ìœ„ë¡œ 'ìœ„ê¸°'ë‚˜ 'ì‹ ì²´ ë³€ìˆ˜'ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.
                </p>
            </div>
        </div>
    `;
}

            renderCoreRules(); renderDicRules(); 
            // ... (ì´í›„ ì½”ë“œ ê³„ì†)
            
            renderCoreRules(); renderDicRules(); 

renderMacroSettings();

            openModalInternal('core-modal');



            // [ëª¨ë°”ì¼] íƒ­ ë™ê¸°í™”
            const mobileSelect = document.getElementById('core-tab-select-mobile');
            if (mobileSelect) {
                // Determine which tab is currently visible (default to 'api')
                let currentActiveTabId = 'api';
                const currentActiveBtn = document.querySelector('#core-modal-nav-desktop button.bg-indigo-50');
                if (currentActiveBtn) {
                     // Extract the value from onclick attribute or find it by iterating
                     const match = currentActiveBtn.onclick.toString().match(/switchCoreTab\(['"](.*?)['"]\)/);
                     if (match) currentActiveTabId = match[1];
                }
                
                // If the modal just opened, ensure 'api' is the default visual tab 
                // and sync the mobile select box.
                switchCoreTab(currentActiveTabId);
                mobileSelect.value = currentActiveTabId;
            } else {
                // Desktop: explicitly show the first tab and highlight the button
                switchCoreTab('api');
            }
        }


        
        document.getElementById('font-size-slider').addEventListener('input', function(e) {
            const size = e.target.value;
            document.getElementById('font-size-val').innerText = size + 'px';
            document.getElementById('font-preview-text').style.fontSize = (size/16) + 'rem';
            applyFontSize(size);
        });

        function applyFontSize(px) { document.documentElement.style.setProperty('--novel-font-size', (px/16) + 'rem'); }

function saveCoreSettings() { 
    try {
        SETTINGS.apiKey = document.getElementById('core-api-key').value; 
        SETTINGS.currentModel = document.getElementById('core-model-select').value; 
        SETTINGS.uncensored = document.getElementById('core-safety-toggle').checked;
        SETTINGS.typingSpeed = parseInt(document.getElementById('core-speed-select').value);
        SETTINGS.fontSize = parseInt(document.getElementById('font-size-slider').value);
        
        // ë™ê¸°í™”ëœ ìƒˆ ì„¤ì •ê°’ë“¤
        if(document.getElementById('sync-novelPacing')) SETTINGS.novelPacing = document.getElementById('sync-novelPacing').value;
        if(document.getElementById('sync-nsfwLevel')) SETTINGS.nsfwLevel = document.getElementById('sync-nsfwLevel').value;
        if(document.getElementById('sync-charAttitude')) SETTINGS.charAttitude = document.getElementById('sync-charAttitude').value;
        if(document.getElementById('sync-outputLength')) SETTINGS.outputLength = document.getElementById('sync-outputLength').value;
        
        // [ì¶”ê°€ë¨] 4ì§€ì„ ë‹¤ ì„¤ì • ì €ì¥
        const multiChoiceEl = document.getElementById('core-multi-choice-toggle');
        if(multiChoiceEl) SETTINGS.enableMultiChoice = multiChoiceEl.checked;

        // ê¸°ì¡´ ì„¤ì • ì €ì¥
        const pointEl = document.getElementById('core-novel-point');
        if(pointEl) SETTINGS.novelViewpoint = pointEl.value;
        
        const styleEl = document.getElementById('core-novel-style');
        if(styleEl) SETTINGS.novelStyle = styleEl.value;
        
        // ìë™ ì´ë²¤íŠ¸ ì„¤ì •
        const autoEventToggle = document.getElementById('auto-event-toggle');
        if(autoEventToggle) SETTINGS.autoEventEnabled = autoEventToggle.checked;
        
        const autoEventChance = document.getElementById('auto-event-chance');
        if(autoEventChance) SETTINGS.autoEventChance = parseInt(autoEventChance.value);

        // í† í° ì„¤ì •
        const tokenSlider = document.getElementById('core-max-token-slider');
        if(tokenSlider) SETTINGS.maxOutputTokens = parseInt(tokenSlider.value);

        saveSettings(); 
        closeModal('core-modal'); 
        
        renderRightSidebar();
        
    } catch(e) {
        console.error(e);
        alert("ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
    }
}

        function switchCoreTab(t) { 
            document.querySelectorAll('.core-tab-content').forEach(e => e.classList.add('hidden')); 
            const targetTab = document.getElementById('core-tab-' + t);
            if(targetTab) targetTab.classList.remove('hidden'); 
            
            // Desktop button highlighting logic
            document.querySelectorAll('#core-modal-nav-desktop button').forEach(btn => {
                const btnValue = btn.onclick.toString().match(/switchCoreTab\(['"](.*?)['"]\)/)?.[1];
                if (btnValue === t) {
                    btn.classList.add('bg-indigo-50', 'text-indigo-700');
                } else {
                    btn.classList.remove('bg-indigo-50', 'text-indigo-700');
                }
            });

            // Mobile select synchronization
            const mobileSelect = document.getElementById('core-tab-select-mobile');
            if (mobileSelect && mobileSelect.value !== t) {
                mobileSelect.value = t;
            }
        }
        
/* â–¼â–¼â–¼ [ìˆ˜ì •ë¨] AI í•µì‹¬ ì§€ì¹¨ ë Œë”ë§ (ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì¶”ê°€) â–¼â–¼â–¼ */
function renderCoreRules() { 
    const l=document.getElementById('core-rules-list'); l.innerHTML=''; 
    SETTINGS.coreRules.forEach((r,i)=> {
        const isEnabled = r.enabled !== false;
        l.innerHTML+=`<div class="rule-item border bg-gray-50 mb-2 rounded overflow-hidden collapsed ${isEnabled?'':'disabled'}">
            <div class="rule-header flex justify-between items-center p-3 bg-gray-100 cursor-pointer">
                <div class="flex items-center gap-2">
                        <input type="checkbox" ${isEnabled?'checked':''} onclick="event.stopPropagation(); SETTINGS.coreRules[${i}].enabled = this.checked; renderCoreRules();" class="w-4 h-4 cursor-pointer">
                    <span class="font-bold text-sm flex items-center gap-2" onclick="this.closest('.rule-item').classList.toggle('collapsed')"><i class="fa-solid fa-chevron-down text-gray-500"></i>${r.title||'ê·œì¹™ '+(i+1)}</span>
                </div>
                <button onclick="event.stopPropagation(); SETTINGS.coreRules.splice(${i},1);renderCoreRules()" class="text-red-500 hover:text-red-700 text-xs font-bold">ì‚­ì œ</button>
            </div>
            <div class="rule-content p-3 border-t">
                <input class="w-full mb-2 p-2 border rounded text-sm" value="${r.title}" placeholder="ì œëª©" onchange="SETTINGS.coreRules[${i}].title=this.value">
                <textarea class="w-full p-2 border rounded text-sm h-32" onchange="SETTINGS.coreRules[${i}].content=this.value">${r.content}</textarea>
            </div>
        </div>`;
    });
    
    // [ì¶”ê°€ë¨] ìƒì„±ëœ ëª¨ë“  textareaì— ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ë¶€ì°©
    l.querySelectorAll('textarea').forEach(el => makeResizable(el));
}

/* â–¼â–¼â–¼ [ìˆ˜ì •ë¨] ìš©ì–´/í‘œí˜„ ì§€ì¹¨ ë Œë”ë§ (ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì¶”ê°€) â–¼â–¼â–¼ */
function renderDicRules() { 
    const l=document.getElementById('core-dic-list'); l.innerHTML=''; 
    SETTINGS.dicRules.forEach((r,i)=> {
        l.innerHTML+=`<div class="rule-item border bg-gray-50 mb-2 rounded overflow-hidden collapsed">
            <div class="rule-header flex justify-between items-center p-3 bg-gray-100 cursor-pointer" onclick="this.parentElement.classList.toggle('collapsed')">
                <span class="font-bold text-sm"><i class="fa-solid fa-chevron-down mr-2 text-gray-500"></i>${r.title||'ìš©ì–´ '+(i+1)}</span>
                <button onclick="event.stopPropagation(); SETTINGS.dicRules.splice(${i},1);renderDicRules()" class="text-red-500 hover:text-red-700 text-xs font-bold">ì‚­ì œ</button>
            </div>
            <div class="rule-content p-3 border-t">
                <input class="w-full mb-2 p-2 border rounded text-sm" value="${r.title}" placeholder="ìš©ì–´" onchange="SETTINGS.dicRules[${i}].title=this.value">
                <textarea class="w-full p-2 border rounded text-sm h-32" onchange="SETTINGS.dicRules[${i}].content=this.value">${r.content}</textarea>
            </div>
        </div>`;
    });
    
    // [ì¶”ê°€ë¨] ìƒì„±ëœ ëª¨ë“  textareaì— ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ë¶€ì°©
    l.querySelectorAll('textarea').forEach(el => makeResizable(el));
}
        
        function addEntryUI(id, data) { if(id==='core-rules-list') SETTINGS.coreRules.push(data); else SETTINGS.dicRules.push(data); if(id==='core-rules-list') renderCoreRules(); else renderDicRules(); }
        function openMemoryModal() { if(currentSessionId) { document.getElementById('memory-input').value = DB.chats.find(c=>c.id===currentSessionId).memory||''; openModalInternal('memory-modal'); } }
        function saveMemory() { 
            if(currentSessionId) { 
                DB.chats.find(c=>c.id===currentSessionId).memory = document.getElementById('memory-input').value; 
                saveData(); 
                closeModal('memory-modal'); 
                showMessage('ì¥ê¸° ê¸°ì–µì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); // ì €ì¥ í™•ì¸ ë©”ì‹œì§€ ì¶”ê°€
            } 
        }
        function openTextareaEditor(btn) { activeTextareaTarget = btn.closest('div').querySelector('textarea'); document.getElementById('modal-textarea-input').value = activeTextareaTarget.value; openModalInternal('textarea-editor-modal'); }
        function saveAndCloseTextareaEditor() { if(activeTextareaTarget) activeTextareaTarget.value = document.getElementById('modal-textarea-input').value; closeModal('textarea-editor-modal'); }
        
function addGlobalLoreFromSidebar() {
    if (!SETTINGS.globalLorebook) SETTINGS.globalLorebook = [];
    
    // ë¹ˆ ë¡œì–´ ìƒì„±
    SETTINGS.globalLorebook.push({ id: Date.now(), title: 'ìƒˆ ë¡œì–´', keywords: '', content: '' });
    saveSettings();
    renderRightSidebar();
    
    // ë°©ê¸ˆ ìƒì„±í•œ ë¡œì–´ì˜ ì—ë””í„° ì¦‰ì‹œ ì—´ê¸°
    editGlobalLore(SETTINGS.globalLorebook.length - 1);
}

function editGlobalLore(idx) {
    const lore = SETTINGS.globalLorebook[idx];
    const body = document.getElementById('modal-body');

    // 1. ì—ë””í„° UI ì£¼ì… (ì œëª©, í‚¤ì›Œë“œ, ë‚´ìš© ì…ë ¥ì°½)
    body.innerHTML = `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">ë¡œì–´ ì œëª©</label>
                <input id="quick-lore-title" type="text" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500" value="${String(lore.title || '').replace(/"/g, '&quot;')}" placeholder="ì˜ˆ: ë§ˆë²• ì²´ê³„, ì œêµ­ ì—­ì‚¬">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-400 mb-1">ê°ì§€ í‚¤ì›Œë“œ (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label>
                <input id="quick-lore-keys" type="text" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-gray-100 text-sm focus:ring-2 focus:ring-indigo-500" value="${String(lore.keywords || '').replace(/"/g, '&quot;')}" placeholder="ë¹„ì›Œë‘ë©´ í•­ìƒ ì ìš©">
                <p class="text-[10px] text-gray-400 mt-1">* ëŒ€í™”ë‚˜ ì§€ë¬¸ì— ì´ ë‹¨ì–´ê°€ ë“±ì¥í•  ë•Œë§Œ AIì—ê²Œ ì„¤ì •ì´ ì£¼ì…ë©ë‹ˆë‹¤.</p>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">ë‚´ìš©</label>
                <textarea id="quick-lore-content" rows="15" class="w-full p-3 border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-gray-100 resize-none text-sm leading-relaxed focus:ring-2 focus:ring-indigo-500" placeholder="ìƒì„¸ ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš”...">${lore.content || ''}</textarea>
            </div>
        </div>
    `;

    // 2. ëª¨ë‹¬ ì„¤ì •
    document.getElementById('modal-title').innerText = "ê¸€ë¡œë²Œ ë¡œì–´ë¶ ìˆ˜ì •";
    document.getElementById('modal-delete-btn').classList.add('hidden');
    document.getElementById('btn-gen-details').classList.add('hidden');

    // 3. ì €ì¥ ë¡œì§
    document.getElementById('modal-save-btn').onclick = () => {
        const titleVal = document.getElementById('quick-lore-title').value.trim();
        if (!titleVal) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        SETTINGS.globalLorebook[idx].title = titleVal;
        SETTINGS.globalLorebook[idx].keywords = document.getElementById('quick-lore-keys').value;
        SETTINGS.globalLorebook[idx].content = document.getElementById('quick-lore-content').value;

        saveSettings();
        renderRightSidebar();
        closeModal('editor-modal');
    };

    // 4. ëª¨ë‹¬ ì—´ê¸° ë° ê¸°ëŠ¥ í™œì„±í™”
    openModalInternal('editor-modal');
    setTimeout(() => {
        const textarea = document.getElementById('quick-lore-content');
        if (textarea) {
            textarea.focus();
            makeResizable(textarea); // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ë¶€ì°©
        }
    }, 50);
}

        function deleteGlobalLore(idx) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { SETTINGS.globalLorebook.splice(idx, 1); saveSettings(); renderRightSidebar(); } }

// [ìˆ˜ì •] ê¸°ì¡´ showLastPrompt í•¨ìˆ˜ë¥¼ ì´ê±¸ë¡œ í†µì§¸ë¡œ êµì²´í•˜ì„¸ìš”
        function showLastPrompt() {
            if (!lastSentPrompt) return alert("ì•„ì§ ì „ì†¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            const textarea = document.getElementById('modal-textarea-input');
            
            // í† í° ì •ë³´ê°€ ìˆìœ¼ë©´ ë§¨ ìœ„ì— í‘œì‹œ
            let infoHeader = "";
            if (lastTokenUsage) {
                infoHeader = `[ğŸ“Š í† í° ì‚¬ìš©ëŸ‰ ë³´ê³ ì„œ(ì¶”ì •)]\n` +
                             `â€¢ ë³´ë‚¸ ì–‘ (Prompt): ${lastTokenUsage.promptTokenCount} í† í°\n` +
                             `â€¢ ë°›ì€ ì–‘ (Output): ${lastTokenUsage.candidatesTokenCount} í† í°\n` +
                             `â€¢ í•©ê³„ (Total): ${lastTokenUsage.totalTokenCount} í† í°\n` +
                             `--------------------------------------------------\n\n`;
            } else {
                infoHeader = `[ğŸ“Š í† í° ì •ë³´ ì—†ìŒ]\nAPIì—ì„œ ì‚¬ìš©ëŸ‰ ì •ë³´ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n`;
            }

            textarea.value = infoHeader + lastSentPrompt;
            document.getElementById('modal-textarea-input').scrollTop = 0;
            
            // ëª¨ë‹¬ ì œëª© ë³€ê²½
            const titleEl = document.querySelector('#textarea-editor-modal h3');
            titleEl.innerText = "ë””ë²„ê·¸: í† í° ë° ë°ì´í„° í™•ì¸";
            
            openModalInternal('textarea-editor-modal');
            
            // ë‹«ì„ ë•Œ ì œëª© ë³µêµ¬
            const closeBtn = document.querySelector('#textarea-editor-modal button[onclick*="saveAndClose"]');
            const oldOnClick = closeBtn.onclick;
            closeBtn.onclick = function() {
                titleEl.innerText = "ì „ì²´ í™”ë©´ í¸ì§‘";
                oldOnClick();
            };
        }

// [ì¶”ê°€] ì‚¬ì´ë“œë°”ì—ì„œ ë¶ë§ˆí¬ ì‚­ì œ (í™”ë©´ ì´ë™ ì—†ìŒ)
        function deleteBookmarkFromSidebar(index) {
            const chat = DB.chats.find(c => c.id === currentSessionId);
            if(chat) {
                // 1. ë°ì´í„°ì—ì„œ í•´ì œ
                chat.history[index].bookmarked = false;
                saveData();
                
                // 2. ì‚¬ì´ë“œë°” ëª©ë¡ ì¦‰ì‹œ ê°±ì‹ 
                renderRightSidebar(); 
                
                // 3. (ì¤‘ìš”) í˜„ì¬ ì±„íŒ…ì°½ì— í•´ë‹¹ ë©”ì‹œì§€ê°€ ë³´ì¸ë‹¤ë©´, ì•„ì´ì½˜ì„ ì¦‰ì‹œ ì§€ì›Œì„œ ì‹œê°ì  ë™ê¸°í™”
                // (loadSessionì„ í˜¸ì¶œí•˜ë©´ ìŠ¤í¬ë¡¤ì´ íŠ€ê¸° ë•Œë¬¸ì—, DOMë§Œ ì‚´ì§ ê±´ë“œë¦¬ëŠ” ë°©ì‹ ì‚¬ìš©)
                const msgEl = document.querySelector(`.msg-wrapper[data-index="${index}"]`);
                if(msgEl) {
                     // ìƒë‹¨ ë…¸ë€ìƒ‰ ë¶ë§ˆí¬ ë±ƒì§€ ì œê±°
                     const indicator = msgEl.querySelector('.fa-bookmark.text-yellow-500')?.closest('div.absolute');
                     if(indicator) indicator.remove();
                     
                     // íˆ´ë°”ì˜ ë¶ë§ˆí¬ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™” (ì±„ì›Œì§„ ì•„ì´ì½˜ -> ë¹ˆ ì•„ì´ì½˜)
                     const btnIcon = msgEl.querySelector('.msg-tools button[onclick*="toggleBookmark"] i');
                     const btn = msgEl.querySelector('.msg-tools button[onclick*="toggleBookmark"]');
                     if(btnIcon && btn) {
                         btnIcon.className = 'fa-regular fa-bookmark text-xs';
                         btn.className = btn.className.replace('text-yellow-500', '').replace('hover:text-yellow-600', '') + ' text-gray-400 hover:text-yellow-600';
                     }
                }
            }
        }

        // [ì¶”ê°€] ë‹¤í¬ ëª¨ë“œ í† ê¸€ ë° ì €ì¥ í•¨ìˆ˜
        function toggleDarkMode() {
            const isDark = document.getElementById('dark-mode-toggle').checked;
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('novel_ai_dark_mode', 'true');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('novel_ai_dark_mode', 'false');
            }
        }

/* â–¼â–¼â–¼ [ìˆ˜ì •ë¨] 3ë‹¨ê³„: ì¥ê¸° ê¸°ì–µ + ìµœê·¼ ëŒ€í™” í†µí•© ìš”ì•½ í•¨ìˆ˜ â–¼â–¼â–¼ */
async function generateAutoSummary() {
    if(!currentSessionId) return alert("ëŒ€í™” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
    if(!SETTINGS.apiKey) return alert("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
    
    if(!confirm("í˜„ì¬ê¹Œì§€ì˜ ëŒ€í™” ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ 'ì¥ê¸° ê¸°ì–µ'ì„ ê°±ì‹ í•©ë‹ˆë‹¤.\n(ê¸°ì¡´ ê¸°ì–µê³¼ ìµœê·¼ ëŒ€í™”ë¥¼ ë³‘í•©í•©ë‹ˆë‹¤.)")) return;

    const textarea = document.getElementById('memory-input');
    const loadingOverlay = document.getElementById('modal-loading-overlay-memory');
    const chat = DB.chats.find(c => c.id === currentSessionId);
    
    const existingMemory = chat.memory || "ì—†ìŒ";
    const recentHistory = chat.history.slice(-20).map(m => `[${m.role}]: ${m.text}`).join('\n'); // ìµœê·¼ 20í„´ ì°¸ì¡°

    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');

    const prompt = `
    You are a Memory Manager for a novel.
    
    Task: Update the 'Long-term Memory' by merging the [Existing Memory] with the [Recent Conversation].
    
    [Existing Memory]
    ${existingMemory}
    
    [Recent Conversation]
    ${recentHistory}
    
    [Instructions]
    1. Summarize major events, revealed secrets, and relationship changes.
    2. Remove obsolete info (e.g., solved problems).
    3. Keep it concise but detailed enough for context.
    4. Language: KOREAN (í•œêµ­ì–´).
    
    Output the updated memory text only.`;

    try {
        const modelToUse = SETTINGS.currentModel || 'gemini-3-pro';
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${SETTINGS.apiKey}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                safetySettings: [
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
            })
        });

        const data = await response.json();
        if (data.candidates && data.candidates[0].content) {
            textarea.value = data.candidates[0].content.parts[0].text;
            showMessage("ì¥ê¸° ê¸°ì–µì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            throw new Error("AI ì‘ë‹µ ì—†ìŒ");
        }
    } catch (e) {
        alert("ìš”ì•½ ì‹¤íŒ¨: " + e.message);
    } finally {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
    }
}

/* --- [ì¶”ê°€] ìŠ¤ë§ˆíŠ¸ ë¡œì–´ë¶ ê°ì§€ ì—”ì§„ --- */
function detectActiveLore(allEntries, contextText) {
    const activeEntries = [];
    const triggeredTitles = [];
    
    // ê²€ìƒ‰ ëŒ€ìƒ í…ìŠ¤íŠ¸ ì •ê·œí™” (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë“±)
    const textToCheck = contextText.toLowerCase();

    (allEntries || []).forEach(entry => {
        // 1. ë‚´ìš©ì´ë‚˜ ì œëª©ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        if (!entry.content && !entry.title) return;

        // 2. í‚¤ì›Œë“œê°€ ë¹„ì–´ìˆìœ¼ë©´? -> 'í•­ì‹œ ì ìš©(Passive)'ìœ¼ë¡œ ê°„ì£¼
        if (!entry.keywords || entry.keywords.trim() === '') {
            activeEntries.push(entry);
            return;
        }

        // 3. í‚¤ì›Œë“œ ë§¤ì¹­ ê²€ì‚¬ (ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ í‚¤ì›Œë“œ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ë°œë™)
        const keys = entry.keywords.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
        const isMatch = keys.some(key => textToCheck.includes(key));

        if (isMatch) {
            activeEntries.push(entry);
            triggeredTitles.push(entry.title); // ë°œë™ëœ ì„¤ì • ì œëª© ì €ì¥
        }
    });

    return { entries: activeEntries, triggers: triggeredTitles };
}

/* --- [ì‹ ê·œ ê¸°ëŠ¥] ë§¤í¬ë¡œ(ë‹¨ì¶• ë¬¸êµ¬) ì‹œìŠ¤í…œ --- */

// 1. íŒì—… í† ê¸€ ë° ë Œë”ë§
function toggleMacroPopup() {
    const popup = document.getElementById('macro-popup');
    if (popup.classList.contains('hidden')) {
        renderMacroChips();
        popup.classList.remove('hidden');
        popup.classList.add('flex');
    } else {
        popup.classList.add('hidden');
        popup.classList.remove('flex');
    }
}

// [ìˆ˜ì •] ì¹© ë Œë”ë§ (type="button" ì¶”ê°€í•˜ì—¬ ìë™ ì „ì†¡ ë°©ì§€)
function renderMacroChips() {
    const popup = document.getElementById('macro-popup');
    popup.innerHTML = '';
    
    if (!SETTINGS.macros || SETTINGS.macros.length === 0) {
        popup.innerHTML = '<span class="text-xs text-gray-400 p-2">ì„¤ì •ì—ì„œ ë‹¨ì¶• ë¬¸êµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</span>';
        return;
    }

    SETTINGS.macros.forEach(macro => {
        const btn = document.createElement('button');
        btn.type = 'button'; // [ì¤‘ìš”] ì´ ì¤„ì´ ì—†ìœ¼ë©´ ëˆ„ë¥´ìë§ˆì ì „ì†¡ë©ë‹ˆë‹¤!
        btn.className = "flex-shrink-0 bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-indigo-200 transition border border-indigo-200";
        btn.innerText = macro.label;
        
        // í´ë¦­ ì´ë²¤íŠ¸
        btn.onclick = (e) => {
            e.preventDefault(); // í˜¹ì‹œ ëª¨ë¥¼ ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨
            insertAtCursor(document.getElementById('msg-input'), macro.content);
            
            // ëª¨ë°”ì¼ì—ì„œëŠ” í´ë¦­ í›„ íŒì—… ë‹«ê¸° (ë¶ˆí¸í•˜ë©´ ì´ ì¤„ ì‚­ì œ)
            if(window.innerWidth < 768) toggleMacroPopup();
        };
        popup.appendChild(btn);
    });
    
    // ì„¤ì • ë°”ë¡œê°€ê¸° ë²„íŠ¼
    const setBtn = document.createElement('button');
    setBtn.type = 'button'; // [ì¤‘ìš”] ì„¤ì • ë²„íŠ¼ë„ ì „ì†¡ ë°©ì§€
    setBtn.className = "flex-shrink-0 bg-gray-100 text-gray-500 px-3 py-1.5 rounded-full text-xs hover:bg-gray-200 transition border border-gray-200";
    setBtn.innerHTML = '<i class="fa-solid fa-cog"></i>';
    setBtn.onclick = (e) => { 
        e.preventDefault();
        toggleMacroPopup(); 
        openCoreModal(); 
        switchCoreTab('macro'); 
    };
    popup.appendChild(setBtn);
}

/* --- [ìµœì¢… ìˆ˜ì •] í…ìŠ¤íŠ¸ ì‚½ì… í•¨ìˆ˜ (ë‹¨ìˆœ ë¶™ì—¬ë„£ê¸° ëª¨ë“œ) --- */
function insertAtCursor(textarea, text) {
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const originalValue = textarea.value;
    
    // 1. í…ìŠ¤íŠ¸ ì‚½ì… (ê¸°ì¡´ ë‚´ìš© ì‚¬ì´ì— ë¼ì›Œë„£ê¸°)
    textarea.value = originalValue.substring(0, start) + text + originalValue.substring(end);
    
    // 2. í¬ì»¤ìŠ¤ ë§ì¶”ê¸°
    textarea.focus();
    
    // 3. ì»¤ì„œë¥¼ ë¬´ì¡°ê±´ 'ì‚½ì…ëœ í…ìŠ¤íŠ¸ì˜ ë§¨ ë'ìœ¼ë¡œ ì´ë™
    const newPos = start + text.length;
    textarea.selectionStart = textarea.selectionEnd = newPos;
}


/* --- ì„¤ì • í™”ë©´(Core Modal) ê´€ë ¨ ë¡œì§ ì¶”ê°€ --- */

// [ìˆ˜ì •ë¨] ë§¤í¬ë¡œ ì„¤ì • ëª©ë¡ ë Œë”ë§ (ìˆœì„œ ë³€ê²½ ë²„íŠ¼ ì¶”ê°€)
function renderMacroSettings() {
    const list = document.getElementById('macro-list');
    if (!list) return;
    list.innerHTML = '';
    
    if (!SETTINGS.macros) SETTINGS.macros = [];

    SETTINGS.macros.forEach((macro, index) => {
        const div = document.createElement('div');
        div.className = "flex gap-2 items-center bg-white p-2 border rounded shadow-sm";
        
        // ì²« ë²ˆì§¸ í•­ëª©ì€ ìœ„ë¡œ ëª» ê°€ê³ , ë§ˆì§€ë§‰ í•­ëª©ì€ ì•„ë˜ë¡œ ëª» ê°€ë„ë¡ ìˆ¨ê¹€ ì²˜ë¦¬
        const upClass = index === 0 ? 'opacity-0 pointer-events-none' : 'hover:text-indigo-600';
        const downClass = index === SETTINGS.macros.length - 1 ? 'opacity-0 pointer-events-none' : 'hover:text-indigo-600';

        div.innerHTML = `
            <div class="flex flex-col items-center justify-center mr-1 gap-0.5">
                <button onclick="moveMacro(${index}, -1)" class="text-gray-400 ${upClass} leading-none" title="ìœ„ë¡œ"><i class="fa-solid fa-caret-up"></i></button>
                <button onclick="moveMacro(${index}, 1)" class="text-gray-400 ${downClass} leading-none" title="ì•„ë˜ë¡œ"><i class="fa-solid fa-caret-down"></i></button>
            </div>
            <input type="text" class="w-1/3 p-2 border rounded text-sm bg-gray-50" placeholder="ë²„íŠ¼ ì´ë¦„" value="${macro.label}" onchange="updateMacro(${index}, 'label', this.value)">
            <input type="text" class="flex-1 p-2 border rounded text-sm" placeholder="ì…ë ¥ë  ë‚´ìš©" value="${macro.content}" onchange="updateMacro(${index}, 'content', this.value)">
            <button onclick="deleteMacro(${index})" class="text-gray-400 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
        `;
        list.appendChild(div);
    });
}

// [ì‹ ê·œ] ë§¤í¬ë¡œ ìˆœì„œ ì´ë™ í•¨ìˆ˜
function moveMacro(index, direction) {
    const targetIndex = index + direction;
    
    // ë°°ì—´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸ (ìœ íš¨ì„± ê²€ì‚¬)
    if (targetIndex >= 0 && targetIndex < SETTINGS.macros.length) {
        // ë°°ì—´ ë‚´ ìš”ì†Œ ìˆœì„œ ë§ë°”ê¾¸ê¸° (Swap)
        const temp = SETTINGS.macros[index];
        SETTINGS.macros[index] = SETTINGS.macros[targetIndex];
        SETTINGS.macros[targetIndex] = temp;
        
        // ë³€ê²½ëœ ìˆœì„œë¡œ ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        renderMacroSettings();
    }
}


function addMacroUI() {
    SETTINGS.macros.push({ label: 'ìƒˆ ë²„íŠ¼', content: '' });
    renderMacroSettings();
}

function updateMacro(index, key, value) {
    SETTINGS.macros[index][key] = value;
}

function deleteMacro(index) {
    if(confirm('ì´ ë‹¨ì¶• ë¬¸êµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        SETTINGS.macros.splice(index, 1);
        renderMacroSettings();
    }
}

// [ì‹ ê·œ] API í‚¤ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€ í•¨ìˆ˜
function toggleApiKeyVisibility() {
    const input = document.getElementById('core-api-key');
    const icon = document.getElementById('api-key-icon');
    
    if (input.type === 'password') {
        input.type = 'text'; // ë³´ì´ê²Œ ì „í™˜
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password'; // ìˆ¨ê¸°ê²Œ ì „í™˜
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

        init();
    </script>
</body>
</html>